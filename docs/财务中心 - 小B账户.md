# 财务中心 - 小B账户 PRD

> 关联文档：[`系统架构图`](./系统架构图.md)、[`前端UI重构方案 - 商户账户`](./前端UI重构方案%20-%20商户账户.md)

## 1. 功能概述

小B账户管理用于监管所有小B客户的账户信息、业务统计和订单明细。平台不直接结算给小B，小B的佣金由挂载目标大B（AIGO大B或其他有推广联盟权限的大B）结算。此功能用于管理员监管小B的业务情况，了解挂载大B对小B的结算情况。

**入口路径**：财务中心 → 商户账户 → 小B账户

## 2. 小B列表

### 2.1 功能说明

查看所有小B账户信息，支持搜索、筛选和分页。列表展示小B的汇总数据，点击"查看详情"可查看订单明细和佣金结算记录。

**设计说明**：
- 原架构中"小B列表"和"余额明细"功能已合并
- 列表页展示汇总数据
- 详情页的"订单明细"Tab展示订单级别明细（原"余额明细"功能）

### 2.2 列表显示字段

**基础字段**：
- 小B名称（固定左侧显示）
- 用户信息类型（以徽章形式显示：旅行代理/网络博主/旅游类相关应用）
- 认证方式（个人认证/企业认证）
- 挂载大B（挂载目标大B名称，支持悬停查看大BID）
- 账户状态（以徽章形式显示：正常/冻结/关闭）

**关键业务数据**（订单汇总）：
- 累计订单总金额P2（所有订单的P2总和）
  - 计算公式：SUM(所有订单的订单总金额P2)
- 累计订单总佣金（所有订单的佣金总和，需扣除退款对应的佣金部分）
  - 计算公式：SUM(订单总佣金 × (1 - 订单总退款金额 / 订单总金额P2))
- 已结算佣金金额（由挂载大B已结算的佣金总和）
  - 计算公式：SUM(由挂载大B已结算给该小B的佣金金额)
- 待结算佣金金额（由挂载大B待结算的佣金总和）
  - 计算公式：累计订单总佣金 - 已结算佣金金额

**操作**：
- 查看详情

### 2.3 搜索和筛选

**搜索**：
- 支持按小B名称、挂载大B名称、邮箱、手机号搜索

**筛选条件**：
- 用户信息类型：旅行代理/网络博主/旅游类相关应用/全部
- 认证方式：个人认证/企业认证/全部
- 挂载大B：下拉选择筛选（显示所有有推广联盟权限的大B）
- 账户状态：正常/冻结/关闭/全部

**分页显示**：
- 每页10条数据

### 2.4 数据导出

- 支持导出筛选后的小B列表数据（Excel格式）
- 导出字段：小B名称、用户信息类型、认证方式、挂载大B、账户状态、累计订单总金额P2、累计订单总佣金、已结算佣金、待结算佣金

## 3. 小B详情

### 3.1 基本信息

**显示字段**：
- 小B名称
- 用户信息类型（徽章显示）
- 认证方式（徽章显示）
- 挂载大B（显示挂载的大B名称，可点击跳转到大B详情，附大B推广ID）
- 账户状态（徽章显示）
- 联系方式（邮箱、手机号，可复制）
- 最近登录时间（用于判断活跃度，如无数据显示“-”）

### 3.2 业务统计

**统计指标**（订单汇总）：

- **累计订单总金额P2**
  - 计算公式：SUM(所有订单的P2)
  - 说明：该小B所有订单的订单总金额P2总和

- **累计订单总退款金额**
  - 计算公式：SUM(所有订单的退款金额)
  - 说明：该小B所有订单的退款金额总和

- **累计订单总利润**
  - 计算公式：SUM(所有订单的利润)
  - 说明：该小B所有订单的利润总和

- **累计订单总佣金**
  - 计算公式：SUM(订单总佣金 × (1 - 订单总退款金额 / 订单总金额P2))
  - 说明：所有订单的佣金总和，需扣除退款对应的佣金部分
  - 其中：退款对应的佣金部分 = 订单总退款金额 × 订单总佣金 / 订单总金额P2

- **已结算佣金金额**
  - 计算公式：SUM(由挂载大B已结算的佣金)
  - 说明：挂载大B已结算给该小B的佣金总和

- **待结算佣金金额**
  - 计算公式：累计订单总佣金 - 已结算佣金金额
  - 说明：挂载大B待结算给该小B的佣金总和

### 3.3 详情Tab页

#### 3.3.1 Tab1: 订单明细（原"余额明细"）

**显示字段**：
- 订单号
- 订单总金额P2
- 订单总利润
- 佣金比例（百分比显示，如：5%）
- 订单总佣金（已扣除退款对应的佣金部分）
- 结算状态（待结算/处理中/已结算）
- 结算时间
- 结算方（挂载大B名称，展示“结算方：XX大B”灰色标注）

**佣金计算说明**：
- 订单总佣金 = 原始佣金 × (1 - 订单总退款金额 / 订单总金额P2)
- 如有退款，显示扣除后的佣金金额
- 若订单仍在退款处理中，需同时展示“退款处理中”提示，以区分已扣减与待扣减金额

**搜索和筛选**：
- 搜索：支持按订单号搜索
- 筛选条件：
  - 结算状态：待结算/处理中/已结算/全部
  - 日期范围：开始日期、结束日期
- 分页显示：每页10条数据

**数据导出**：
- 支持导出筛选后的订单明细数据（Excel格式）
- 导出需追加“结算方”与“退款扣减后佣金”字段，确保与大B账单核对

#### 3.3.2 Tab2: 佣金结算记录

**显示字段**：
- 结算类型（周期结算/按单结算，以徽章形式显示）
- 结算批次号（周期结算时显示批次号，按单结算时显示订单号）
- 结算金额
- 结算时间
- 结算状态（待结算/处理中/已结算）
- 结算方（挂载大B名称，与大B结算记录保持一致）
- 操作：查看详情

**查看结算详情**：
- 弹窗显示该结算批次或按单结算的订单明细
- 显示字段：订单号、订单总金额P2、订单总佣金、结算金额
- 对于周期结算，显示批次内所有订单；对于按单结算，显示单个订单

**搜索和筛选**：
- 搜索：支持按结算批次号/订单号搜索
- 筛选条件：
  - 结算状态：待结算/处理中/已结算/全部
  - 结算类型：周期结算/按单结算/全部
  - 日期范围：开始日期、结束日期
- 分页显示：每页10条数据
- 批次详情弹窗支持导出选中批次的订单列表，便于与大B结算记录对账

## 4. 交互与异常处理

1. **挂载大B不可用提示**：当挂载大B被关闭/冻结时，列表在挂载大B列展示橙色警告图标，悬停提示“挂载大B当前不可用，请联系运营处理”。
2. **数据延迟说明**：若小B订单数据晚于结算记录同步（>5分钟），在页面顶部展示灰色提示“订单数据实时同步中，请稍后刷新确认”。
3. **无结算权限提示**：当小B未挂载任何大B或挂载大B无推广联盟权限时，详情页的结算相关卡片显示不可用状态，并提示“需由具备推广联盟权限的大B结算”。
4. **导出超限**：导出超过10,000条时弹出提示，让用户缩小时间范围或增加筛选条件。

## 5. 数据一致性与审核

1. **跨模块对齐**：小B的订单与佣金数据需与订单交易、推广联盟模块保持一致，若出现差异需提供核对入口。
2. **人工复核流程**：对于异常金额（如佣金为负、结算金额大于订单金额），系统自动标记并在操作栏提供“提交复核”按钮，记录复核原因。
3. **审计追踪**：所有对小B数据的查询、导出、复核操作都记录在审计日志中（操作人/操作时间/操作内容），以备安全审计使用。

## 4. 业务规则

### 4.1 结算规则

1. **平台不直接结算给小B**：小B的佣金由挂载目标大B（AIGO大B或其他有推广联盟权限的大B）结算
2. **监管视角**：此功能用于管理员监管小B的业务情况，了解挂载大B对小B的结算情况
3. **结算方显示**：所有结算相关字段都显示"结算方（挂载大B名称）"，明确由大B结算

### 4.2 数据计算规则

1. **退款对应的佣金部分**：订单总退款金额 × 订单总佣金 / 订单总金额P2
2. **订单总佣金（扣除退款）**：订单总佣金 × (1 - 订单总退款金额 / 订单总金额P2)

### 4.3 挂载关系

1. **挂载大B要求**：只能挂载有推广联盟管理权限（`can_manage_affiliate = 1`）的大B
2. **挂载关系显示**：在基本信息中显示挂载的大B名称，可点击跳转到大B详情页

## 7. UI组件规范

### 7.1 徽章颜色规范

**用户信息类型**：
- 旅行代理：蓝色 `bg-blue-50 text-blue-700 border-blue-300`
- 网络博主：紫色 `bg-purple-50 text-purple-700 border-purple-300`
- 旅游类相关应用：绿色 `bg-green-50 text-green-700 border-green-300`

**认证方式**：
- 个人认证：灰色 `bg-gray-50 text-gray-700 border-gray-300`
- 企业认证：蓝色 `bg-blue-50 text-blue-700 border-blue-300`

**账户状态**：
- 正常：绿色 `bg-green-50 text-green-700 border-green-300`
- 冻结：黄色 `bg-yellow-50 text-yellow-700 border-yellow-300`
- 关闭：红色 `bg-red-50 text-red-700 border-red-300`

**结算类型**：
- 周期结算：蓝色 `bg-blue-50 text-blue-700 border-blue-300`
- 按单结算：绿色 `bg-green-50 text-green-700 border-green-300`

### 7.2 金额显示规范

- 使用千分位分隔符：`¥5,000`
- 负数显示为红色
- 零值显示为 `-`

### 7.3 百分比显示规范

- 佣金比例显示为百分比：`5%`
- 保留2位小数：`5.25%`

### 7.4 空状态设计

- 无数据时显示占位符："暂无小B账户数据"
- 搜索无结果时显示："未找到符合条件的小B账户"

### 7.5 结算方显示

- 在所有结算相关字段旁显示"结算方：[挂载大B名称]"
- 使用灰色小字体显示，强调由大B结算

## 8. 验证规则

### 8.1 搜索验证

- 搜索关键词最少2个字符
- 支持模糊匹配

### 8.2 筛选验证

- 日期范围：开始日期不能晚于结束日期
- 至少选择一个筛选条件

### 8.3 导出验证

- 导出数据不超过10000条
- 超过限制时提示用户缩小筛选范围

## 9. 特殊说明

### 9.1 与大B账户的关联

- 小B的挂载大B可点击跳转到大B详情页
- 在大B详情页的"管理的小B情况"Tab中可查看该大B管理的所有小B

### 9.2 监管视角说明

- 此功能仅供平台管理员监管使用
- 不涉及平台直接结算给小B的操作
- 所有结算操作由挂载大B完成，平台仅提供数据查看和监管

### 9.3 数据一致性

- 小B的订单数据需与订单管理模块保持一致
- 小B的佣金结算记录需与大B的结算记录保持一致
- 定期进行数据校验，确保统计数据准确性
