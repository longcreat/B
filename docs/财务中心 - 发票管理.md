# 财务中心 - 发票管理 PRD

## 1. 功能概述

发票管理是财务中心的核心模块，用于管理C端用户、大B客户、小B客户的发票申请、开具、发送、退票等全流程，确保税务合规和用户体验。

## 2. 功能模块

### 2.1 发票记录管理（电子发票）

**页面位置：** 财务中心 → 发票管理 → 电子发票

**功能概述：**
管理员查看和管理所有发票记录，包括开票申请、开票状态、邮箱发送状态、退票等全流程管理。

**页面标签（Tab）：**
- **全部**：显示所有发票记录
- **开票失败**：显示开票失败的发票记录
- **邮箱发送失败**：显示邮箱发送失败的发票记录

**列表显示字段：**
- 发票ID、发票申请方（用户名称）、用户类型（C端用户/大B客户/小B客户）
- 开票申请时间、开票成功时间、邮箱发送时间
- 用户联系方式（电话/邮箱）
- 发票内容（住宿费）、发票代码、发票号码
- 开票主体、接收人邮箱、发票抬头、开票金额
- 发票状态（待开票/开票中/开票成功邮箱未发送/开票成功邮箱已发送/开票成功邮箱发送失败/邮箱重发中/开票重试中/开票失败/申请退票/退票中/退票成功/退票重试中/退票失败）
- 异常原因（如有）
- 操作（查看详情/退票/重发邮件/置为退票成功）

**筛选条件：**
- 发票状态：待开票/开票中/开票成功邮箱未发送/开票成功邮箱已发送/开票成功邮箱发送失败/邮箱重发中/开票重试中/开票失败/申请退票/退票中/退票成功/退票重试中/退票失败/全部
- 用户类型：C端用户/大B客户/小B客户/全部
- 开票主体：下拉选择筛选
- 发票申请方：文本输入筛选
- 发票ID：文本输入筛选
- 开票申请时间范围：开始日期、结束日期
- 开票成功时间范围：开始日期、结束日期
- 开票金额范围：最小金额、最大金额

**搜索功能：**
- 支持按发票ID、发票申请方、发票代码、发票号码、接收人邮箱等关键词搜索

**统计信息：**
- 发票总金额、发票总笔数
- 开票成功金额、开票成功笔数
- 开票失败金额、开票失败笔数
- 待开票金额、待开票笔数
- 今日开票金额、今日开票笔数
- 本月累计开票金额、本月累计开票笔数

**详情页面：**
- **用户信息**：
  - 发票申请方（用户名称）、用户类型（C端用户/大B客户/小B客户）、用户联系方式（电话/邮箱）
- **发票信息**：
  - 发票类型：电子发票
  - 发票抬头：个人姓名/公司名称
  - 发票税号：纳税人识别号（个人用户为"--"）
  - 发票内容：住宿费
  - 发票金额
  - 注册地址（企业用户）
  - 注册电话（企业用户）
  - 开户银行（企业用户）
  - 银行账号（企业用户）
  - 备注说明（如有）
- **收件邮箱**：
  - 接收人邮箱、邮箱发送时间、邮箱发送状态
- **发票轨迹**：
  - 时间节点-状态（显示发票从申请到当前状态的所有操作历史）
  - 包括：申请时间、开票时间、邮箱发送时间、退票时间等
- **订单信息**：
  - 关联订单数量、订单总金额
  - 订单列表：订单号、订单金额、订单状态、订单时间

**操作功能：**
- **查看详情**：查看完整的发票信息（所有状态可用）
- **退票**（申请退票）：
  - 可用状态：开票成功邮箱未发送/开票成功邮箱已发送/开票成功邮箱发送失败
  - 权限：财务及以上
  - 操作：人工触发，系统创建退票任务，状态更新为"申请退票"，进入退票流程
- **重发邮件**：
  - 可用状态：开票成功邮箱未发送/开票成功邮箱已发送/开票成功邮箱发送失败/退票成功
  - 权限：客服/运营及以上
  - 操作：再次向用户发送发票（或退票成功）的通知邮件，状态更新为"邮箱重发中"
- **置为退票成功**：
  - 可用状态：退票中/退票重试中/退票失败
  - 权限：高级财务/超级管理员
  - 操作：高风险操作，手动强制将发票状态更新为"退票成功"，用于修正系统与事实不一致的状态

**发票状态说明：**
- **待开票**：用户已提交开票申请，等待系统处理
- **开票中**：系统正在处理开票请求
- **开票成功邮箱未发送**：开票成功，但邮件尚未发送
- **开票成功邮箱已发送**：开票成功，邮件已成功发送（最终成功状态）
- **开票成功邮箱发送失败**：开票成功，但邮件发送失败
- **邮箱重发中**：系统正在重新发送邮件
- **开票重试中**：系统正在重试开票请求
- **开票失败**：开票失败，需人工处理
- **申请退票**：已申请退票，等待系统处理
- **退票中**：系统正在处理退票请求
- **退票成功**：退票成功（最终退票成功状态）
- **退票重试中**：系统正在重试退票请求
- **退票失败**：退票失败，需人工处理

**状态转换规则：**
- **待开票 → 开票中**：系统自动处理开票申请
- **开票中 → 开票成功邮箱未发送/开票失败/开票重试中**：系统处理结果
- **开票成功邮箱未发送 → 开票成功邮箱已发送/开票成功邮箱发送失败**：邮件发送结果
- **开票成功邮箱发送失败 → 邮箱重发中**：人工触发重发邮件
- **邮箱重发中 → 开票成功邮箱已发送/开票成功邮箱发送失败**：邮件重发结果
- **开票重试中 → 开票成功邮箱未发送/开票失败**：开票重试结果
- **开票失败 → 待开票**：经人工处理后重新开票
- **开票成功邮箱未发送/开票成功邮箱已发送/开票成功邮箱发送失败 → 申请退票**：人工触发退票
- **申请退票 → 退票中**：系统自动处理退票申请
- **退票中 → 退票成功/退票失败/退票重试中**：退票处理结果
- **退票重试中 → 退票成功/退票失败**：退票重试结果
- **退票失败 → 退票成功**：人工触发置为退票成功（高风险操作）

**状态/操作权限矩阵：**

| 发票状态 | 查看详情 | 置为退票成功 | 退票 | 重发邮件 |
| :--- | :--- | :--- | :--- | :--- |
| 待开票 | ✅ 可用 | ❌ 禁用 | ❌ 禁用 | ❌ 禁用 |
| 开票中 | ✅ 可用 | ❌ 禁用 | ❌ 禁用 | ❌ 禁用 |
| 开票成功邮箱未发送 | ✅ 可用 | ❌ 禁用 | ✅ 可用 | ✅ 可用 |
| 开票成功邮箱已发送 | ✅ 可用 | ✅ 可用 | ✅ 可用 | ✅ 可用 |
| 开票成功邮箱发送失败 | ✅ 可用 | ❌ 禁用 | ✅ 可用 | ✅ 可用 |
| 邮箱重发中 | ✅ 可用 | ❌ 禁用 | ❌ 禁用 | ❌ 禁用 |
| 开票重试中 | ✅ 可用 | ❌ 禁用 | ❌ 禁用 | ❌ 禁用 |
| 开票失败 | ✅ 可用 | ❌ 禁用 | ❌ 禁用 | ❌ 禁用 |
| 申请退票 | ✅ 可用 | ❌ 禁用 | ❌ 禁用 | ❌ 禁用 |
| 退票中 | ✅ 可用 | ✅ 可用 | ❌ 禁用 | ❌ 禁用 |
| 退票成功 | ✅ 可用 | ❌ 禁用 | ❌ 禁用 | ✅ 可用 |
| 退票重试中 | ✅ 可用 | ✅ 可用 | ❌ 禁用 | ❌ 禁用 |
| 退票失败 | ✅ 可用 | ✅ 可用 | ❌ 禁用 | ❌ 禁用 |

## 3. 业务规则

### 3.1 发票申请规则
- C端用户、大B客户、小B客户均可申请发票
- 发票类型：电子发票
- 发票内容：住宿费
- 发票金额：基于订单实际支付金额（扣除退款后）
- 个人用户：发票税号为"--"
- 企业用户：需提供完整的发票信息（发票抬头、税号、注册地址、注册电话、开户银行、银行账号）

### 3.2 开票规则
- 开票申请提交后，系统自动校验申请信息（如税号格式）
- 开票成功后，系统自动保存发票文件（PDF链接）
- 开票成功后，系统自动发送邮件通知用户
- 开票失败后，系统记录失败原因，需人工处理
- 开票重试：系统自动重试（可配置重试次数），重试失败后需人工处理

### 3.3 邮件发送规则
- 开票成功后，系统自动发送邮件通知用户
- 邮件发送失败后，系统记录失败原因，需人工处理
- 支持人工触发重发邮件
- 重发邮件后，状态更新为"邮箱重发中"，发送成功后更新为"开票成功邮箱已发送"

### 3.4 退票规则
- **触发退票的场景**：
  1. **订单全额退款**：C端用户预订并支付了订单，且已经申请并成功开具了发票。之后，用户在免费取消期内取消了订单，平台需要全额退款。财务合规要求：既然原始交易已经不存在，那么对应的发票也必须作废，以确保平台的收入流水和税务申报的准确性。
  2. **订单部分退款**：C端用户离店后发起客诉，经过协商，平台同意退还部分房费。用户之前已按原价开具了发票。财务合规要求：需要对原始发票进行调整，以反映最终的实际交易金额。通常的操作是：先将原始发票进行红冲（开具一张金额为负数的红字发票），再根据最终的实际消费金额，重新开具一张新的蓝字发票。
  3. **发票信息错误**：C端用户申请开票时，填错了公司抬头或税号。发票已经成功开出并发送。用户发现后，联系客服要求修改。财务合规要求：已经开具的发票无法直接"修改"。正确的流程是先作废（红冲）这张错误的发票，然后让用户提供正确的信息，再重新开具一张新发票。
- **退票流程**：
  - 人工触发退票（财务人员/客服人员）
  - 系统创建退票任务，状态更新为"申请退票"
  - 系统自动处理退票请求，调用发票服务商的"红冲/作废"功能
  - 退票成功后，状态更新为"退票成功"
  - 退票失败后，状态更新为"退票失败"，需人工处理
  - 退票重试：系统自动重试（可配置重试次数），重试失败后需人工处理

### 3.5 权限规则
- **查看详情**：基础查看权限，所有状态可用
- **退票**：财务及以上权限，仅部分状态可用
- **重发邮件**：客服/运营及以上权限，仅部分状态可用
- **置为退票成功**：高级财务/超级管理员权限，高风险操作，仅部分状态可用

## 4. 数据字段设计

### 4.1 发票记录
- 发票ID（唯一标识）
- 发票申请方（用户名称）、用户类型（C端用户/大B客户/小B客户）、用户联系方式（电话/邮箱）
- 开票申请时间、开票成功时间、邮箱发送时间
- 发票内容（住宿费）、发票代码、发票号码
- 开票主体、接收人邮箱、发票抬头、开票金额
- 发票类型（电子发票）
- 发票税号（个人用户为"--"）
- 注册地址、注册电话、开户银行、银行账号（企业用户）
- 备注说明（如有）
- 发票状态（13种状态）
- 异常原因（如有）
- 发票文件路径（PDF链接）
- 关联订单列表（订单号、订单金额、订单状态）

### 4.2 发票轨迹
- 操作时间、操作类型（申请/开票/发送邮件/重发邮件/退票等）、操作状态、操作人、操作备注

## 5. 交互流程

### 5.1 发票申请流程
1. 用户（C端/大B/小B）登录后台，进入发票管理页面
2. 选择需要开票的订单
3. 填写发票信息（发票抬头、税号、注册地址等）
4. 填写接收人邮箱
5. 提交开票申请，状态为"待开票"
6. 系统自动校验申请信息（如税号格式）
7. 系统自动处理开票请求，状态更新为"开票中"

### 5.2 开票流程
1. 系统自动处理开票请求，状态更新为"开票中"
2. 开票成功后，系统自动保存发票文件（PDF链接），状态更新为"开票成功邮箱未发送"
3. 系统自动发送邮件通知用户，状态更新为"开票成功邮箱已发送"
4. 如果邮件发送失败，状态更新为"开票成功邮箱发送失败"，需人工处理
5. 如果开票失败，状态更新为"开票失败"，需人工处理
6. 如果开票超时或可重试错误，状态更新为"开票重试中"，系统自动重试

### 5.3 重发邮件流程
1. 邮件发送失败后，财务人员或客服人员查看发票详情
2. 点击"重发邮件"按钮，状态更新为"邮箱重发中"
3. 系统自动重新发送邮件
4. 邮件发送成功后，状态更新为"开票成功邮箱已发送"
5. 邮件发送失败后，状态更新为"开票成功邮箱发送失败"，需人工处理

### 5.4 退票流程
1. 触发退票场景（订单全额退款/订单部分退款/发票信息错误）
2. 财务人员或客服人员查看发票详情
3. 点击"退票"按钮，状态更新为"申请退票"
4. 系统自动处理退票请求，调用发票服务商的"红冲/作废"功能，状态更新为"退票中"
5. 退票成功后，状态更新为"退票成功"
6. 退票失败后，状态更新为"退票失败"，需人工处理
7. 如果退票超时或可重试错误，状态更新为"退票重试中"，系统自动重试
8. 退票失败后，高级财务或超级管理员可以手动触发"置为退票成功"（高风险操作）

## 6. 权限和通知

### 6.1 权限控制
- **查看发票列表**：财务人员、财务主管、客服人员、运营人员
- **查看发票详情**：财务人员、财务主管、客服人员、运营人员
- **退票**：财务人员、财务主管
- **重发邮件**：客服人员、运营人员、财务人员、财务主管
- **置为退票成功**：高级财务、超级管理员
- **导出记录**：财务人员、财务主管

### 6.2 通知机制
- **开票成功通知**：
  - 触发条件：开票成功，邮件发送成功
  - 通知方式：邮件
  - 通知对象：申请人
  - 通知内容：发票信息、发票文件下载链接
- **开票失败通知**：
  - 触发条件：开票失败
  - 通知方式：站内消息
  - 通知对象：财务人员
  - 通知内容：发票信息、失败原因、查看链接
- **邮件发送失败通知**：
  - 触发条件：邮件发送失败
  - 通知方式：站内消息
  - 通知对象：客服人员、财务人员
  - 通知内容：发票信息、失败原因、查看链接
- **退票成功通知**：
  - 触发条件：退票成功
  - 通知方式：邮件 + 站内消息
  - 通知对象：申请人、财务人员
  - 通知内容：退票信息、查看链接

## 7. 需要确认的问题

为了完善发票功能设计，需要您提供以下信息：

1. **发票服务商**：
   - 使用哪家发票服务商？（如：百望云、航信等）
   - 发票服务商是否提供API接口？
   - 发票服务商的发票类型支持情况？

2. **开票规则**：
   - 开票时效要求是什么？（申请后多长时间内完成开票）
   - 开票重试次数是多少？（可配置）
   - 开票重试间隔是多少？（可配置）

3. **邮件发送规则**：
   - 邮件发送服务使用哪家？（如：阿里云邮件、腾讯云邮件等）
   - 邮件发送失败后，重试次数是多少？（可配置）
   - 邮件发送失败后，重试间隔是多少？（可配置）

4. **退票规则**：
   - 退票时效要求是什么？（申请后多长时间内完成退票）
   - 退票重试次数是多少？（可配置）
   - 退票重试间隔是多少？（可配置）
   - 退票是否有期限限制？（如：发票开具后多长时间内可以退票）

5. **权限和角色**：
   - 谁可以申请退票？（财务人员/财务主管/客服人员）
   - 谁可以重发邮件？（客服人员/运营人员/财务人员）
   - 谁可以置为退票成功？（高级财务/超级管理员）

6. **通知和提醒**：
   - 开票成功是否需要发送通知？（邮件/站内消息）
   - 开票失败是否需要发送通知？（邮件/站内消息）
   - 邮件发送失败是否需要发送通知？（邮件/站内消息）
   - 退票成功是否需要发送通知？（邮件/站内消息）
