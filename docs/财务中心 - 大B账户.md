# 财务中心 - 大B账户 PRD

> 关联文档：[`系统架构图`](./系统架构图.md)、[`前端UI重构方案 - 商户账户`](./前端UI重构方案%20-%20商户账户.md)

## 1. 功能概述

大B账户管理用于监管所有大B客户的账户信息、业务统计和订单明细，支持批量操作和风险控制。平台直接结算给大B，大B负责管理其附属小B客户的佣金结算。

**入口路径**：财务中心 → 商户账户 → 大B账户

## 2. 大B列表

### 2.1 功能说明

查看所有大B账户信息，支持搜索、筛选和分页。列表展示大B的汇总数据，点击"查看详情"可查看订单明细和结算记录。

### 2.2 列表显示字段

**基础字段**：
- 大B名称（固定左侧显示，点击可进入详情页）
- 用户信息类型（以徽章形式显示：旅行代理/网络博主/旅游类相关应用）
- 认证方式（个人认证/企业认证）
- 业务模式（SaaS/MCP/平台自营，以徽章形式显示）
- 是否拥有推广联盟权限（有权限显示绿色对勾，无权限显示灰色叉号）
- 账户状态（以徽章形式显示：正常/冻结/关闭）

**业务数据**：
- 累计销售金额（订单总金额P2的总和，展示名称：累计销售额）
  - 计算公式：SUM(该大B所有订单的订单总金额P2)
- 已结算金额（已结算给大B的总金额）
  - 计算公式：SUM(已结算给该大B的结算金额)
- 待结金额（可结算但未结算的金额）
  - 计算公式：SUM(可结算但未结算的订单结算金额)
- 账户余额（大B账户当前余额，可提现+冻结）
  - 计算公式：可提现金额 + 冻结金额
- 可提现金额（大B可提现的金额）
  - 计算公式：账户余额中未冻结的部分
- 冻结金额（大B冻结的金额）
  - 计算公式：账户余额中冻结的部分
- 累计订单数量（该大B的总订单数，展示名称：累计订单数）
  - 计算公式：COUNT(该大B的所有订单)
- 累计客户数量（该大B服务的独立客户数，展示名称：累计客户数）
  - 计算公式：COUNT(DISTINCT 该大B订单中的客户ID)
- 退款率（累计退款金额/累计销售金额 × 100%，展示名称：退款率）
  - 计算公式：(SUM(该大B所有订单的退款金额) / SUM(该大B所有订单的订单总金额P2)) × 100%
- 月均销售额（最近30天销售额，展示名称：月销售额）
  - 计算公式：SUM(最近30天该大B订单的订单总金额P2) / 30
- 注册时长（从注册日期到今天的天数，展示名称：注册天数）
  - 计算公式：DATEDIFF(DAY, 注册日期, CURRENT_DATE)

**状态信息**：
- 最后登录时间（显示最近一次登录时间）

**操作**：
- 快捷操作按钮（固定右侧显示）：进入详情、冻结账户/解冻账户

### 2.3 搜索和筛选

**搜索**：
- 支持按大B名称、邮箱、手机号、大B用户ID搜索

**筛选条件**：
- 用户信息类型：旅行代理/网络博主/旅游类相关应用/全部
- 认证方式：个人认证/企业认证/全部
- 业务模式：SaaS/MCP/平台自营/全部
- 账户状态：正常/冻结/关闭/全部
- 是否拥有推广联盟权限：是/否/全部
- 累计销售金额范围：最小金额-最大金额
- 账户余额范围：最小金额-最大金额
- 累计订单数量范围：最小数量-最大数量
- 退款率范围：最小退款率-最大退款率（如：0%-5%）
- 月销售额范围：最小金额-最大金额
- 注册时间范围：开始日期-结束日期

**筛选面板**：点击筛选按钮展开/收起，筛选条件以表单形式展示，支持重置和确定操作

**分页显示**：
- 每页10条数据

### 2.4 统计信息（列表顶部展示）

- 总大B数量：当前筛选条件下的大B总数
- 活跃大B数量：账户状态为正常的数量
- 冻结大B数量：账户状态为冻结的数量
- 总累计销售额：所有大B的累计销售金额总和
- 总账户余额：所有大B的账户余额总和
- 平均退款率：所有大B的平均退款率
- 高退款率大B数量：退款率>5%的大B数量
- 新注册大B数量：注册时间<30天的大B数量

### 2.5 数据导出

- 支持导出筛选后的大B列表数据（Excel格式）
- 导出字段：大B名称、用户信息类型、认证方式、业务模式、推广联盟权限、账户状态、累计销售额、已结算金额、待结金额、账户余额、可提现金额、冻结金额、累计订单数、累计客户数、退款率、月销售额、注册天数、最后登录时间

## 3. 大B详情

### 3.1 页面布局

- 顶部：面包屑导航（财务中心 > 大B账户 > [大B名称]）
- 左侧：大B基本信息和业务概览
- 右侧：操作区（账户管理、风险控制等操作）
- 中下部：Tab页（订单明细、余额明细、结算记录、小B监管等）

### 3.2 基本信息卡

- 大B头像/Logo（默认显示）
- 大B名称、用户信息类型、认证方式、业务模式
- 联系方式（邮箱、手机号）、注册时间、最后登录时间
- 账户状态、风控等级、推广联盟权限状态
- 操作：编辑信息（弹窗形式）

### 3.3 业务概览卡片（4列网格布局）

- 累计销售额（订单总金额P2的总和）
  - 计算公式：SUM(该大B所有订单的订单总金额P2)
- 已结算金额（已结算给大B的总金额）
  - 计算公式：SUM(已结算给该大B的结算金额)
- 待结金额（可结算但未结算的金额）
  - 计算公式：SUM(可结算但未结算的订单结算金额)
- 账户余额（当前账户余额）
  - 计算公式：大B账户当前可提现金额 + 冻结金额

### 3.4 结算概览卡片（4列网格布局，根据结算模式动态显示）

**周期结算模式**：
- 本期应付（当前周期应结算给大B的金额）
  - 计算公式：SUM(当前结算周期内可结算的订单结算金额)
- 已结算（本周期已结算的金额）
  - 计算公式：SUM(当前结算周期内已结算的订单结算金额)
- 待结算（本周期待结算的金额）
  - 计算公式：本期应付 - 已结算
- 在途提现（申请提现但未完成的金额）
  - 计算公式：SUM(申请提现但尚未完成的提现金额)

**按单结算模式**：
- 本期应付（当前可结算的订单总金额）
  - 计算公式：SUM(当前可结算的订单结算金额)
- 已结算（今日已结算的订单总金额）
  - 计算公式：SUM(今日已结算的订单结算金额)
- 待结算（累计待结算的订单总金额）
  - 计算公式：SUM(所有待结算的订单结算金额)
- 在途提现（申请提现但未完成的金额）
  - 计算公式：SUM(申请提现但尚未完成的提现金额)

### 3.5 详情Tab页

#### 3.5.1 Tab1: 订单明细

**显示字段**：
- 订单号
- 订单类型（直接订单/小B推广订单）
- 订单金额P2
- 退款金额
- 结算金额
- 订单状态
- 结算状态
- 订单时间

**搜索和筛选**：
- 搜索：支持按订单号搜索
- 筛选条件：
  - 订单状态：全部/已完成/可结算/售后中等
  - 结算状态：待结算/可结算/处理中/已结算/已取消/全部
  - 订单时间范围：开始日期-结束日期

**按单结算模式特有功能**：
- 对于状态为"可结算"的订单，显示"立即结算"按钮
- 支持批量选择可结算订单进行批量结算
- 结算确认时显示订单明细和结算金额
- 结算成功后自动更新订单结算状态和账户余额

**分页显示**：每页10条数据

**数据导出**：支持导出筛选后的订单明细数据（Excel格式）

#### 3.5.2 Tab2: 余额明细

**显示字段**：
- 变动时间
- 变动类型（收入/支出/冻结/解冻）
- 变动金额
- 变动前余额
- 变动后余额
- 关联订单号
- 操作人
- 备注

**搜索和筛选**：
- 筛选条件：
  - 变动时间范围：开始日期-结束日期
  - 变动类型：收入/支出/冻结/解冻/全部

**余额统计**：显示当前余额、可提现余额、冻结余额

**分页显示**：每页10条数据

#### 3.5.3 Tab3: 结算批次列表（仅周期结算模式显示）

**显示字段**：
- 结算批次号
- 结算金额
- 结算时间
- 结算状态
- 操作人
- 包含订单数量

**操作**：
- 可展开查看批次详情（包含的订单列表）
- 支持对"待复核"状态的批次进行复核/驳回操作

**结算统计**：显示累计结算金额、最近一次结算时间等

#### 3.5.4 Tab4: 结算记录（仅按单结算模式显示）

**显示字段**：
- 订单号
- 结算金额
- 结算时间
- 结算状态
- 操作人

**搜索和筛选**：
- 搜索：支持按订单号搜索
- 筛选条件：
  - 结算状态：待结算/处理中/已结算/全部
  - 结算时间范围：开始日期-结束日期

**结算统计**：显示累计结算金额、最近一次结算时间等

#### 3.5.5 Tab5: 小B监管（仅 `can_manage_affiliate = 1` 的大B显示）

**小B列表**：
- 展示该大B管理的所有小B客户
- 列表字段：小B名称、用户信息类型、认证方式、挂载时间、账户状态、当前佣金比例、累计佣金金额、已结算佣金、待结算佣金
- 支持按小B名称、账户状态筛选
- 异常提示：高退款率（>10%）或逾期结算的小B用橙色标签标出

**佣金概览卡片**（3列布局）：
- 累计佣金总额（该大B所有小B的佣金总和）
  - 计算公式：SUM(该大B管理的所有小B的累计订单总佣金)
- 已结算佣金总额（已结算给小B的佣金总和）
  - 计算公式：SUM(该大B已结算给所有小B的佣金金额)
- 待结算佣金总额（待结算给小B的佣金总和）
  - 计算公式：累计佣金总额 - 已结算佣金总额

**批量操作**：
- 批量调整佣金比例：选择多个小B，设置新的佣金比例，填写调整原因
- 批量停用小B：选择多个小B，停用账户，填写停用原因
- 批量启用小B：选择多个已停用的小B，启用账户，填写启用原因
- 批量设置店铺配置权限：控制小B是否可以使用店铺配置功能

**操作日志**：
- 记录所有对小B的操作历史
- 字段：操作时间、操作类型、操作对象（小B名称）、操作内容、操作人、操作原因

### 3.6 右侧操作区

**账户管理**：
- 调整风控等级（选择新等级，填写原因）
- 冻结/解冻账户（填写操作原因）
- 关闭账户（高风险操作，需二次确认）

**财务操作**：
- 补录结算（手动增加结算记录）
- 提现申请审批（快捷入口）
- 异常备注（记录账户异常情况）

**业务操作**：
- 重置密码（发送密码重置邮件）
- 发送通知（发送站内消息或邮件）
- 联系大B（显示联系方式，方便电话/邮件联系）

## 4. 业务规则

### 4.1 结算规则

1. **平台直接结算给大B**：大B的结算金额由平台直接计入账户
2. **小B佣金由大B结算**：大B负责管理其附属小B的佣金结算
3. **结算模式选择**：大B可选择周期结算或按单结算模式
4. **结算冻结期**：订单完成后有一定冻结期，防止争议

### 4.2 数据计算规则

1. **退款对应的佣金部分**：订单总退款金额 × 订单总佣金 / 订单总金额P2
2. **退款对应的P1部分**：订单总退款金额 × 订单总分销价P1 / 订单总金额P2
3. **退款对应的P0部分**：订单总退款金额 × 订单总底价P0 / 订单总金额P2

### 4.3 推广联盟权限

1. **权限控制**：只有拥有推广联盟权限的大B才能管理小B
2. **权限审核**：权限变更需运营审核通过
3. **权限影响**：权限变更影响小B的挂载关系和佣金结算

### 4.4 账户状态管理

1. **状态流转**：正常 ↔ 冻结 ↔ 关闭（不可逆）
2. **状态影响**：冻结状态下停止结算，关闭状态下停止所有业务
3. **状态变更记录**：所有状态变更记录操作日志

## 5. 交互与异常处理

1. **推广联盟权限变更提示**：当大B推广联盟权限被调整时，系统自动发送通知给相关运营人员。
2. **结算模式切换提醒**：大B结算模式变更时，需重新配置相关参数，并通知财务团队。
3. **高风险账户提醒**：退款率>10%或账户余额异常的大B，在列表中用橙色边框标出。
4. **批量操作确认**：所有批量操作前需二次确认，并显示操作影响范围。
5. **导出限制**：单次导出不超过10,000条记录，超过时提示缩小筛选范围。

## 6. 数据一致性与审核

1. **跨模块对齐**：大B的订单与结算数据需与订单交易、结算管理模块保持一致，若出现差异需提供核对入口。
2. **人工复核流程**：对于异常金额（如结算金额为负、余额异常），系统自动标记并在操作栏提供"提交复核"按钮，记录复核原因。
3. **审计追踪**：所有对大B数据的查询、导出、操作都记录在审计日志中（操作人/操作时间/操作内容），以备安全审计使用。

## 7. UI组件规范

### 7.1 徽章颜色规范

**用户信息类型**：
- 旅行代理：蓝色 `bg-blue-50 text-blue-700 border-blue-300`
- 网络博主：紫色 `bg-purple-50 text-purple-700 border-purple-300`
- 旅游类相关应用：绿色 `bg-green-50 text-green-700 border-green-300`

**认证方式**：
- 个人认证：灰色 `bg-gray-50 text-gray-700 border-gray-300`
- 企业认证：蓝色 `bg-blue-50 text-blue-700 border-blue-300`

**业务模式**：
- SaaS：橙色 `bg-orange-50 text-orange-700 border-orange-300`
- MCP：紫色 `bg-purple-50 text-purple-700 border-purple-300`
- 平台自营：红色 `bg-red-50 text-red-700 border-red-300`

**账户状态**：
- 正常：绿色 `bg-green-50 text-green-700 border-green-300`
- 冻结：黄色 `bg-yellow-50 text-yellow-700 border-yellow-300`
- 关闭：红色 `bg-red-50 text-red-700 border-red-300`

**结算状态**：
- 待结算：黄色 `bg-yellow-50 text-yellow-700 border-yellow-300`
- 处理中：蓝色 `bg-blue-50 text-blue-700 border-blue-300`
- 已结算：绿色 `bg-green-50 text-green-700 border-green-300`

### 7.2 金额显示规范

- 使用千分位分隔符：`¥150,000`
- 负数显示为红色
- 零值显示为 `-`

### 7.3 空状态设计

- 无数据时显示占位符："暂无大B账户数据"
- 搜索无结果时显示："未找到符合条件的大B账户"

### 7.5 权限显示

- 推广联盟权限：有权限显示绿色对勾 ✓，无权限显示灰色叉号 ✗

## 8. 验证规则

### 8.1 搜索验证

- 搜索关键词最少2个字符
- 支持模糊匹配

### 8.2 筛选验证

- 日期范围：开始日期不能晚于结束日期
- 至少选择一个筛选条件

### 8.3 导出验证

- 导出数据不超过10,000条
- 超过限制时提示用户缩小筛选范围

## 9. 特殊说明

### 9.1 与小B账户的关联

- 大B详情页的小B监管Tab显示管理的小B列表
- 小B详情页显示挂载的大B信息，可点击跳转
- 大B的结算金额包含小B佣金，由大B负责结算给小B

### 9.2 结算模式说明

- 周期结算：按周/月生成结算批次，批量结算
- 按单结算：订单满足条件后立即结算，无需批次
- 结算模式可在账户管理中切换，但需财务审核

### 9.3 监管视角说明

- 此功能仅供平台管理员监管使用
- 涉及平台直接结算给大B的操作
- 大B负责管理小B的佣金结算，平台仅提供监管功能

### 9.4 数据一致性

- 大B的订单数据需与订单管理模块保持一致
- 大B的结算记录需与结算管理模块保持一致
- 大B的小B管理数据需与小B账户模块保持一致
- 定期进行数据校验，确保统计数据准确性
