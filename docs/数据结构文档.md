# 系统数据结构文档

## 目录

### 一、业务模块字段清单
- [1.1 订单管理模块](#11-订单管理模块)
  - [订单列表所需字段](#订单列表所需字段)
  - [订单详情所需字段](#订单详情所需字段)
- [1.2 结算管理模块](#12-结算管理模块)
  - [小B结算批次列表所需字段](#小b结算批次列表所需字段)
  - [供应商结算批次列表所需字段](#供应商结算批次列表所需字段)
- [1.3 发票管理模块](#13-发票管理模块)
- [1.4 提现管理模块](#14-提现管理模块)
- [1.5 用户管理模块](#15-用户管理模块)
- [1.6 资格审核模块](#16-资格审核模块)
- [1.7 API密钥管理模块](#17-api密钥管理模块)

### 二、关联对象定义
- [2.1 酒店（Hotel）](#21-酒店hotel)
- [2.2 房型（RoomType）](#22-房型roomtype)
- [2.3 小B合作伙伴（Partner）](#23-小b合作伙伴partner)
- [2.4 客户（Customer）](#24-客户customer)
- [2.5 供应商（Supplier）](#25-供应商supplier)

### 三、核心实体字段定义
- [3.1 系统用户（User）](#31-系统用户user)
- [3.2 申请认证（Application）](#32-申请认证application)
- [3.3 订单（Order）](#33-订单order)
- [3.4 发票（Invoice）](#34-发票invoice)
- [3.5 结算批次](#35-结算批次)
  - [3.5.1 小B结算批次（PartnerSettlementBatch）](#351-小b结算批次partnersettlementbatch)
  - [3.5.2 供应商结算批次（SupplierSettlementBatch）](#352-供应商结算批次suppliersettlementbatch)
- [3.6 提现（Withdrawal）](#36-提现withdrawal)
- [3.7 API密钥（ApiKey）](#37-api密钥apikey)
- [3.8 交易记录（Transaction）](#38-交易记录transaction)
- [3.9 对账记录（Reconciliation）](#39-对账记录reconciliation)
  - [3.9.1 供应商成本对账（SupplierCostReconciliation）](#391-供应商成本对账suppliercostreconciliation)
  - [3.9.2 支付渠道对账（PaymentChannelReconciliation）](#392-支付渠道对账paymentchannelreconciliation)
  - [3.9.3 提现对账（WithdrawalReconciliation）](#393-提现对账withdrawalreconciliation)
  - [3.9.4 开票对账（InvoiceReconciliation）](#394-开票对账invoicereconciliation)
- [3.10 价格规则（PricingRule）](#310-价格规则pricingrule)
- [3.11 违约扣费记录（ViolationFeeRecord）](#311-违约扣费记录violationfeerecord)
- [3.12 订单交易记录（OrderTransaction）](#312-订单交易记录ordertransaction)

### 四、表单数据结构
- [4.1 个人认证表单（IndividualFormData）](#41-个人认证表单individualformdata)
- [4.2 博主认证表单（InfluencerFormData）](#42-博主认证表单influencerformdata)
- [4.3 企业认证表单（EnterpriseFormData）](#43-企业认证表单enterpriseformdata)

### 五、实体关联关系
- [5.1 核心关联链](#51-核心关联链)
- [5.2 关联字段映射](#52-关联字段映射)

### 六、字段对齐对照表
- [6.1 身份标识字段对齐](#61-身份标识字段对齐)
- [6.2 结算账户字段对齐](#62-结算账户字段对齐)
- [6.3 联系方式字段对齐](#63-联系方式字段对齐)

### 七、数据流转规则
- [7.1 申请到合作伙伴转换](#71-申请到合作伙伴转换)
- [7.2 订单关联规则](#72-订单关联规则)
- [7.3 结算批次生成规则](#73-结算批次生成规则)
- [7.4 文件字段处理规则](#74-文件字段处理规则)

### 八、对象关联关系总览
- [8.1 对象关联表](#81-对象关联表)
- [8.2 冗余字段说明](#82-冗余字段说明)

---

## 一、业务模块字段清单

### 1.1 订单管理模块

#### 订单列表所需字段
订单列表需要显示以下完整信息：
- **订单编号**（orderId）- 来自Order对象
- **酒店名称**（hotelName）- 来自Order对象
- **入住日期**（checkInDate）- 来自Order对象
- **离店日期**（checkOutDate）- 来自Order对象
- **入住天数**（nights）- 来自Order对象
- **小B客户名称**（partnerName）- 来自Order对象（关联Partner对象）
- **小B客户类型**（partnerType）- 来自Order对象
- **订单状态**（orderStatus）- 来自Order对象
- **结算状态**（settlementStatus）- 来自Order对象
- **实付金额**（actualAmount）- 来自Order对象（从nightDetails计算得出）
- **退款金额**（refundAmount）- 来自Order对象（从refundDetails计算得出，可选）
- **是否有退款**（hasRefund）- 来自Order对象（计算字段：refundAmount > 0）
- **小B利润/佣金**（partnerProfit）- 来自Order对象（从nightDetails计算得出，SaaS模式为小B利润，MCP/推广联盟模式为佣金，已扣除退款晚数）
- **平台利润**（platformProfit）- 来自Order对象（从nightDetails计算得出，已扣除退款晚数）
- **业务模式**（partnerBusinessModel）- 来自Order对象（mcp / saas / affiliate）
- **加价率**（partnerMarkupRate）- 来自Order对象（SaaS小B显示，使用Order.partnerMarkupRate，非SaaS业务模式显示为空）
- **佣金率**（partnerCommissionRate）- 来自Order对象（MCP/推广联盟显示，使用Order.partnerCommissionRate，SaaS业务模式显示为空）
- **下单时间**（orderCreatedAt）- 来自Order对象
- **结算时间**（orderSettledAt）- 来自Order对象

**字段来源实体**：Order

#### 订单详情所需字段
订单详情需要显示订单列表的所有字段，还需要：
- **酒店地址**（hotelAddress）- 来自Order对象
- **房型**（roomTypeName）- 来自Order对象
- **入住天数**（nights）- 来自Order对象
- **小B客户邮箱**（partnerEmail）- 来自Order对象
- **客户姓名**（customerName）- 来自Order对象
- **客户手机号**（customerPhone）- 来自Order对象
- **供应商供货价P0**（p0_supplierCost）- 来自Order对象（供应商给平台的价格，平台成本）
- **平台供货价P1**（p1_platformPrice）- 来自Order对象（平台加价后给SaaS小B的价格；MCP/推广联盟模式无独立的P1，可为空或与P2相同用于内部核算）
- **销售价P2**（p2_salePrice）- 来自Order对象（SaaS小B加价后卖给用户的价格，或MCP/推广联盟直接卖给用户的价格）
- **平台加价率**（platformMarkupRate）- 来自Order对象（SaaS模式为从P0到P1的加价率；MCP/推广联盟模式为平台从P0直接加价到P2的加价率）
- **小B加价率**（partnerMarkupRate）- 来自Order对象（从P1到P2的加价率，仅SaaS小B有效，订单列表的“加价率”列即显示该字段）
- **小B佣金率**（partnerCommissionRate）- 来自Order对象（从P0到P2的总利润中，给MCP/推广联盟的分成比例，仅MCP/推广联盟有效，订单列表的“佣金率”列即显示该字段）
- **退款金额**（refundAmount）- 来自Order对象（从refundDetails计算得出）
- **订单按天明细**（nightDetails）- 来自Order对象（每晚的价格、状态、退款信息、比例信息）
- **退款明细**（refundDetails）- 来自Order对象（每次退款的详细信息，包括退了哪些晚）
- **五重门控状态**（gates）- 来自Order对象
- **状态历史**（statusHistory）- 来自Order对象

**字段来源实体**：Order

---

### 1.2 结算管理模块

#### 小B结算批次列表所需字段
- **批次号**（batchId）- 来自PartnerSettlementBatch对象
- **小B客户名称**（partnerName）- 来自PartnerSettlementBatch对象
- **小B客户类型**（partnerType）- 来自PartnerSettlementBatch对象
- **结算周期开始**（settlementPeriodStart）- 来自PartnerSettlementBatch对象
- **结算周期结束**（settlementPeriodEnd）- 来自PartnerSettlementBatch对象
- **订单数量**（orderCount）- 来自PartnerSettlementBatch对象
- **结算金额**（settlementAmount）- 来自PartnerSettlementBatch对象
- **批次状态**（batchStatus）- 来自PartnerSettlementBatch对象
- **生成时间**（batchCreatedAt）- 来自PartnerSettlementBatch对象
- **审核时间**（batchApprovedAt）- 来自PartnerSettlementBatch对象

**字段来源实体**：PartnerSettlementBatch

#### 供应商结算批次列表所需字段
- **批次号**（batchId）- 来自SupplierSettlementBatch对象
- **供应商名称**（supplierName）- 来自SupplierSettlementBatch对象
- **结算周期开始**（settlementPeriodStart）- 来自SupplierSettlementBatch对象
- **结算周期结束**（settlementPeriodEnd）- 来自SupplierSettlementBatch对象
- **订单数量**（orderCount）- 来自SupplierSettlementBatch对象
- **结算金额**（settlementAmount）- 来自SupplierSettlementBatch对象
- **批次状态**（batchStatus）- 来自SupplierSettlementBatch对象
- **打款时间**（batchPaidAt）- 来自SupplierSettlementBatch对象
- **打款状态**（paymentStatus）- 来自SupplierSettlementBatch对象

**字段来源实体**：SupplierSettlementBatch

---

### 1.3 发票管理模块

#### 发票列表所需字段
- **发票编号**（invoiceId）- 来自Invoice对象
- **申请方用户名称**（applicantUserName）- 来自Invoice对象
- **申请方联系方式**（applicantUserContact）- 来自Invoice对象
- **开票申请时间**（invoiceApplyTime）- 来自Invoice对象
- **开票成功时间**（invoiceSuccessTime）- 来自Invoice对象
- **发票状态**（invoiceStatus）- 来自Invoice对象
- **开票金额**（invoiceAmount）- 来自Invoice对象（订单金额扣除退款后的金额）
- **退款金额**（invoiceRefundAmount）- 来自Invoice对象（可选）
- **发票代码**（invoiceCode）- 来自Invoice对象
- **发票号码**（invoiceNumber）- 来自Invoice对象

**字段来源实体**：Invoice

---

### 1.4 提现管理模块

#### 提现列表所需字段
- **提现ID**（withdrawalId）- 来自Withdrawal对象
- **用户名称**（userName）- 来自Withdrawal对象
- **提现申请时间**（withdrawalApplyTime）- 来自Withdrawal对象
- **转账汇款时间**（withdrawalTransferTime）- 来自Withdrawal对象
- **提现状态**（withdrawalStatus）- 来自Withdrawal对象
- **业务模式**（businessModel）- 来自Withdrawal对象
- **提现金额**（withdrawalAmount）- 来自Withdrawal对象
- **提现账户**（account）- 来自Withdrawal对象
- **提现用户名**（accountName）- 来自Withdrawal对象

**字段来源实体**：Withdrawal

---

### 1.5 用户管理模块

#### 小B用户列表所需字段
- **用户ID**（partnerId）- 来自Partner对象
- **显示名称**（partnerDisplayName）- 来自Partner对象（个人姓名、博主昵称、企业名称）
- **用户邮箱**（partnerEmail）- 来自Partner对象（冗余字段，来自User.email，用于显示、联系和发邮件）
- **用户类型**（partnerType）- 来自Partner对象（individual / influencer / enterprise）
- **风控等级**（partnerPermissionLevel）- 来自Partner对象（L0 / L1 / L2 / L3 / L4）
- **认证状态**（partnerCertificationStatus）- 来自Partner对象（pending / approved / rejected）
- **账户状态**（partnerAccountStatus）- 来自Partner对象（active / suspended / closed）
- **结算状态**（partnerSettlementStatus）- 来自Partner对象（normal / frozen / restricted）
- **联系方式**（partnerPhone）- 来自Partner对象
- **财务数据**：
  - **总交易额**（partnerTotalRevenue）- 来自Partner对象（P2总金额）
  - **累计利润**（partnerTotalProfit）- 来自Partner对象
  - **可用余额**（partnerAvailableBalance）- 来自Partner对象
  - **待结算**（partnerPendingSettlement）- 来自Partner对象
  - **已提取**（partnerWithdrawnAmount）- 来自Partner对象
- **业务数据**：
  - **订单总数**（partnerTotalOrders）- 来自Partner对象
  - **已完成订单**（partnerCompletedOrders）- 来自Partner对象
  - **平均加价率**（partnerAvgMarkupRate）- 来自Partner对象（百分比）
  - **活跃客户数**（partnerActiveCustomers）- 来自Partner对象
- **注册时间**（partnerRegisteredAt）- 来自Partner对象
- **最后登录时间**（partnerLastLoginAt）- 来自Partner对象
- **认证通过时间**（partnerCertifiedAt）- 来自Partner对象（可选）

**字段来源实体**：Partner

#### 小B用户详情所需字段
用户详情需要显示用户列表的所有字段，还需要：

##### 基础信息
- **用户ID**（partnerId）- 来自Partner对象
- **用户邮箱**（partnerEmail）- 来自Partner对象（冗余字段，来自User.email，用于显示、联系和发邮件）
- **手机号**（partnerPhone）- 来自Partner对象
- **显示名称**（partnerDisplayName）- 来自Partner对象
- **用户类型**（partnerType）- 来自Partner对象（individual / influencer / enterprise）
- **注册时间**（partnerRegisteredAt）- 来自Partner对象
- **最后登录时间**（partnerLastLoginAt）- 来自Partner对象

##### 认证信息
- **认证状态**（partnerCertificationStatus）- 来自Partner对象（pending / approved / rejected）
- **认证通过时间**（partnerCertifiedAt）- 来自Partner对象（可选）
- **关联申请ID**（partnerApplicationId）- 来自Partner对象（外键，关联Application.applicationId）

##### 账户状态
- **账户状态**（partnerAccountStatus）- 来自Partner对象（active / suspended / closed）
- **结算状态**（partnerSettlementStatus）- 来自Partner对象（normal / frozen / restricted）

##### 权限等级
- **风控等级**（partnerPermissionLevel）- 来自Partner对象（L0 / L1 / L2 / L3 / L4）

##### 财务数据
- **总交易额**（partnerTotalRevenue）- 来自Partner对象（P2总金额）
- **累计利润**（partnerTotalProfit）- 来自Partner对象
- **可用余额**（partnerAvailableBalance）- 来自Partner对象
- **待结算**（partnerPendingSettlement）- 来自Partner对象
- **已提取**（partnerWithdrawnAmount）- 来自Partner对象

##### 业务数据
- **订单总数**（partnerTotalOrders）- 来自Partner对象
- **已完成订单**（partnerCompletedOrders）- 来自Partner对象
- **平均加价率**（partnerAvgMarkupRate）- 来自Partner对象（百分比）
- **活跃客户数**（partnerActiveCustomers）- 来自Partner对象

##### 类型特有信息
根据用户类型显示不同的特有信息：

**个人/博主类型特有信息**（partnerSpecificInfo）：
- **真实姓名**（partnerRealName）- 来自Partner.partnerSpecificInfo
- **身份证号**（partnerIdNumber）- 来自Partner.partnerSpecificInfo
- **平台名称**（partnerPlatformName）- 来自Partner.partnerSpecificInfo（仅博主）
- **粉丝数**（partnerFollowersCount）- 来自Partner.partnerSpecificInfo（仅博主）
- **影响力评分**（partnerInfluenceScore）- 来自Partner.partnerSpecificInfo（仅博主）

**企业类型特有信息**（partnerSpecificInfo）：
- **企业名称**（partnerCompanyName）- 来自Partner.partnerSpecificInfo
- **统一社会信用代码**（partnerSocialCreditCode）- 来自Partner.partnerSpecificInfo
- **法人代表**（partnerLegalRepresentative）- 来自Partner.partnerSpecificInfo
- **注册资本**（partnerRegisteredCapital）- 来自Partner.partnerSpecificInfo

##### 店铺信息
- **店铺名称**（partnerStoreName）- 来自Partner对象
- **自定义域名**（partnerCustomDomain）- 来自Partner对象（可选）
- **店铺状态**（partnerStoreStatus）- 来自Partner对象（active / inactive）

**字段来源实体**：Partner、Application（通过partnerApplicationId关联）

---

### 1.6 资格审核模块

#### 申请列表所需字段
- **申请编号**（applicationId）- 来自Application对象
- **申请人姓名**（applicantName）- 来自Application对象
- **身份类型**（identityType）- 来自Application对象（developer / influencer / enterprise / agent）
- **业务模式**（businessModel）- 来自Application对象（mcp / saas / affiliate）
- **审核状态**（applicationStatus）- 来自Application对象（pending / approved / rejected）
- **提交时间**（applicationSubmittedAt）- 来自Application对象
- **审核时间**（applicationReviewedAt）- 来自Application对象
- **用户邮箱**（userEmail）- 来自Application对象（冗余字段，来自User.email，用于显示、联系和发邮件）

**字段来源实体**：Application

#### 申请详情所需字段
申请详情需要显示申请列表的所有字段，还需要：
- **用户ID**（userId）- 来自Application对象（外键，关联User.userId）
- **权限等级**（permissionLevel）- 来自Application对象（L0 / L1 / L2 / L3 / L4）
- **驳回原因**（applicationRejectionReason）- 来自Application对象
- **内部备注**（applicationInternalNote）- 来自Application对象
- **完整表单数据**（data）- 来自Application对象（见下方"四、表单数据结构"）

**字段来源实体**：Application

---

### 1.7 API密钥管理模块

#### API密钥列表所需字段
- **密钥ID**（apiKeyId）- 来自ApiKey对象
- **密钥名称**（keyName）- 来自ApiKey对象
- **用户名称**（userName）- 来自ApiKey对象
- **用户类型**（userType）- 来自ApiKey对象
- **密钥状态**（apiKeyStatus）- 来自ApiKey对象
- **风险等级**（riskLevel）- 来自ApiKey对象
- **总调用次数**（totalCalls）- 来自ApiKey对象
- **今日调用次数**（callsToday）- 来自ApiKey对象
- **最后使用时间**（lastUsed）- 来自ApiKey对象

**字段来源实体**：ApiKey

---

## 二、关联对象定义

### 2.1 酒店（Hotel）

**说明**：酒店基础信息对象，订单通过hotelId关联。

#### 基础属性
- **hotelId** - 酒店ID（主键）
- **hotelName** - 酒店名称
- **hotelAddress** - 酒店地址
- **hotelCity** - 所在城市
- **hotelBrand** - 酒店品牌
- **hotelStarRating** - 星级（1-5星）
- **hotelPhone** - 酒店联系电话
- **hotelStatus** - 酒店状态：active / inactive / suspended
- **hotelAddedAt** - 酒店入驻时间，格式：YYYY-MM-DD HH:mm:ss
- **hotelLastModifiedAt** - 酒店最后修改时间，格式：YYYY-MM-DD HH:mm:ss

---

### 2.2 房型（RoomType）

**说明**：酒店房型信息对象，订单通过roomTypeId关联。

#### 基础属性
- **roomTypeId** - 房型ID（主键）
- **roomTypeName** - 房型名称（如：豪华大床房、标准双床房）
- **roomTypeCode** - 房型代码
- **roomTypeDescription** - 房型描述
- **roomTypeCapacity** - 容纳人数
- **roomTypeArea** - 房间面积（平方米）
- **roomTypeStatus** - 房型状态：active / inactive
- **roomTypeAddedAt** - 房型添加时间，格式：YYYY-MM-DD HH:mm:ss
- **roomTypeLastModifiedAt** - 房型最后修改时间，格式：YYYY-MM-DD HH:mm:ss

---

### 2.3 小B合作伙伴（Partner）

**说明**：小B合作伙伴对象，订单通过partnerId关联，由Application审核通过后创建。

#### 基础属性
- **partnerId** - 小B客户ID（主键）
- **userId** - 用户ID（外键，关联User.userId）
- **partnerEmail** - 小B客户邮箱（冗余字段，来自User.email，用于显示、快速查询、联系和发邮件）
- **partnerPhone** - 小B客户手机号
- **partnerDisplayName** - 显示名称（个人姓名、博主昵称、企业名称）
- **partnerType** - 小B类型：individual / influencer / enterprise
- **partnerRegisteredAt** - 注册时间，格式：YYYY-MM-DD HH:mm:ss
- **partnerLastLoginAt** - 最后登录时间，格式：YYYY-MM-DD HH:mm:ss

#### 认证信息属性
- **partnerCertificationStatus** - 认证状态：pending / approved / rejected
- **partnerCertifiedAt** - 认证通过时间，格式：YYYY-MM-DD HH:mm:ss
- **partnerApplicationId** - 关联的申请ID（外键，关联Application.applicationId）

#### 账户状态属性
- **partnerAccountStatus** - 账户状态：active / suspended / closed
- **partnerSettlementStatus** - 结算状态：normal / frozen / restricted

#### 权限等级属性
- **partnerPermissionLevel** - 权限等级：L0 / L1 / L2 / L3 / L4

#### 财务数据属性
- **partnerTotalRevenue** - 总交易额（P2）
- **partnerTotalProfit** - 累计利润
- **partnerAvailableBalance** - 可用余额
- **partnerPendingSettlement** - 待结算
- **partnerWithdrawnAmount** - 已提取

#### 业务模式属性
- **partnerBusinessModel** - 业务模式：mcp / saas / affiliate（从Application.businessModel继承）
- **partnerCanSetMarkupRate** - 是否允许自己设置加价率（boolean，MCP和推广联盟用户为false，只能由平台统一加价）
- **partnerDefaultCommissionRate** - 默认佣金比例（百分比，MCP/推广联盟用户使用，由平台设置）

#### 业务数据属性
- **partnerTotalOrders** - 订单总数
- **partnerCompletedOrders** - 已完成订单
- **partnerAvgMarkupRate** - 平均加价率（百分比，仅当partnerCanSetMarkupRate为true时有效）
- **partnerActiveCustomers** - 活跃客户数

#### 类型特有信息属性
- **partnerSpecificInfo** - 类型特有信息对象
  - **partnerRealName** - 真实姓名（个人/博主）
  - **partnerIdNumber** - 身份证号（个人/博主）
  - **partnerPlatformName** - 平台名称（博主）
  - **partnerFollowersCount** - 粉丝数（博主）
  - **partnerInfluenceScore** - 影响力评分（博主）
  - **partnerCompanyName** - 企业名称（企业）
  - **partnerSocialCreditCode** - 统一社会信用代码（企业）
  - **partnerLegalRepresentative** - 法人代表（企业）
  - **partnerRegisteredCapital** - 注册资本（企业）

#### 店铺信息属性
- **partnerStoreName** - 店铺名称
- **partnerCustomDomain** - 自定义域名
- **partnerStoreStatus** - 店铺状态：active / inactive

---

### 2.4 客户（Customer）

**说明**：订单客户信息对象（C端客户），订单通过customerId关联。Customer是订单的最终消费者，不是系统注册用户，仅存储订单相关的客户信息。

#### 基础属性
- **customerId** - 客户ID（主键）
- **customerName** - 客户姓名
- **customerPhone** - 客户手机号
- **customerEmail** - 客户邮箱（可选）
- **customerIdNumber** - 客户身份证号（可选）
- **customerFirstOrderAt** - 首次下单时间，格式：YYYY-MM-DD HH:mm:ss（从关联Order计算得出）
- **customerLastOrderAt** - 最近下单时间，格式：YYYY-MM-DD HH:mm:ss（从关联Order计算得出）

#### 业务数据属性（统计字段，通过关联Order计算得出）
- **customerTotalOrders** - 订单总数
- **customerPendingPaymentOrders** - 未支付订单数（订单状态为pending_payment）
- **customerCancelledOrders** - 取消订单数（订单状态为cancelled_free或cancelled_paid）
- **customerDisputedOrders** - 异议订单数（订单状态为disputed）

---

### 2.5 供应商（Supplier）

**说明**：供应商对象，订单通过supplierId关联。

#### 基础属性
- **supplierId** - 供应商ID（主键）
- **supplierName** - 供应商名称
- **supplierCode** - 供应商代码
- **supplierContactName** - 联系人姓名
- **supplierContactPhone** - 联系人手机号
- **supplierContactEmail** - 联系人邮箱
- **supplierStatus** - 供应商状态：active / inactive / suspended
- **supplierAddedAt** - 供应商入驻时间，格式：YYYY-MM-DD HH:mm:ss
- **supplierLastModifiedAt** - 供应商最后修改时间，格式：YYYY-MM-DD HH:mm:ss

---

## 三、核心实体字段定义

### 3.1 系统用户（User）

**说明**：User对象是B端系统的注册用户表，包含两类用户：管理员（admin）和小B用户（user）。管理员用于后台管理系统，小B用户用于小B端系统。当小B用户申请成为合作伙伴时，会创建Application记录；审核通过后，会创建Partner记录，Partner通过userId关联User.userId。

**主键设计**：userId（自增ID或UUID，唯一索引），email作为登录账号（可设置唯一索引用于登录验证）。

#### 基础属性
- **userId** - 用户ID（主键，自增ID或UUID，唯一索引）
- **email** - 邮箱（基础字段，登录账号，用于登录验证、联系、发邮件，可设置唯一索引）
- **passwordHash** - 密码哈希值（加密存储）
- **name** - 姓名
- **phone** - 手机号（可选）
- **role** - 角色：admin（管理员，后台管理系统）/ user（小B用户，小B端系统）
- **userRegisteredAt** - 用户注册时间，格式：YYYY-MM-DD HH:mm:ss
- **userLastLoginAt** - 最后登录时间，格式：YYYY-MM-DD HH:mm:ss（可选）

**说明**：User表仅用于身份认证和权限管理，不存储业务相关字段。业务字段（如服务类型、服务状态）存储在Application和Partner表中。email是User表的基础字段，用于登录、联系、发邮件等核心功能。

---

### 3.2 申请认证（Application）

**说明**：用户提交的认证申请，审核通过后创建Partner对象。

#### 基础属性
- **applicationId** - 申请编号，格式：APP-001
- **applicationStatus** - 审核状态：pending / approved / rejected
- **applicationSubmittedAt** - 提交时间，格式：YYYY-MM-DD HH:mm:ss
- **applicationReviewedAt** - 审核时间，格式：YYYY-MM-DD HH:mm:ss
- **applicationRejectionReason** - 驳回原因
- **applicationInternalNote** - 内部备注

#### 业务属性
- **applicantName** - 申请人姓名（从表单数据提取）
- **businessModel** - 业务模式：mcp / saas / affiliate
- **identityType** - 身份类型：developer / influencer / enterprise / agent
- **permissionLevel** - 权限等级：L0 / L1 / L2 / L3 / L4（审核通过后设置）

#### 关联User属性
- **userId** - 用户ID（外键，关联User.userId）
- **userEmail** - 用户邮箱（冗余字段，来自User.email，用于显示、快速查询、联系和发邮件）

#### 表单数据属性
- **data** - 完整表单数据（见下方"四、表单数据结构"）

---

### 3.3 订单（Order）

**说明**：订单信息，通过外键关联Hotel、Partner、Customer、Supplier、RoomType等对象。

#### 基础属性
- **orderId** - 订单编号，格式：ORD-2025001（主键）
- **orderCreatedAt** - 订单下单时间，格式：YYYY-MM-DD HH:mm:ss
- **orderSettledAt** - 结算时间，格式：YYYY-MM-DD HH:mm:ss（可选）

#### 关联Hotel属性（外键关联）
- **hotelId** - 酒店ID（外键，关联Hotel.hotelId）
- **hotelName** - 酒店名称（冗余字段，来自Hotel.hotelName，用于快速查询）
- **hotelAddress** - 酒店地址（冗余字段，来自Hotel.hotelAddress，用于快速查询）

#### 关联RoomType属性（外键关联）
- **roomTypeId** - 房型ID（外键，关联RoomType.roomTypeId）
- **roomTypeName** - 房型名称（冗余字段，来自RoomType.roomTypeName，用于快速查询）

#### 入住日期属性
- **checkInDate** - 入住日期，格式：YYYY-MM-DD
- **checkOutDate** - 离店日期，格式：YYYY-MM-DD
- **nights** - 入住天数（计算字段：checkOutDate - checkInDate）

#### 关联Partner属性（外键关联）
- **partnerId** - 小B客户ID（外键，关联Partner.partnerId）
- **partnerEmail** - 小B客户邮箱（外键，关联Partner.partnerEmail）
- **partnerName** - 小B客户名称（冗余字段，来自Partner.partnerDisplayName，用于快速查询）
- **partnerType** - 小B类型（冗余字段，来自Partner.partnerType，用于快速查询）
- **partnerBusinessModel** - 业务模式（冗余字段，来自Partner.partnerBusinessModel，用于快速查询）
- **partnerCanSetMarkupRate** - 是否允许自己设置加价率（冗余字段，来自Partner.partnerCanSetMarkupRate）

#### 关联Customer属性（外键关联）
- **customerId** - 客户ID（外键，关联Customer.customerId）
- **customerName** - 客户姓名（冗余字段，来自Customer.customerName，用于快速查询）
- **customerPhone** - 客户手机号（冗余字段，来自Customer.customerPhone，用于快速查询）

#### 关联Supplier属性（外键关联）
- **supplierId** - 供应商ID（外键，关联Supplier.supplierId）
- **supplierName** - 供应商名称（冗余字段，来自Supplier.supplierName，用于快速查询）

#### 价格体系属性（汇总）
- **p0_supplierCost** - 供应商供货价（P0，订单总金额，从nightDetails计算得出，供应商给平台的价格）
- **p1_platformPrice** - 平台供货价（P1，订单总金额，从nightDetails计算得出，SaaS模式中表示平台加价后给SaaS小B的价格；MCP/推广联盟模式下无单独的P1阶段，可存NULL或与P2相同用于对账）
- **p2_salePrice** - 销售价（P2，订单总金额，从nightDetails计算得出；SaaS模式中为小B加价后卖给用户的价格，MCP/推广联盟模式中为平台直接售卖给用户的价格）
- **platformProfit** - 平台利润（从nightDetails计算得出）
- **partnerProfit** - 小B利润/佣金（从nightDetails计算得出）
- **actualAmount** - 实付金额（订单总金额，从nightDetails计算得出）
- **refundAmount** - 退款金额（可选，从refundDetails计算得出）

#### 价格比例属性（订单级别）
订单级别的比例，用于记录订单创建时的定价规则，所有晚数使用相同的比例（如果不同晚数有不同比例，则在nightDetails中记录）：
- **platformMarkupRate** - 平台加价率（百分比，SaaS模式为P0到P1的加价率；MCP/推广联盟模式为平台从P0直接加价到P2的加价率，用于计算总利润，如10%）
- **partnerMarkupRate** - 小B加价率（百分比，从P1到P2的加价率，仅SaaS小B有效，如10%，非SaaS业务模式该字段为空）
- **partnerCommissionRate** - 小B佣金率（百分比，从P0到P2的总利润中给MCP/推广联盟的分成比例，仅MCP/推广联盟有效，如30%，SaaS模式该字段为空）

**说明**：
- **SaaS模式**：P0 → P1（平台加价）→ P2（小B加价），小B可自己设置加价率
- **MCP/推广联盟模式**：P0 → P2（平台统一加价），平台设置佣金率给MCP/推广联盟分成

#### 订单按天明细属性（OrderNightDetail数组）
对于多晚订单，需要记录每晚的详细价格和状态信息：

- **nightDetails** - 订单按天明细列表（OrderNightDetail数组）
  - **nightDate** - 入住日期，格式：YYYY-MM-DD（每晚的日期）
  - **nightP0** - 供应商供货价（P0，该晚的价格，供应商给平台的价格，平台成本）
  - **nightP1** - 平台供货价（P1，该晚的价格；SaaS模式中为平台加价后给SaaS小B的价格，MCP/推广联盟模式下可为NULL或与nightP2相同）
  - **nightP2** - 销售价（P2，该晚的价格，SaaS小B加价后或MCP/推广联盟直接卖给用户的价格）
  - **nightPlatformProfit** - 平台利润（该晚的利润）
  - **nightPartnerProfit** - 小B利润/佣金（该晚的利润；SaaS模式为利润，MCP/推广联盟模式为佣金）
  - **nightStatus** - 该晚状态：pending（待入住）/ checked_in（已入住）/ checked_out（已离店）/ cancelled（已取消）/ refunded（已退款）
  - **nightPlatformMarkupRate** - 该晚平台加价率（百分比，SaaS模式为P0到P1的加价率，MCP/推广联盟模式为P0到P2的加价率；如与订单级别不同则记录，否则使用订单级别）
  - **nightPartnerMarkupRate** - 该晚小B加价率（百分比，从P1到P2的加价率，仅SaaS小B有效，非SaaS模式可为空；如与订单级别不同则记录，否则使用订单级别）
  - **nightPartnerCommissionRate** - 该晚小B佣金率（百分比，从P0到P2的总利润中给MCP/推广联盟的分成比例，仅MCP/推广联盟有效，SaaS模式为空；如与订单级别不同则记录，否则使用订单级别）
  - **nightRefundAmount** - 该晚退款给用户的金额（可选，如果该晚被退款，从refundDetails计算得出）
  - **nightRefundRatio** - 该晚退款比例（可选，百分比，如50%表示退该晚的50%）
  - **nightRefundSupplierCost** - 该晚退回供应商成本（可选，从该晚的nightP0按退款比例计算，即退回供应商的成本）
  - **nightRefundPlatformProfit** - 该晚平台利润损失（可选，从该晚的nightPlatformProfit按退款比例计算）
  - **nightRefundPartnerProfit** - 该晚小B利润/佣金损失（可选，从该晚的nightPartnerProfit按退款比例计算）

**说明**：
- 订单总金额 = 所有nightDetails的nightP2之和
- 订单退款给用户的金额 = 所有nightDetails的nightRefundAmount之和
- 每晚的价格可能不同（周末价、节假日价等）
- MCP/推广联盟模式下没有单独的小B加价环节，nightP1可为空，nightPartnerMarkupRate为空，平台直接根据nightPlatformMarkupRate将P0加价到P2并按nightPartnerCommissionRate拆分利润
- 退款时按晚计算，可以只退部分晚，也可以退部分比例（如退50%）
- 退款分配逻辑（按比例退款）：
  - **退款给用户** = 该晚nightP2 × 退款比例
  - **退回供应商成本** = 该晚nightP0 × 退款比例（退回供应商的成本）
  - **平台利润损失** = 该晚nightPlatformProfit × 退款比例
- **小B利润/佣金损失** = 该晚nightPartnerProfit × 退款比例
  - 示例（SaaS模式）：第1晚供应商供价40（P0），平台加价10%后44（P1），小B再加价10%后用户支付48.4（P2），平台利润4，小B利润4.4
  - 示例（MCP/推广联盟模式）：第1晚供应商供价40（P0），平台按平台加价率20%直接定价为48（P2），总利润8，其中按30%佣金率分成给合作方2.4，其余5.6为平台利润
    - 退50%时：退款给用户24（48 × 50%），退回供应商20（40 × 50%），平台损失2.8（5.6 × 50%），小B佣金损失1.2（2.4 × 50%）

#### 退款明细属性（RefundDetail数组）
当订单发生退款时，需要记录详细的退款信息：

- **refundDetails** - 退款明细列表（RefundDetail数组，可选）
  - **refundId** - 退款ID（唯一标识）
  - **refundDate** - 退款日期，格式：YYYY-MM-DD（退款发生的日期）
  - **refundNights** - 退款晚数列表（数组，格式：YYYY-MM-DD，明确哪些晚被退款）
  - **refundRatio** - 退款比例（百分比，如50%表示退该晚的50%）
  - **refundAmount** - 退款给用户的金额（该次退款给用户的金额，从对应的nightDetails计算得出）
  - **refundReason** - 退款原因（客户取消、酒店原因、系统错误等）
  - **refundType** - 退款类型：full_refund（全额退款）/ partial_refund（部分退款，按晚退款）
  - **refundStatus** - 退款状态：processing（处理中）/ success（成功）/ failed（失败）
  - **refundCompletedAt** - 退款完成时间，格式：YYYY-MM-DD HH:mm:ss（可选）
  - **refundChannel** - 退款渠道：wechat / alipay / bank（原支付渠道）
  - **refundTransactionId** - 退款交易号（渠道返回的交易号）
  - **refundSupplierCost** - 退回供应商成本（从对应晚的nightP0按退款比例计算，即退回供应商的成本）
  - **refundPlatformProfit** - 平台承担的利润损失（从对应晚的nightPlatformProfit按退款比例计算）
  - **refundPartnerProfit** - 小B承担的利润损失（从对应晚的nightPartnerProfit按退款比例计算）

**说明**：
- 一个订单可能发生多次退款（部分退款场景）
- 每次退款都明确记录退了哪些晚（refundNights）和退款比例（refundRatio，如50%表示退该晚的50%）
- 退款金额计算逻辑（按比例退款）：
  - **退款给用户金额**（refundAmount）= 对应晚的nightP2 × refundRatio
  - **退回供应商成本**（refundSupplierCost）= 对应晚的nightP0 × refundRatio（退回供应商的成本）
  - **平台利润损失**（refundPlatformProfit）= 对应晚的nightPlatformProfit × refundRatio
  - **小B利润/佣金损失**（refundPartnerProfit）= 对应晚的nightPartnerProfit × refundRatio
  - 示例（SaaS模式）：第1晚供应商供价40（P0），平台加价10%后44（P1），小B再加价10%后用户支付48.4（P2），平台利润4，小B利润4.4
    - 退50%时：退款给用户24.2（48.4 × 50%），退回供应商20（40 × 50%），平台损失2（4 × 50%），小B损失2.2（4.4 × 50%）
  - 示例（MCP/推广联盟模式）：第1晚供应商供价40（P0），平台按平台加价率20%直接定价为48（P2），总利润8，其中按30%佣金率分成给合作方2.4，其余5.6为平台利润
    - 退50%时：退款给用户24（48 × 50%），退回供应商20（40 × 50%），平台损失2.8（5.6 × 50%），小B佣金损失1.2（2.4 × 50%）
- 退款成功后，对应晚的nightStatus更新为refunded，nightRefundAmount记录退款给用户的金额，并记录各方的成本/利润损失
- 订单总退款金额 = 所有refundDetails的refundAmount之和（退款给用户的总金额）

#### 状态属性
- **orderStatus** - 订单状态：pending_payment / pending_confirm / confirmed / completed / completed_settleable / cancelled_free / cancelled_paid / no_show / disputed
- **settlementStatus** - 结算状态：pending / ready / processing / completed

#### 五重门控属性
- **gates** - 门控状态对象
  - **gatesServiceCompleted** - Gate 1: 服务已完成（boolean）
  - **gatesCoolingOffPassed** - Gate 2: 冻结期已过（boolean）
  - **gatesNoDispute** - Gate 3: 订单无未决争议（boolean）
  - **gatesCostReconciled** - Gate 4: 供应商成本已对账（boolean）
  - **gatesAccountHealthy** - Gate 5: 结算对象状态正常（boolean）

#### 历史记录属性
- **statusHistory** - 状态历史时间轴数组
  - **statusHistoryStatus** - 状态
  - **statusHistoryTimestamp** - 时间戳，格式：YYYY-MM-DD HH:mm:ss
  - **statusHistoryDescription** - 描述（可选）

---

### 3.4 发票（Invoice）

**说明**：发票信息，关联订单和用户。

#### 基础属性
- **invoiceId** - 发票编号，格式：INV-20251031-001
- **invoiceStatus** - 发票状态：pending_invoice / invoicing / invoice_success_email_not_sent / invoice_success_email_sent / invoice_success_email_failed / email_resending / invoice_retrying / invoice_failed / refund_requested / refunding / refund_success / refund_retrying / refund_failed

#### 关联User属性
- **applicantUserId** - 发票申请方用户ID（外键，关联User.userId）
- **applicantUserName** - 发票申请方用户名（冗余字段，来自User.name或Partner.partnerDisplayName，用于快速查询）
- **applicantUserContact** - 用户联系方式（冗余字段，来自User.phone或Partner.partnerPhone，用于快速查询）

#### 时间属性
- **invoiceApplyTime** - 开票申请时间，格式：YYYY-MM-DD HH:mm:ss
- **invoiceSuccessTime** - 开票成功时间，格式：YYYY-MM-DD HH:mm:ss
- **emailSendTime** - 邮箱发送时间，格式：YYYY-MM-DD HH:mm:ss

#### 发票内容属性
- **invoiceContent** - 发票内容：住宿费
- **invoiceCode** - 发票代码
- **invoiceNumber** - 发票号码
- **invoiceIssuer** - 开票主体
- **invoiceType** - 发票类型：electronic

#### 接收人信息属性
- **recipientEmail** - 接收人邮箱
- **invoiceTitle** - 发票抬头：个人姓名/公司名称
- **taxNumber** - 发票税号：纳税人识别号，个人用户为--

#### 金额属性
- **invoiceAmount** - 开票金额（从关联订单的actualAmount - refundAmount计算得出，即订单金额扣除退款后的金额）
- **invoiceRefundAmount** - 退款金额（从关联订单的refundAmount汇总得出，可选）

#### 企业信息属性（详情页）
- **registeredAddress** - 注册地址
- **registeredPhone** - 注册电话
- **bankName** - 开户银行
- **bankAccount** - 银行账号
- **invoiceRemark** - 备注说明

#### 关联信息属性
- **orders** - 关联的订单列表（InvoiceOrder数组，外键关联Order.orderId）
  - **invoiceOrderOrderId** - 订单ID（外键，关联Order.orderId）
  - **invoiceOrderHotelName** - 酒店名称（冗余字段，来自Order.hotelName）
  - **invoiceOrderAmount** - 订单金额（冗余字段，来自Order.actualAmount，订单总金额）
  - **invoiceOrderRefundAmount** - 订单退款金额（冗余字段，来自Order.refundAmount，可选）
  - **invoiceOrderCreatedAt** - 订单下单时间（冗余字段，来自Order.orderCreatedAt）
- **trajectory** - 发票状态时间轴（InvoiceTrajectory数组）
  - **trajectoryTimestamp** - 时间戳
  - **trajectoryStatus** - 状态
  - **trajectoryDescription** - 描述
  - **trajectoryOperator** - 操作人（系统/人工，可选）

#### 异常信息属性
- **errorReason** - 异常原因

---

### 3.5 结算批次

#### 3.5.1 小B结算批次（PartnerSettlementBatch）

**说明**：小B客户的结算批次，包含多个订单的结算信息。

#### 基础属性
- **batchId** - 批次号，格式：BATCH-B-YYYYMMDD-XXX
- **batchStatus** - 批次状态：pending / pending_approval / approved / credited / completed / rejected
- **batchCreatedAt** - 结算批次生成时间，格式：YYYY-MM-DD HH:mm:ss
- **batchApprovedAt** - 审核时间，格式：YYYY-MM-DD HH:mm:ss
- **batchCompletedAt** - 完成时间，格式：YYYY-MM-DD HH:mm:ss

#### 关联Partner属性（外键关联）
- **partnerId** - 小B客户ID（外键，关联Partner.partnerId）
- **partnerName** - 小B客户名称（冗余字段，来自Partner.partnerDisplayName，用于快速查询）
- **partnerType** - 小B类型（冗余字段，来自Partner.partnerType，用于快速查询）

#### 操作人属性
- **batchApprovedBy** - 审核人ID
- **batchApprovalComment** - 审核意见
- **batchRejectionReason** - 驳回原因
- **batchCreditedAt** - 计入账户时间，格式：YYYY-MM-DD HH:mm:ss
- **batchCreditedBy** - 计入操作人ID

#### 结算周期属性
- **settlementPeriodStart** - 结算周期开始日期，格式：YYYY-MM-DD
- **settlementPeriodEnd** - 结算周期结束日期，格式：YYYY-MM-DD

#### 金额统计属性
- **orderCount** - 订单数量
- **settlementAmount** - 结算金额（小B利润/佣金）
- **totalC2cAmount** - 订单金额小计
- **totalPlatformProfit** - 平台利润总和

#### 关联订单属性
- **orders** - 批次包含的订单列表（PartnerBatchOrder数组，外键关联Order.orderId）
  - **batchOrderOrderId** - 订单ID（外键，关联Order.orderId）
  - **batchOrderHotelName** - 酒店名称（冗余字段，来自Order.hotelName）
  - **batchOrderCheckInDate** - 入住日期（冗余字段，来自Order.checkInDate）
  - **batchOrderCheckOutDate** - 离店日期（冗余字段，来自Order.checkOutDate）
  - **batchOrderC2cAmount** - C端支付金额（冗余字段，来自Order.actualAmount，订单总金额）
  - **batchOrderPlatformProfit** - 平台利润（冗余字段，来自Order.nightDetails中已入住晚数的nightPlatformProfit之和，已扣除退款晚数）
  - **batchOrderPartnerProfit** - 小B利润/佣金（冗余字段，来自Order.nightDetails中已入住晚数的nightPartnerProfit之和，已扣除退款晚数）
  - **batchOrderOrderStatus** - 订单状态（冗余字段，来自Order.orderStatus）
  - **batchOrderSettledNights** - 已结算晚数（从Order.nightDetails计算得出，nightStatus = checked_out的晚数）
  - **batchOrderRefundedNights** - 已退款晚数（从Order.nightDetails计算得出，nightStatus = refunded的晚数，可选）
  - **batchOrderPartnerCommissionRate** - 小B佣金比例（冗余字段，来自Order.partnerCommissionRate，仅当partnerCanSetMarkupRate为false时有效，MCP/推广联盟用户使用）

#### 3.5.2 供应商结算批次（SupplierSettlementBatch）

**说明**：供应商的结算批次，包含多个订单的成本信息。

#### 基础属性
- **batchId** - 批次号，格式：BATCH-S-YYYYMM-XXX
- **batchStatus** - 批次状态：pending / pending_approval / approved / paid / completed / rejected
- **batchCreatedAt** - 结算批次生成时间，格式：YYYY-MM-DD HH:mm:ss
- **batchApprovedAt** - 审核时间，格式：YYYY-MM-DD HH:mm:ss
- **batchCompletedAt** - 完成时间，格式：YYYY-MM-DD HH:mm:ss

#### 关联Supplier属性（外键关联）
- **supplierId** - 供应商ID（外键，关联Supplier.supplierId）
- **supplierName** - 供应商名称（冗余字段，来自Supplier.supplierName，用于快速查询）

#### 操作人属性
- **batchApprovedBy** - 审核人ID
- **batchApprovalComment** - 审核意见
- **batchRejectionReason** - 驳回原因
- **batchPaidAt** - 打款时间，格式：YYYY-MM-DD HH:mm:ss
- **batchPaidBy** - 打款操作人ID
- **paymentOrderId** - 打款单号
- **paymentStatus** - 打款状态：processing / success / failed

#### 结算周期属性
- **settlementPeriodStart** - 结算周期开始日期，格式：YYYY-MM-DD
- **settlementPeriodEnd** - 结算周期结束日期，格式：YYYY-MM-DD

#### 金额统计属性
- **orderCount** - 订单数量
- **settlementAmount** - 结算金额（供应商成本P0）
- **totalC2cAmount** - 订单金额小计

#### 关联订单属性
- **orders** - 批次包含的订单列表（SupplierBatchOrder数组，外键关联Order.orderId）
  - **batchOrderOrderId** - 订单ID（外键，关联Order.orderId）
  - **batchOrderHotelName** - 酒店名称（冗余字段，来自Order.hotelName）
  - **batchOrderCheckInDate** - 入住日期（冗余字段，来自Order.checkInDate）
  - **batchOrderCheckOutDate** - 离店日期（冗余字段，来自Order.checkOutDate）
  - **batchOrderC2cAmount** - C端支付金额（冗余字段，来自Order.actualAmount）
  - **batchOrderSupplierCost** - 供应商成本P0（冗余字段，来自Order.nightDetails中已入住晚数的nightP0之和，已扣除退款晚数）
  - **batchOrderOrderStatus** - 订单状态（冗余字段，来自Order.orderStatus）
  - **batchOrderSettledNights** - 已结算晚数（从Order.nightDetails计算得出，nightStatus = checked_out的晚数）
  - **batchOrderRefundedNights** - 已退款晚数（从Order.nightDetails计算得出，nightStatus = refunded的晚数，可选）
  - **batchOrderPartnerCommissionRate** - 小B佣金比例（冗余字段，来自Order.partnerCommissionRate，仅当partnerCanSetMarkupRate为false时有效，MCP/推广联盟用户使用）

---

### 3.6 提现（Withdrawal）

**说明**：用户提现记录。

#### 基础属性
- **withdrawalId** - 提现ID（流水号）
- **withdrawalStatus** - 提现状态：processing / success / failed / pending_review / rejected / closed
- **withdrawalApplyTime** - 提现申请时间，格式：YYYY-MM-DD HH:mm:ss
- **withdrawalTransferTime** - 转账汇款时间，格式：YYYY-MM-DD HH:mm:ss

#### 关联User属性
- **userId** - 用户ID（外键，关联User.userId）
- **userName** - 用户名称（冗余字段，来自User.name）

#### 业务属性
- **businessModel** - 业务模式：mcp / saas / affiliate

#### 账户信息属性
- **phone** - 提现人电话
- **account** - 提现账户
- **accountName** - 提现用户名

#### 金额属性
- **withdrawalAmount** - 提现金额

#### 备注属性
- **withdrawalRemark** - 备注
- **withdrawalRejectReason** - 拒绝原因
- **failureReason** - 失败原因

---

### 3.7 API密钥（ApiKey）

**说明**：API密钥信息，包含用户信息和使用统计。

#### 基础属性
- **apiKeyId** - 密钥ID
- **apiKeyStatus** - 密钥状态：active / suspended / revoked
- **apiKeyCreatedAt** - 密钥创建时间，格式：YYYY-MM-DD HH:mm:ss
- **apiKeySuspendedAt** - 暂停时间，格式：YYYY-MM-DD HH:mm:ss
- **suspendReason** - 暂停原因

#### 关联User属性
- **userId** - 用户ID（外键，关联User.userId）
- **userType** - 用户类型：individual / influencer / enterprise（从Application.identityType获取）

#### 密钥信息属性
- **keyName** - 密钥名称
- **keyPrefix** - 密钥前缀（只显示前缀）
- **riskLevel** - 风险等级：L0 / L1 / L2 / L3 / L4

#### 用户信息属性（冗余字段，用于快速查询）
- **userName** - 显示名称
- **userEmail** - 用户邮箱
- **userPhone** - 用户手机号

#### 个人用户属性
- **realName** - 真实姓名
- **idNumber** - 身份证号

#### 博主用户属性
- **platformName** - 平台名称
- **followersCount** - 粉丝数
- **influenceScore** - 影响力评分

#### 企业用户属性
- **companyName** - 企业名称
- **creditCode** - 统一社会信用代码
- **legalRepName** - 法人代表姓名
- **legalRepIdNumber** - 法人身份证号
- **contactName** - 联系人姓名
- **contactPhone** - 联系人手机号
- **contactEmail** - 联系人邮箱

#### 结算账户信息属性
- **accountType** - 账户类型：bank / alipay
- **bankName** - 开户银行
- **bankBranch** - 开户支行
- **accountNumber** - 账户号码
- **alipayAccount** - 支付宝账号
- **alipayRealName** - 支付宝实名姓名

#### 使用统计属性
- **totalCalls** - 总调用次数
- **callsToday** - 今日调用次数
- **callsThisMonth** - 本月调用次数
- **successRate** - 成功率（百分比）
- **avgResponseTime** - 平均响应时间（毫秒）
- **lastUsed** - 最后使用时间，格式：YYYY-MM-DD HH:mm:ss

---

### 3.8 交易记录（Transaction）

**说明**：系统交易流水记录。

#### 基础属性
- **transactionId** - 交易ID，格式：TXN-001
- **transactionStatus** - 交易状态：pending / completed / failed
- **transactionCreatedAt** - 交易发起时间，格式：YYYY-MM-DD HH:mm:ss
- **transactionCompletedAt** - 完成时间，格式：YYYY-MM-DD HH:mm:ss
- **transactionAmount** - 交易金额

#### 业务属性
- **transactionType** - 交易类型：income（收入）/ withdraw（提现）/ refund（退款）
- **transactionDescription** - 交易描述

#### 关联User属性
- **userId** - 用户ID（外键，关联User.userId）

#### 冗余字段（用于快速查询）
- **userName** - 用户名称（冗余字段，来自User.name）
- **userEmail** - 用户邮箱（冗余字段，来自User.email，用于显示、快速查询、联系和发邮件）
- **businessModel** - 业务模式

---

### 3.9 对账记录（Reconciliation）

#### 3.9.1 供应商成本对账（SupplierCostReconciliation）

**说明**：供应商成本对账记录，对比系统P0（供应商供货金额）与供应商账单。

#### 基础属性
- **reconciliationId** - 对账ID
- **reconciliationStatus** - 对账状态：pending / reconciling / reconciled / difference / resolved
- **reconciliationCreatedAt** - 对账生成时间，格式：YYYY-MM-DD HH:mm:ss
- **reconciliationReconciledAt** - 对账日期时间，格式：YYYY-MM-DD HH:mm:ss
- **reconciliationResolvedAt** - 处理时间，格式：YYYY-MM-DD HH:mm:ss

#### 操作人属性
- **reconciliationReconciledBy** - 对账人ID
- **reconciliationResolvedBy** - 处理人ID

#### 业务属性
- **reconciliationType** - 对账类型：supplier_cost
- **orderId** - 订单ID（外键，关联Order.orderId）
- **supplierName** - 供应商名称
- **supplierBillNo** - 供应商账单号

- **systemP0** - 系统供应商成本金额（从Order.nightDetails中已入住晚数的nightP0之和计算，已扣除退款晚数）
- **supplierBillAmount** - 供应商账单金额
- **difference** - 差异金额（systemP0 - supplierBillAmount）
- **differenceReason** - 差异原因
- **resolution** - 处理方案

**说明**：对账时使用的systemP0金额（即系统供应商成本）是基于已入住且未退款的晚数的nightP0之和计算的，已退款的晚数不参与对账。对账时对比系统P0与供应商账单金额。

#### 3.9.2 支付渠道对账（PaymentChannelReconciliation）

**说明**：支付渠道对账记录，对比平台订单与渠道订单。

#### 基础属性
- **reconciliationId** - 对账ID
- **reconciliationStatus** - 对账状态：reconciling / balanced / platform_more / channel_more / resolved
- **reconciliationCreatedAt** - 对账生成时间，格式：YYYY-MM-DD HH:mm:ss
- **reconciliationReconciledAt** - 对账时间，格式：YYYY-MM-DD HH:mm:ss
- **reconciliationResolvedAt** - 处理时间，格式：YYYY-MM-DD HH:mm:ss
- **reconciliationResolvedBy** - 处理人ID

#### 业务属性
- **reconciliationType** - 对账类型：payment_channel
- **reconciliationDate** - 对账日期，格式：YYYY-MM-DD
- **channel** - 支付渠道：wechat / alipay / bank

#### 统计属性
- **platformOrderCount** - 平台订单数量
- **platformOrderAmount** - 平台订单金额
- **channelOrderCount** - 渠道订单数量
- **channelOrderAmount** - 渠道订单金额
- **differenceAmount** - 差异金额
- **differenceOrderCount** - 差异订单数量

#### 差异明细属性
- **differenceOrders** - 差异订单列表（PaymentChannelDifferenceOrder数组）
  - **differenceOrderOrderId** - 订单ID
  - **differenceOrderPlatformAmount** - 平台金额
  - **differenceOrderChannelAmount** - 渠道金额
  - **differenceOrderDifference** - 差异金额
  - **differenceOrderType** - 差异类型：platform_only / channel_only / amount_diff
  - **differenceOrderPlatformOrderTime** - 平台订单时间
  - **differenceOrderChannelOrderTime** - 渠道订单时间

#### 3.9.3 提现对账（WithdrawalReconciliation）

**说明**：提现对账记录，对比打款金额与账本金额。

#### 基础属性
- **reconciliationId** - 对账ID
- **reconciliationStatus** - 对账状态：balanced / withdrawal_more / account_more / resolved
- **reconciliationCreatedAt** - 对账生成时间，格式：YYYY-MM-DD HH:mm:ss
- **reconciliationResolvedAt** - 处理时间，格式：YYYY-MM-DD HH:mm:ss
- **reconciliationResolvedBy** - 处理人ID

#### 业务属性
- **reconciliationType** - 对账类型：withdrawal
- **reconciliationDate** - 对账日期，格式：YYYY-MM-DD

#### 金额属性
- **withdrawalAmount** - 打款金额
- **accountAmount** - 账本金额
- **difference** - 差异金额

#### 关联记录属性
- **withdrawalRecords** - 提现打款记录列表（WithdrawalRecord数组）

#### 3.9.4 开票对账（InvoiceReconciliation）

**说明**：开票对账记录，对比开票金额与成本金额。

#### 基础属性
- **reconciliationId** - 对账ID
- **reconciliationStatus** - 对账状态：balanced / invoice_more / cost_more / resolved
- **reconciliationCreatedAt** - 对账生成时间，格式：YYYY-MM-DD HH:mm:ss
- **reconciliationResolvedAt** - 处理时间，格式：YYYY-MM-DD HH:mm:ss
- **reconciliationResolvedBy** - 处理人ID

#### 业务属性
- **reconciliationType** - 对账类型：invoice
- **reconciliationDate** - 对账日期，格式：YYYY-MM-DD

- **invoiceAmount** - 开票金额（订单金额扣除退款后的金额）
- **costAmount** - 成本金额（从订单nightDetails中已入住晚数的nightP0之和计算，已扣除退款晚数）
- **difference** - 差异金额（invoiceAmount - costAmount）

#### 关联记录属性
- **invoiceRecords** - 开票记录列表（InvoiceRecord数组）

---

### 3.10 价格规则（PricingRule）

**说明**：平台价格配置规则。

#### 基础属性
- **pricingRuleId** - 规则ID
- **pricingRuleStatus** - 状态：active / inactive
- **pricingRuleCreatedAt** - 价格规则创建时间，格式：YYYY-MM-DD HH:mm:ss
- **pricingRuleLastModifiedAt** - 价格规则最后修改时间，格式：YYYY-MM-DD HH:mm:ss

#### 业务属性
- **ruleName** - 规则名称
- **scope** - 适用范围：global（全局）/ brand（品牌）/ city（城市）/ supplier（供应商）
- **target** - 目标对象（品牌名、城市名或供应商ID）
- **markupRate** - 平台利润率（百分比）
- **priority** - 优先级（数字越大优先级越低）

---

### 3.11 违约扣费记录（ViolationFeeRecord）

**说明**：违约扣费记录。

#### 基础属性
- **feeId** - 扣费ID，格式：FEE-YYYYMMDD-XXX
- **feeStatus** - 扣费状态：pending / deducted / cancelled
- **feeTime** - 扣费时间，格式：YYYY-MM-DD HH:mm:ss
- **feeOperatorId** - 操作人ID
- **feeOperatorName** - 操作人姓名
- **feeRemark** - 备注

#### 关联属性
- **orderId** - 关联订单ID（外键，关联Order.orderId）
- **relatedObjectId** - 关联对象ID
- **relatedObjectName** - 关联对象名称

#### 业务属性
- **feeType** - 扣费类型：dispute_deduction（争议扣费）/ no_show_fee（未入住费用）/ violation_fee（违约费用）/ other（其他）
- **feeReason** - 扣费原因
- **feeAmount** - 扣费金额（负数）
- **accountType** - 账户类型：points（积分）/ cash（现金）

---

### 3.12 订单交易记录（OrderTransaction）

**说明**：订单相关的支付、退款交易记录。

#### 基础属性
- **transactionId** - 交易ID，格式：TXN-YYYYMMDD-XXX
- **transactionTime** - 交易时间，格式：YYYY-MM-DD HH:mm:ss
- **transactionOperatorId** - 操作人ID
- **transactionOperatorName** - 操作人姓名
- **transactionRemark** - 备注

#### 关联属性
- **orderId** - 关联订单ID（外键，关联Order.orderId）
- **refundId** - 关联退款ID（外键，关联Order.refundDetails[].refundId，当transactionType为order_refund时必填）
- **relatedObjectId** - 关联对象ID
- **relatedObjectName** - 关联对象名称

#### 业务属性
- **transactionType** - 交易类型：order_payment（订单支付）/ order_refund（订单退款）/ order_supplement（订单补款）/ other（其他）
- **paymentChannel** - 支付渠道：wechat / alipay / bank / other
- **paymentStatus** - 支付状态：processing / success / failed / refunded
- **transactionAmount** - 交易金额（支付为正数，退款为负数）
- **channelTransactionId** - 渠道交易号

#### 退款关联属性（当transactionType为order_refund时）
- **refundNights** - 退款晚数列表（冗余字段，来自Order.refundDetails[].refundNights，明确退了哪些晚）
- **refundReason** - 退款原因（冗余字段，来自Order.refundDetails[].refundReason）
- **refundType** - 退款类型（冗余字段，来自Order.refundDetails[].refundType）：full_refund（全额退款）/ partial_refund（部分退款）

---

## 四、表单数据结构

### 4.1 个人认证表单（IndividualFormData）

**适用场景**：
- **身份类型**: developer（独立开发者）、agent（个人旅行代理）
- **业务模式**: mcp、saas、affiliate

#### 基础身份信息
- **realName** - 真实姓名（必填）
- **idNumber** - 身份证号（必填，18位）
- **idValidityStart** - 身份证有效期起始日期（必填）
- **idValidityEnd** - 身份证有效期结束日期（必填）
- **idPhotoFront** - 身份证人像面照片URL（必填）
- **idPhotoBack** - 身份证国徽面照片URL（必填）

#### 推广渠道信息
- **promotionChannels** - 主要推广渠道数组（agent必填，developer可选）
  - 选项：社交媒体/内容平台、私域流量、线下客户/门店推荐、企业客户/差旅代订、其他
- **promotionChannelsOther** - 其他渠道说明（当选择"其他"时必填）

#### 联系方式
- **phone** - 联系手机号（必填，11位）
- **email** - 电子邮箱（选填）

#### 结算账户
- **accountType** - 账户类型（必填）：bank / alipay

##### 银行卡类型
- **bankCardholderName** - 开户人姓名（自动填充realName，只读）
- **bankName** - 开户银行（必填）
- **bankBranch** - 开户支行（必填）
- **bankCardNumber** - 银行卡号（必填）

##### 支付宝类型
- **alipayAccount** - 支付宝账号（必填，手机号或邮箱）
- **alipayRealName** - 实名认证姓名（必填，需与realName一致）

#### MCP业务额外字段（仅developer）
- **githubAccount** - GitHub账号（选填）
- **portfolioLink** - 作品集链接（选填）
- **appScreenshots** - 应用截图URL数组（选填，最多3张）

#### Affiliate业务额外字段（developer或agent）
- **businessScenario** - 业务场景说明（选填）

#### 验证状态
- **agreementAccepted** - 协议同意状态对象
  - accepted: boolean
  - timestamp: string
  - version: string
- **faceVerified** - 人脸识别验证状态（boolean）
- **phoneVerified** - 手机号验证状态（boolean）

---

### 4.2 博主认证表单（InfluencerFormData）

**适用场景**：
- **身份类型**: influencer（旅行达人）
- **业务模式**: saas、affiliate

#### 基础身份信息
- **realName** - 真实姓名（必填）
- **idNumber** - 身份证号（必填，18位）
- **idValidityStart** - 身份证有效期起始日期（必填）
- **idValidityEnd** - 身份证有效期结束日期（必填）
- **idPhotoFront** - 身份证人像面照片URL（必填）
- **idPhotoBack** - 身份证国徽面照片URL（必填）

#### 平台信息
- **mainPlatform** - 主营社交平台（必填）
  - 选项：小红书、抖音、微信公众号、微博、B站、YouTube、Instagram、知乎、快手
- **mainProfileLink** - 个人主页链接（必填）
- **mainFollowersCount** - 粉丝数/订阅数（必填，需≥门槛值）
  - SaaS业务门槛：公众号≥5000，小红书≥1万，其他≥5000
  - Affiliate业务门槛：公众号≥1000，小红书≥5000，其他≥3000
- **mainScreenshots** - 后台数据截图URL数组（必填，最多3张）

#### 合作信息
- **cooperationIntro** - 合作简介（选填）

#### 联系方式
- **phone** - 联系手机号（必填，11位）
- **email** - 电子邮箱（选填）

#### 结算账户
- **accountType** - 账户类型（必填）：bank / alipay

##### 银行卡类型
- **bankCardholderName** - 开户人姓名（自动填充realName，只读）
- **bankName** - 开户银行（必填）
- **bankBranch** - 开户支行（必填）
- **bankCardNumber** - 银行卡号（必填）

##### 支付宝类型
- **alipayAccount** - 支付宝账号（必填，手机号或邮箱）
- **alipayRealName** - 实名认证姓名（必填，需与realName一致）

#### 验证状态
- **agreementAccepted** - 协议同意状态对象
  - accepted: boolean
  - timestamp: string
  - version: string
- **faceVerified** - 人脸识别验证状态（boolean）
- **phoneVerified** - 手机号验证状态（boolean）

---

### 4.3 企业认证表单（EnterpriseFormData）

**适用场景**：
- **身份类型**: enterprise（旅行相关企业）
- **业务模式**: mcp、saas、affiliate

#### 企业基础信息
- **companyName** - 企业名称（必填）
- **creditCode** - 统一社会信用代码（必填，18位）
- **businessLicense** - 营业执照照片URL（必填）

#### 法人信息
- **legalRepName** - 法人代表姓名（必填）
- **legalRepIdNumber** - 法人身份证号（必填，18位）
- **legalRepIdPhotoFront** - 法人身份证人像面照片URL（必填）
- **legalRepIdPhotoBack** - 法人身份证国徽面照片URL（必填）

#### 联系人信息
- **contactName** - 联系人姓名（必填）
- **contactPhone** - 联系人手机号（必填，11位）
- **contactEmail** - 联系人电子邮箱（必填，格式验证）

#### 结算账户（对公账户）
- **accountHolderName** - 开户主体名称（自动填充companyName，只读，必填）
- **bankName** - 开户银行（必填）
- **bankBranch** - 开户支行（必填）
- **accountNumber** - 对公银行账号（必填）

#### MCP业务额外字段
- **techTeamSize** - 技术团队规模（选填）
- **techTeamDescription** - 技术团队说明（选填）
- **companyScale** - 企业规模说明（选填）

#### SaaS业务额外字段
- **existingBusinessLink** - 现有业务链接（选填）
- **existingBusinessScreenshots** - 现有业务截图URL数组（选填，最多3张）

#### Affiliate业务额外字段
- **businessScenario** - 业务场景说明（选填，B2B分销场景描述）

#### 验证状态
- **agreementAccepted** - 协议同意状态对象
  - accepted: boolean
  - timestamp: string
  - version: string
- **faceVerified** - 法人人脸识别验证状态（boolean）
- **phoneVerified** - 联系人手机号验证状态（boolean）

---

## 五、实体关联关系

### 5.1 核心关联链

```
User（系统用户）
  ↓ (通过userId关联)
Application（申请认证）
  ↓ (审核通过后创建)
Partner（小B合作伙伴）
  ↓ (生成订单)
Order（订单）
  ├─→ Hotel（酒店，外键关联）
  ├─→ RoomType（房型，外键关联）
  ├─→ Customer（客户，外键关联）
  ├─→ Supplier（供应商，外键关联）
  ├─→ Invoice（发票，外键关联）
  ├─→ PartnerSettlementBatch（小B结算批次，外键关联）
  ├─→ SupplierSettlementBatch（供应商结算批次，外键关联）
  ├─→ Reconciliation（对账，外键关联）
  └─→ OrderTransaction（订单交易，外键关联）
```

### 5.2 关联字段映射

#### User → Application
- **User.userId** → **Application.userId**（外键关联）
- **User.email** → **Application.userEmail**（冗余字段，来自User.email，用于显示、快速查询、联系和发邮件）

#### Application → Partner
- **Application.applicationId** → **Partner.partnerApplicationId**（外键关联，审核通过后创建Partner）
- **Application.identityType** → **Partner.partnerType**（属性关联，映射规则：developer/agent → individual，influencer → influencer，enterprise → enterprise）
- **Application.businessModel** → **Partner.partnerBusinessModel**（属性关联，业务模式：mcp / saas / affiliate）
- **Application.businessModel** → **Partner.partnerCanSetMarkupRate**（逻辑关联，MCP/推广联盟用户不能自己设置加价率，只能由平台统一加价）
- **Application.data.realName** → **Partner.partnerSpecificInfo.partnerRealName**（属性关联，个人/博主）
- **Application.data.companyName** → **Partner.partnerSpecificInfo.partnerCompanyName**（属性关联，企业）

#### Partner → PartnerSettlementBatch
- **Partner.partnerId** → **PartnerSettlementBatch.partnerId**（外键关联）
- **Partner.partnerDisplayName** → **PartnerSettlementBatch.partnerName**（冗余字段）
- **Partner.partnerType** → **PartnerSettlementBatch.partnerType**（冗余字段）
- **Partner.partnerBusinessModel** → **Order.partnerBusinessModel**（冗余字段，业务模式）
- **Partner.partnerCanSetMarkupRate** → **Order.partnerCanSetMarkupRate**（冗余字段，是否允许自己设置加价率）
- **Partner.partnerDefaultCommissionRate** → **Order.partnerCommissionRate**（属性关联，MCP/推广联盟用户的佣金比例，由平台设置）
- **Order.partnerCommissionRate** → **PartnerSettlementBatch.orders[].batchOrderPartnerCommissionRate**（冗余字段，仅当partnerCanSetMarkupRate为false时有效）

#### Supplier → SupplierSettlementBatch
- **Supplier.supplierId** → **SupplierSettlementBatch.supplierId**（外键关联）
- **Supplier.supplierName** → **SupplierSettlementBatch.supplierName**（冗余字段）

#### Partner → Order
- **Partner.partnerId** → **Order.partnerId**（外键关联）
- **Partner.partnerEmail** → **Order.partnerEmail**（外键关联）
- **Partner.partnerDisplayName** → **Order.partnerName**（冗余字段）
- **Partner.partnerType** → **Order.partnerType**（冗余字段）

#### Hotel → Order
- **Hotel.hotelId** → **Order.hotelId**（外键关联）
- **Hotel.hotelName** → **Order.hotelName**（冗余字段）
- **Hotel.hotelAddress** → **Order.hotelAddress**（冗余字段）

#### RoomType → Order
- **RoomType.roomTypeId** → **Order.roomTypeId**（外键关联）
- **RoomType.roomTypeName** → **Order.roomTypeName**（冗余字段）

#### Customer → Order
- **Customer.customerId** → **Order.customerId**（外键关联）
- **Customer.customerName** → **Order.customerName**（冗余字段）
- **Customer.customerPhone** → **Order.customerPhone**（冗余字段）

#### Supplier → Order
- **Supplier.supplierId** → **Order.supplierId**（外键关联）
- **Supplier.supplierName** → **Order.supplierName**（冗余字段）

#### Order → Invoice
- **Order.orderId** → **Invoice.orders[].invoiceOrderOrderId**（外键关联）
- **Order.hotelName** → **Invoice.orders[].invoiceOrderHotelName**（冗余字段）
- **Order.actualAmount** → **Invoice.orders[].invoiceOrderAmount**（冗余字段，订单总金额）
- **Order.refundAmount** → **Invoice.orders[].invoiceOrderRefundAmount**（冗余字段，订单退款金额）
- **Order.orderCreatedAt** → **Invoice.orders[].invoiceOrderCreatedAt**（冗余字段，订单下单时间）

**说明**：发票金额 = 订单金额（actualAmount）- 退款金额（refundAmount），即实际开票金额为扣除退款后的金额。

#### Order → SettlementBatch
- **Order.orderId** → **PartnerSettlementBatch.orders[].batchOrderOrderId**（外键关联）
- **Order.orderId** → **SupplierSettlementBatch.orders[].batchOrderOrderId**（外键关联）
- **Order.hotelName** → **PartnerSettlementBatch.orders[].batchOrderHotelName**（冗余字段）
- **Order.checkInDate** → **PartnerSettlementBatch.orders[].batchOrderCheckInDate**（冗余字段）
- **Order.checkOutDate** → **PartnerSettlementBatch.orders[].batchOrderCheckOutDate**（冗余字段）
- **Order.actualAmount** → **PartnerSettlementBatch.orders[].batchOrderC2cAmount**（冗余字段，订单总金额）
- **Order.nightDetails** → **SupplierSettlementBatch.orders[].batchOrderSupplierCost**（结算金额计算，来自已入住晚数的nightP0之和，供应商供货成本）
- **Order.nightDetails** → **PartnerSettlementBatch.orders[].batchOrderPlatformProfit**（结算金额计算，来自已入住晚数的nightPlatformProfit之和）
- **Order.nightDetails** → **PartnerSettlementBatch.orders[].batchOrderPartnerProfit**（结算金额计算，来自已入住晚数的nightPartnerProfit之和）
- **Order.nightDetails** → **PartnerSettlementBatch.orders[].batchOrderSettledNights**（已结算晚数，从nightDetails计算，nightStatus = checked_out的晚数）
- **Order.nightDetails** → **SupplierSettlementBatch.orders[].batchOrderSettledNights**（已结算晚数，从nightDetails计算，nightStatus = checked_out的晚数）
- **Order.nightDetails** → **PartnerSettlementBatch.orders[].batchOrderRefundedNights**（已退款晚数，从nightDetails计算，nightStatus = refunded的晚数，可选）
- **Order.nightDetails** → **SupplierSettlementBatch.orders[].batchOrderRefundedNights**（已退款晚数，从nightDetails计算，nightStatus = refunded的晚数，可选）
- **Order.orderStatus** → **PartnerSettlementBatch.orders[].batchOrderOrderStatus**（冗余字段）
- **Order.orderStatus** → **SupplierSettlementBatch.orders[].batchOrderOrderStatus**（冗余字段）

**说明**：结算批次中的订单利润是基于已入住且已离店的晚数计算的，已退款的晚数不参与结算。

#### Order → Reconciliation
- **Order.orderId** → **SupplierCostReconciliation.orderId**（外键关联）
- **Order.nightDetails** → **SupplierCostReconciliation.systemP0**（对账金额计算，来自已入住晚数的nightP0之和，已扣除退款晚数，对账时对比系统P0与供应商账单）

#### Order → OrderTransaction
- **Order.orderId** → **OrderTransaction.orderId**（外键关联）
- **Order.refundDetails[].refundId** → **OrderTransaction.refundId**（外键关联，当transactionType为order_refund时）
- **Order.refundDetails[].refundNights** → **OrderTransaction.refundNights**（冗余字段，明确退了哪些晚）
- **Order.refundDetails[].refundReason** → **OrderTransaction.refundReason**（冗余字段）
- **Order.refundDetails[].refundType** → **OrderTransaction.refundType**（冗余字段）

#### User → Withdrawal
- **User.userId** → **Withdrawal.userId**（外键关联）
- **User.name** → **Withdrawal.userName**（冗余字段）

#### User → ApiKey
- **User.userId** → **ApiKey.userId**（外键关联）
- **Application.identityType** → **ApiKey.userType**（从Application获取）
- **Application.data** → **ApiKey**（提取用户详细信息）

---

## 六、字段对齐对照表

### 6.1 身份标识字段对齐

| 字段含义 | Application | ApiKey | Partner | Order |
|---------|------------|--------|---------|-------|
| 用户ID | userId（关联User.userId） | userId（关联User.userId） | partnerId（Partner自己的ID） | partnerId（关联Partner.partnerId） |
| 用户邮箱 | userEmail（冗余字段，来自User.email） | userEmail（冗余字段） | partnerEmail（冗余字段，来自User.email） | partnerEmail（冗余字段，来自Partner.partnerEmail） |
| 用户名称 | applicantName | userName | partnerName | partnerName |
| 身份类型 | identityType | userType | partnerType | partnerType |

### 6.2 结算账户字段对齐

| 字段含义 | IndividualForm | InfluencerForm | EnterpriseForm | ApiKey |
|---------|---------------|---------------|---------------|--------|
| 账户类型 | accountType | accountType | -（固定对公） | accountType |
| 开户银行 | bankName | bankName | bankName | bankName |
| 开户支行 | bankBranch | bankBranch | bankBranch | bankBranch |
| 银行卡号 | bankCardNumber | bankCardNumber | accountNumber | accountNumber |
| 支付宝账号 | alipayAccount | alipayAccount | - | alipayAccount |
| 支付宝实名 | alipayRealName | alipayRealName | - | alipayRealName |
| 账户持有人 | bankCardholderName | bankCardholderName | accountHolderName | - |

### 6.3 联系方式字段对齐

| 字段含义 | IndividualForm | InfluencerForm | EnterpriseForm | User | ApiKey |
|---------|---------------|---------------|---------------|------|--------|
| 手机号 | phone | phone | contactPhone | phone | userPhone |
| 邮箱 | email | email | contactEmail | email | userEmail |

---

## 七、数据流转规则

### 7.1 申请到合作伙伴转换

**触发条件**: Application.applicationStatus = 'approved'

**字段映射**:
- **Application.applicationId** → Partner.partnerApplicationId（外键）
- **Application.identityType** → Partner.partnerType（属性，映射规则：developer/agent → individual，influencer → influencer，enterprise → enterprise）
- **Application.data.realName** → Partner.partnerDisplayName（个人/博主，属性）
- **Application.data.companyName** → Partner.partnerDisplayName（企业，属性）
- **Application.data.phone** → Partner.partnerPhone（属性）
- **Application.userId** → Partner.userId（外键，关联User.userId）
- **Application.userEmail** → Partner.partnerEmail（冗余字段，来自User.email，用于显示）
- **Application.permissionLevel** → Partner.partnerPermissionLevel（属性）

### 7.2 订单关联规则

**关联字段**:
- Order.partnerId → Partner.partnerId（外键关联）
- Order.partnerEmail → Partner.partnerEmail（外键关联）
- Order.partnerName → Partner.partnerDisplayName（冗余字段，用于快速查询）
- Order.partnerType → Partner.partnerType（冗余字段，用于快速查询）

**关联Hotel字段**:
- Order.hotelId → Hotel.hotelId（外键关联）
- Order.hotelName → Hotel.hotelName（冗余字段，用于快速查询）
- Order.hotelAddress → Hotel.hotelAddress（冗余字段，用于快速查询）

**关联RoomType字段**:
- Order.roomTypeId → RoomType.roomTypeId（外键关联）
- Order.roomTypeName → RoomType.roomTypeName（冗余字段，用于快速查询）

**关联Customer字段**:
- Order.customerId → Customer.customerId（外键关联）
- Order.customerName → Customer.customerName（冗余字段，用于快速查询）
- Order.customerPhone → Customer.customerPhone（冗余字段，用于快速查询）

**关联Supplier字段**:
- Order.supplierId → Supplier.supplierId（外键关联）
- Order.supplierName → Supplier.supplierName（冗余字段，用于快速查询）

**价格计算**:
- 订单按天明细（nightDetails）：
  - 每晚的nightP0 = 供应商供货价（供应商给平台的价格，平台成本，可能不同，根据日期、周末、节假日等）
  - **SaaS模式**：
    - nightP1 = nightP0 × (1 + 平台加价率)（平台加价后给SaaS小B的价格，若该晚有nightPlatformMarkupRate则优先使用）
    - nightP2 = nightP1 × (1 + 小B加价率)（小B加价后卖给用户的价格，若该晚有nightPartnerMarkupRate则优先使用）
    - nightPlatformProfit = nightP1 - nightP0（平台利润）
    - nightPartnerProfit = nightP2 - nightP1（SaaS模式下的小B利润）
  - **MCP/推广联盟模式**：
    - nightP1 为空或与nightP2相同（无单独的小B加价环节）
    - nightP2 = nightP0 × (1 + 平台统一加价率)（平台直接加价后面向用户的价格，若该晚有nightPlatformMarkupRate则优先使用）
    - 总利润 = nightP2 - nightP0
    - nightPartnerProfit = nightP2 × partnerCommissionRate（小B佣金，若该晚有nightPartnerCommissionRate则优先使用）
    - nightPlatformProfit = 总利润 - nightPartnerProfit（平台利润）
- 订单汇总价格：
  - Order.p0_supplierCost = 所有nightDetails的nightP0之和
  - Order.p1_platformPrice = 所有nightDetails的nightP1之和（仅SaaS模式有效，非SaaS模式可为空或与Order.p2_salePrice一致）
  - Order.p2_salePrice = 所有nightDetails的nightP2之和
  - Order.platformProfit = 所有nightDetails的nightPlatformProfit之和
  - Order.partnerProfit = 所有nightDetails的nightPartnerProfit之和（SaaS模式为小B利润，MCP/推广联盟模式为佣金）
  - Order.actualAmount = Order.p2_salePrice（实付金额）
- 退款计算（按比例退款）：
  - 退款时，从refundDetails中指定要退的晚数（refundNights）和退款比例（refundRatio，如50%）
  - **退款给用户金额**（refundAmount）= 对应晚数的nightP2 × refundRatio
  - **退回供应商成本**（refundSupplierCost）= 对应晚数的nightP0 × refundRatio（退回供应商的成本）
  - **平台利润损失**（refundPlatformProfit）= 对应晚数的nightPlatformProfit × refundRatio
  - **小B利润/佣金损失**（refundPartnerProfit）= 对应晚数的nightPartnerProfit × refundRatio
  - Order.refundAmount = 所有refundDetails的refundAmount之和（退款给用户的总金额）
  - 退款成功后，对应晚的nightStatus更新为refunded，nightRefundAmount记录退款给用户的金额，并记录各方的成本/利润损失
  - 示例（SaaS模式）：第1晚供应商供价40（P0），平台加价10%后44（P1），小B再加价10%后用户支付48.4（P2），平台利润4，小B利润4.4
    - 退50%时：退款给用户24.2，退回供应商20，平台损失2，小B损失2.2

### 7.3 结算批次生成规则

**小B结算批次**:
- 关联条件：Order.partnerEmail = Partner.partnerEmail
- 结算金额计算：
  - 只结算已入住的晚数（nightStatus = checked_out）
  - 结算金额 = 所有已入住晚数的nightPartnerProfit之和
  - 已退款的晚数不参与结算（nightStatus = refunded）
- 结算周期：按周/月自动生成

**供应商结算批次**:
- 关联条件：Order的供应商ID
- 结算金额计算：
  - 只结算已入住的晚数（nightStatus = checked_out）
  - 结算金额 = 所有已入住晚数的nightP0之和
  - 已退款的晚数不参与结算（nightStatus = refunded）
- 结算周期：按月生成

**说明**：
- 结算时只计算已入住且已离店的晚数（nightStatus = checked_out）
- 已退款的晚数（nightStatus = refunded）不参与结算
- 待入住、已取消、未入住的晚数不参与结算

### 7.4 退款流转规则

**退款流程**：
1. **退款申请**：创建RefundDetail记录，设置refundStatus = processing
2. **退款处理**：根据refundNights计算退款金额（对应晚数的nightP2之和）
3. **退款执行**：通过支付渠道执行退款，记录refundChannel和refundTransactionId
4. **退款成功**：
   - 更新RefundDetail.refundStatus = success
   - 更新RefundDetail.refundCompletedAt
   - 更新对应晚数的nightStatus = refunded
   - 更新对应晚数的nightRefundAmount = 该晚的nightP2
   - 更新Order.refundAmount（累加本次退款金额）
   - 创建OrderTransaction记录（transactionType = order_refund，关联refundId）
5. **退款失败**：更新RefundDetail.refundStatus = failed，可重新发起退款

**退款金额计算**（按比例退款）：
- 退款给用户金额计算：
  - 部分退款（按晚）：refundAmount = 指定晚数（refundNights）的nightP2 × refundRatio
  - 部分退款（按比例）：refundAmount = 指定晚数的nightP2 × refundRatio（如50%）
  - 全额退款：refundAmount = 所有晚数的nightP2之和（refundRatio = 100%）
- 退款成本分配（按比例退款）：
  - **退回供应商成本** = 对应晚数的nightP0 × refundRatio（退回供应商的成本）
  - **平台利润损失** = 对应晚数的nightPlatformProfit × refundRatio
- **小B利润/佣金损失** = 对应晚数的nightPartnerProfit × refundRatio
  - 示例（SaaS模式）：第1晚供应商供价40（P0），平台加价10%后44（P1），小B再加价10%后用户支付48.4（P2），平台利润4，小B利润4.4；退50%时分别退回供应商20，平台损失2，小B损失2.2
- 订单总退款金额 = 所有refundDetails的refundAmount之和（退款给用户的总金额）

**退款对结算的影响**：
- 已退款的晚数（nightStatus = refunded）不参与结算
- 结算时只计算已入住且已离店的晚数（nightStatus = checked_out）
- 结算金额 = 已入住晚数的利润之和（已自动排除退款晚数）

**退款对发票的影响**：
- 发票金额 = 订单金额（actualAmount）- 退款金额（refundAmount）
- 如果订单有退款，发票金额会相应减少
- 发票申请时，系统会检查订单退款状态

### 7.5 文件字段处理规则

**所有文件字段**:
- 表单提交前：File对象
- 表单提交后：转换为URL字符串（URL.createObjectURL）
- 存储到数据库：仅存储URL字符串
- 从数据库读取：直接使用URL字符串显示

**文件字段列表**:
- idPhotoFront, idPhotoBack（个人/博主身份证）
- legalRepIdPhotoFront, legalRepIdPhotoBack（法人身份证）
- businessLicense（营业执照）
- appScreenshots（应用截图数组）
- mainScreenshots（粉丝数据截图数组）
- existingBusinessScreenshots（业务截图数组）

---

## 八、对象关联关系总览

### 8.1 对象关联表

| 主对象 | 关联对象 | 关联类型 | 外键字段 | 说明 |
|-------|---------|---------|---------|------|
| Application | User | 外键关联 | userId | 申请关联用户（通过userId关联） |
| Partner | Application | 外键关联 | partnerApplicationId | 合作伙伴由申请审核通过后创建 |
| Partner | User | 外键关联 | userId | 合作伙伴通过userId关联用户（partnerEmail作为冗余字段用于显示） |
| Order | Hotel | 外键关联 | hotelId | 订单关联酒店 |
| Order | RoomType | 外键关联 | roomTypeId | 订单关联房型 |
| Order | Partner | 外键关联 | partnerId, partnerEmail | 订单关联小B合作伙伴 |
| Order | Customer | 外键关联 | customerId | 订单关联客户 |
| Order | Supplier | 外键关联 | supplierId | 订单关联供应商 |
| Invoice | Order | 外键关联 | orders[].invoiceOrderOrderId | 发票关联订单（一对多） |
| Invoice | User | 外键关联 | applicantUserId | 发票关联申请方用户（通过userId关联） |
| PartnerSettlementBatch | Partner | 外键关联 | partnerId | 小B结算批次关联合作伙伴 |
| PartnerSettlementBatch | Order | 外键关联 | orders[].batchOrderOrderId | 小B结算批次关联订单（一对多） |
| SupplierSettlementBatch | Supplier | 外键关联 | supplierId | 供应商结算批次关联供应商 |
| SupplierSettlementBatch | Order | 外键关联 | orders[].batchOrderOrderId | 供应商结算批次关联订单（一对多） |
| Withdrawal | User | 外键关联 | userId | 提现关联用户（通过userId关联） |
| ApiKey | User | 外键关联 | userId | API密钥关联用户（通过userId关联） |
| Transaction | User | 外键关联 | userId | 交易记录关联用户（通过userId关联，userEmail作为冗余字段） |
| SupplierCostReconciliation | Order | 外键关联 | orderId | 供应商成本对账关联订单 |
| ViolationFeeRecord | Order | 外键关联 | orderId | 违约扣费关联订单 |
| OrderTransaction | Order | 外键关联 | orderId | 订单交易记录关联订单 |
| OrderTransaction | Order.refundDetails | 外键关联 | refundId | 订单退款交易关联退款明细（当transactionType为order_refund时） |

### 8.2 冗余字段说明

**冗余字段的目的**：为了提升查询性能，避免频繁的JOIN操作，在Order、Invoice、SettlementBatch等对象中存储了关联对象的常用字段（如名称、邮箱等）。

**冗余字段的维护**：
- 创建时：从关联对象复制到冗余字段
- 更新时：关联对象更新后，需要同步更新所有相关冗余字段
- 查询时：可直接使用冗余字段，无需JOIN关联对象

**主要冗余字段**：
- Order.hotelName, Order.hotelAddress（来自Hotel）
- Order.roomTypeName（来自RoomType）
- Order.partnerName, Order.partnerType, Order.partnerBusinessModel, Order.partnerCanSetMarkupRate（来自Partner）
- Order.partnerCommissionRate（来自Partner.partnerDefaultCommissionRate，MCP/推广联盟用户的佣金比例）
- Order.customerName, Order.customerPhone（来自Customer）
- Order.supplierName（来自Supplier）
- Invoice.orders[].invoiceOrderHotelName（来自Order）
- Invoice.orders[].invoiceOrderAmount（来自Order.actualAmount，订单总金额）
- Invoice.orders[].invoiceOrderRefundAmount（来自Order.refundAmount）
- PartnerSettlementBatch.partnerName, partnerType（来自Partner）
- PartnerSettlementBatch.orders[].batchOrderSettledNights（从Order.nightDetails计算得出）
- PartnerSettlementBatch.orders[].batchOrderRefundedNights（从Order.nightDetails计算得出）
- SupplierSettlementBatch.supplierName（来自Supplier）
- SupplierSettlementBatch.orders[].batchOrderSettledNights（从Order.nightDetails计算得出）
- SupplierSettlementBatch.orders[].batchOrderRefundedNights（从Order.nightDetails计算得出）
- OrderTransaction.refundNights（来自Order.refundDetails[].refundNights，用于退款交易）
