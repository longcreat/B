# 财务中心 - 对账管理 PRD

## 1. 功能概述

对账管理是财务中心的核心模块，用于确保平台与供应商、支付渠道、合作伙伴之间的账目一致性，防止资金损失和财务风险。

什么是对账？
对账，本质上是**将两份或多份记录同一业务事件的数据集，进行交叉比对，以发现和解决差异的过程。** 在我们的平台中，它意味着：
*   我们收的钱，和支付渠道记录的一致吗？
*   我们付给供应商的钱，和他们发来的账单一致吗？
*   我们记在小B名下的利润，和实际订单数据计算出来的一致吗？

## 2. 对账类型

### 2.1 供应商成本对账（订单级对账，按每晚）
**目的：** 确保订单的供应商底价（P0）与供应商实际账单一致，防止因成本差异导致平台亏损。

**对账对象：**
- 平台订单的每晚订单底价P0（按每晚对账）
- 供应商提供的月度账单（包含每晚的账单金额）

**对账频率：** 每月对账（供应商提供月度账单后）

**对账状态：**
- `未对账`：订单成本尚未与供应商账单核对
- `对账中`：正在进行对账操作
- `已对账`：成本已确认，与供应商账单一致
- `对账差异`：成本存在差异，需要人工处理
- `已处理`：差异已处理完成

**关键字段：**
- 订单ID
- 入住日期（每晚对应一个对账记录）
- 供应商名称
- 每晚订单底价P0（系统记录）
- 供应商账单金额（对应每晚的账单金额）
- 差异金额
- 对账日期（YYYY-MM-DD，具体日期）
- 对账人

### 2.2 支付渠道对账（日度对账）
**目的：** 确保平台记录的订单收款与支付渠道（微信/支付宝/银行）实际收款一致。

**对账对象：**
- 平台订单收款流水（订单状态为已支付的订单金额）
- 支付渠道实际收款流水

**对账频率：** 每日自动对账（凌晨低峰期执行）

**对账状态：**
- `对账中`：系统正在自动对账
- `已对平`：平台流水与渠道流水一致
- `平台多`：平台记录金额 > 渠道实际金额（可能存在未到账）
- `渠道多`：渠道实际金额 > 平台记录金额（可能存在遗漏订单）
- `已处理`：差异已处理完成

**关键字段：**
- 对账日期（YYYY-MM-DD，年月日，每日对账）
- 支付渠道（微信/支付宝/银行）
- 平台订单金额
- 渠道实际金额
- 差异金额
- 差异订单数
- 对账状态

### 2.3 提现对账（月度对账）
**目的：** 确保打款给B端的金额与B端虚拟账本扣减金额一致。

**对账对象：**
- B端提现打款总流水（实际打款记录）
- B端虚拟账本扣减总额（账本记录）

**对账频率：** 每月自动对账

**对账状态：**
- `已对平`：打款金额 = 账本扣减金额
- `打款多`：打款金额 > 账本扣减金额
- `账本多`：账本扣减金额 > 打款金额
- `已处理`：差异已处理完成

**关键字段：**
- 对账月份（YYYY-MM，年月格式，月度对账）
- B端用户ID/名称
- 打款总金额
- 账本扣减总金额
- 差异金额
- 对账状态

### 2.4 开票对账（月度对账）
**目的：** 确保C端开票总额与各方成本/利润匹配，符合税务合规要求。

**对账对象：**
- C端开票总额
- 供应商开票总额 + B端开票总额 + 平台净利润

**对账频率：** 每月自动对账

**对账状态：**
- `已对平`：开票总额 = 成本/利润总额
- `开票多`：C端开票 > 成本/利润总额
- `成本多`：成本/利润总额 > C端开票
- `已处理`：差异已处理完成

**关键字段：**
- 对账月份（YYYY-MM，年月格式，月度对账）
- C端开票总额
- 供应商成本总额
- B端利润总额
- 平台利润总额
- 差异金额
- 对账状态

## 3. 功能模块

### 3.1 对账列表页面

**页面位置：** 财务中心 → 对账 → 对账管理

**功能：**
1. **列表展示**
   - 对账类型筛选（供应商成本对账/支付渠道对账/提现对账/开票对账）
   - 对账状态筛选
   - 时间范围筛选（对账日期）
   - 搜索功能（按订单ID、供应商名称、用户名称等）

2. **列表字段**
   - 对账类型
   - 对账对象（订单ID/日期/月份/B端用户）
   - 对账日期/月份（根据类型显示：供应商成本对账和支付渠道对账显示 YYYY-MM-DD，提现对账和开票对账显示 YYYY-MM）
   - 对账状态
   - 差异金额（如有）
   - 操作（查看详情/处理差异）

3. **批量操作**
   - 批量导出对账报告
   - 批量标记为已处理

**页面说明：**
- 显示所有对账记录（包括已对平、有差异、已处理等所有状态）
- 提供完整的筛选和搜索功能，方便查找特定记录
- 与"对账差异汇总"页面配合使用，差异汇总页面专门展示有差异的记录

### 3.2 供应商成本对账详情

**功能：**
1. **对账信息**
   - 订单基本信息（订单ID、酒店名称、入住/离店日期）
   - 供应商信息（供应商名称、供应商账单编号）
   - 价格信息（系统P0、供应商账单金额、差异金额）
   - 对账状态和时间（对账人、对账时间）

2. **操作**
   - 标记为已对账（无差异时）
   - 标记为对账差异（有差异时，需填写差异原因）
   - 处理差异（填写处理结果）

3. **批量对账**
   - 导入供应商账单（Excel/CSV）
   - 系统自动匹配订单并比对
   - 显示匹配结果和差异列表

### 3.3 支付渠道对账详情

**功能：**
1. **对账汇总**
   - 对账日期
   - 支付渠道
   - 平台订单总数和总金额
   - 渠道实际收款总数和总金额
   - 差异金额和差异订单数

2. **差异明细**
   - 平台多记录（平台有但渠道没有）
   - 渠道多记录（渠道有但平台没有）
   - 金额差异订单（双方都有但金额不一致）

3. **操作**
   - 导出对账报告
   - 标记为已处理
   - 重新对账

### 3.4 提现对账详情

**功能：**
1. **对账汇总**
   - 对账月份
   - B端用户信息
   - 打款总金额
   - 账本扣减总金额
   - 差异金额

2. **明细列表**
   - 打款记录（打款时间、金额、状态）
   - 账本扣减记录（扣减时间、金额、对应订单）

3. **操作**
   - 查看差异明细
   - 标记为已处理

### 3.5 开票对账详情

**功能：**
1. **对账汇总**
   - 对账月份
   - C端开票总额
   - 供应商成本总额
   - B端利润总额
   - 平台利润总额
   - 差异金额

2. **明细列表**
   - C端开票明细（发票ID、金额、开票时间）
   - 成本/利润明细（订单ID、金额、类型）

3. **操作**
   - 导出对账报告
   - 标记为已处理

### 3.6 对账差异汇总页面

**页面位置：** 财务中心 → 对账 → 对账差异汇总

**功能概述：**
对账差异汇总页面用于集中展示所有存在差异的对账记录，帮助财务人员快速了解整体差异情况，并进行统一处理和跟踪。

**功能：**
1. **统计卡片**
   - **差异总数**：显示所有有差异的对账记录数量（笔）
   - **差异总金额**：显示所有差异金额的绝对值总和（元）
   - **待处理数**：显示未处理的差异记录数量（笔）
   - **已处理数**：显示已处理的差异记录数量（笔）

2. **按类型汇总**
   - 按四种对账类型分别统计差异情况：
     - **供应商成本对账**：差异数量和差异金额
     - **支付渠道对账**：差异数量和差异金额
     - **提现对账**：差异数量和差异金额
     - **开票对账**：差异数量和差异金额
   - 每个类型显示两个指标：
     - 差异数量（笔）
     - 差异金额（元，红色高亮）

3. **筛选和搜索**
   - **搜索功能**：
     - 支持按订单ID、供应商名称、用户名称等关键词搜索
     - 搜索范围涵盖所有对账类型
   - **筛选条件**：
     - 对账类型筛选（全部/供应商成本对账/支付渠道对账/提现对账/开票对账）
     - 时间范围筛选（开始日期/结束日期）
   - **导出功能**：
     - 导出差异报告（Excel/PDF格式）
     - 包含所有筛选后的差异记录明细

4. **差异记录列表**
   - **显示规则**：仅显示存在差异的对账记录
   - **差异判定标准**：
     - 供应商成本对账：状态为 `对账差异`
     - 支付渠道对账：状态为 `平台多` 或 `渠道多`
     - 提现对账：状态为 `打款多` 或 `账本多`
     - 开票对账：状态为 `开票多` 或 `成本多`
   - **列表字段**：
     - 对账类型（供应商成本对账/支付渠道对账/提现对账/开票对账）
     - 对账对象（订单ID/日期/月份/B端用户，根据类型显示）
     - 对账日期/月份（供应商成本和支付渠道显示 YYYY-MM-DD，提现和开票显示 YYYY-MM）
     - 状态（显示具体的差异状态，如"对账差异"、"平台多"、"渠道多"等）
     - 差异金额（显示差异金额，正数显示"+"，负数显示"-"，红色高亮）
     - 操作（查看详情按钮）
   - **交互功能**：
     - 点击"查看详情"跳转到对账详情页面
     - 支持分页显示（每页10条）
     - 操作列冻结（与列表页一致）

5. **数据统计逻辑**
   - **差异总数**：统计所有符合差异判定标准的记录数量
   - **差异总金额**：计算所有差异金额的绝对值总和（用于显示差异的总体规模）
   - **待处理数**：统计状态为差异状态（非"已处理"）的记录数量
   - **已处理数**：统计状态为"已处理"的记录数量
   - **按类型统计**：分别统计四种对账类型的差异数量和差异金额

6. **与对账管理页面的关系**
   - **对账管理页面**：显示所有对账记录（包括已对平、有差异、已处理等所有状态）
   - **对账差异汇总页面**：仅显示有差异的记录，便于财务人员重点关注和处理差异
   - 两个页面可以相互跳转，从汇总页面可以查看详情，详情页面支持返回汇总页面

## 4. 数据字段设计

### 4.1 供应商成本对账记录
- 对账记录ID
- 订单ID
- 供应商名称
- 供应商账单编号（可选）
- 系统记录的P0（每晚订单底价P0）
- 供应商账单金额
- 差异金额（供应商账单金额 - 系统P0）
- 对账状态（未对账/对账中/已对账/对账差异/已处理）
- 对账日期
- 对账人
- 差异原因（如有差异）
- 处理结果（如已处理）
- 处理时间
- 处理人

### 4.2 支付渠道对账记录
- 对账记录ID
- 对账日期（YYYY-MM-DD）
- 支付渠道（微信/支付宝/银行）
- 平台订单总数
- 平台订单总金额（订单实付总金额）
- 渠道订单总数
- 渠道实际总金额
- 差异金额
- 差异订单数
- 对账状态（对账中/已对平/平台多/渠道多/已处理）
- 对账时间
- 处理时间
- 处理人
- 差异明细（关联订单列表，如有差异）

### 4.3 提现对账记录
- 对账记录ID
- 对账月份（YYYY-MM）
- B端用户ID
- B端用户名称
- 打款总金额（实际打款总额）
- 账本扣减总金额
- 差异金额
- 对账状态（已对平/打款多/账本多/已处理）
- 对账时间
- 处理时间
- 处理人
- 打款明细（打款记录列表）
- 账本扣减明细（扣减记录列表）

### 4.4 开票对账记录
- 对账记录ID
- 对账月份（YYYY-MM）
- C端开票总额
- 供应商成本总额（订单总底价P0）
- B端利润总额
- 平台利润总额（订单总分销价P1 - 订单总底价P0）
- 成本+利润总额
- 差异金额
- 对账状态（已对平/开票多/成本多/已处理）
- 对账时间
- 处理时间
- 处理人

## 5. 详细对账逻辑

### 5.1 供应商成本对账详细逻辑

#### 5.1.1 触发时机
- **手动触发**：财务人员收到供应商月度账单后，在系统中导入账单文件
- **自动触发**：系统检测到有新账单文件上传时，自动启动对账流程

#### 5.1.2 数据来源
- **平台数据**：订单表中的每晚订单底价P0字段，订单状态为 `已完成` 或 `已完成(可结算)` 的订单，按每晚进行对账
- **供应商账单**：财务人员导入的Excel/CSV文件，包含字段：
  - 订单ID（或订单编号）
  - 入住日期（用于匹配每晚的账单）
  - 供应商账单编号
  - 账单金额（对应每晚的账单金额）
  - 可选：酒店名称、离店日期（用于辅助匹配）

#### 5.1.3 匹配规则
1. **主匹配规则**：按订单ID + 入住日期精确匹配
   - 供应商账单中的订单ID和入住日期必须与平台订单的订单ID和入住日期完全一致
   - 按每晚进行匹配，一个订单的多晚需要分别匹配
   
2. **辅助匹配规则**（当订单ID无法匹配时）：
   - 酒店名称 + 入住日期（需两者完全一致）
   - 供应商名称 + 入住日期 + 订单金额（需在误差范围内，如±1元）

3. **匹配优先级**：
   - 第一优先级：订单ID + 入住日期精确匹配
   - 第二优先级：酒店名称 + 入住日期匹配
   - 第三优先级：供应商名称 + 入住日期 + 金额匹配

#### 5.1.4 对账计算逻辑
```
对账差异金额 = 供应商账单金额（每晚） - 系统P0（每晚订单底价P0）

判断规则：
- 如果 |差异金额| < 0.01元（分币精度），则认为已对平，状态 = "已对账"
- 如果 |差异金额| >= 0.01元，则认为有差异，状态 = "对账差异"

说明：按每晚进行对账，每个订单的每一晚都需要单独对账，确保每晚的成本准确性。
```

#### 5.1.5 对账结果分类
1. **已匹配且金额一致**：
   - 状态：`已对账`
   - 操作：系统自动标记，无需人工干预

2. **已匹配但金额不一致**：
   - 状态：`对账差异`
   - 差异金额：供应商账单金额 - 系统P0
   - 操作：财务人员需：
     - 查看订单详情，确认系统P0是否正确
     - 联系供应商核对账单明细
     - 填写差异原因（如：附加服务费、税费、临时调价等）
     - 处理差异（更新系统P0或确认供应商账单）

3. **未匹配的订单**：
   - 状态：`未对账`
   - 原因：供应商账单中无此订单，或订单信息不一致
   - 操作：财务人员需人工核对：
     - 确认订单是否属于该供应商
     - 确认订单是否在账单周期内
     - 确认是否供应商遗漏

4. **未匹配的账单记录**：
   - 状态：`待核实`
   - 原因：平台系统中无对应订单
   - 操作：财务人员需核实：
     - 是否为供应商账单错误
     - 是否为平台遗漏订单
     - 是否需要补充订单记录

#### 5.1.6 差异处理流程
1. 财务人员查看差异详情，点击"处理差异"
2. 填写处理结果，说明：
   - 差异原因（如：供应商账单包含附加费用）
   - 处理方式（如：已与供应商确认，补充记录）
   - 是否需要更新系统P0
3. 系统记录处理人和处理时间
4. 状态更新为"已处理"
5. 如果处理结果涉及更新P0，系统自动更新订单P0并重新计算利润

### 5.2 支付渠道对账详细逻辑

#### 5.2.1 触发时机
- **自动触发**：每日凌晨2:00（可配置）自动执行前一日对账
- **手动触发**：财务人员可手动触发指定日期的对账

#### 5.2.2 数据来源
- **平台订单流水**：
  - 订单状态：`已完成` 且 `已支付`
  - 支付渠道：微信/支付宝/银行
  - 支付时间：对账日期当日（00:00:00 - 23:59:59）
  - 订单金额：订单实际支付金额（P2）
  
- **支付渠道流水**：
  - 从支付渠道API获取（微信/支付宝/银行）
  - 或从对账文件导入（如：银行对账文件）
  - 包含字段：订单号、支付金额、支付时间、手续费等

#### 5.2.3 匹配规则
1. **订单号匹配**：平台订单ID与渠道订单号匹配
2. **金额匹配**：允许±0.01元误差（处理分币精度问题）
3. **时间匹配**：支付时间在对账日期范围内

#### 5.2.4 对账计算逻辑
```
平台订单总金额 = SUM(平台订单流水中的订单金额)
渠道实际总金额 = SUM(渠道流水中的订单金额)
差异金额 = 平台订单总金额 - 渠道实际总金额

平台订单总数 = COUNT(平台订单流水)
渠道订单总数 = COUNT(渠道流水)
差异订单数 = |平台订单总数 - 渠道订单总数|
```

#### 5.2.5 差异类型分类
1. **平台独有订单**（`platform_only`）：
   - 定义：平台有订单记录，但渠道无对应收款记录
   - 可能原因：
     - 订单支付失败但平台状态未更新
     - 支付渠道延迟，资金未到账
     - 订单被退款但平台未同步
   - 处理建议：
     - 检查订单支付状态，确认是否实际支付成功
     - 联系支付渠道确认是否延迟到账
     - 如确认未支付，更新订单状态为"支付失败"

2. **渠道独有订单**（`channel_only`）：
   - 定义：渠道有收款记录，但平台无对应订单记录
   - 可能原因：
     - 平台遗漏订单记录
     - 订单号不匹配（渠道订单号与平台订单ID不一致）
     - 测试订单或异常订单
   - 处理建议：
     - 检查渠道订单号，尝试匹配平台订单
     - 如无法匹配，联系技术部门补充订单记录
     - 如为测试订单，标记忽略

3. **金额差异订单**（`amount_diff`）：
   - 定义：双方都有订单，但金额不一致
   - 差异金额 = 平台订单金额 - 渠道实际金额
   - 可能原因：
     - 支付渠道手续费（渠道金额 = 平台金额 - 手续费）
     - 部分退款（渠道金额 < 平台金额）
     - 优惠券或折扣（平台已扣除，渠道未扣除）
     - 数据精度问题
   - 处理建议：
     - 核对订单详情，确认是否有退款、优惠等
     - 计算手续费是否一致
     - 如差异在合理范围内（如手续费），可标记为已处理

#### 5.2.6 差异判定规则
```
如果 差异金额 = 0 且 差异订单数 = 0：
    状态 = "已对平"
    
如果 差异金额 != 0 或 差异订单数 != 0：
    状态 = "对账差异"
    生成差异订单明细列表
```

#### 5.2.7 对账结果处理
1. 系统自动生成对账报告
2. 如有差异，发送通知给财务人员（邮件/站内消息）
3. 财务人员查看差异明细，逐一处理差异订单
4. 处理完成后，标记为"已处理"

### 5.3 提现对账详细逻辑

#### 5.3.1 触发时机
- **自动触发**：每月1日 00:00 自动执行上月的对账
- **手动触发**：财务人员可手动触发指定月份的对账

#### 5.3.2 数据来源
- **提现打款记录**：
  - 来源：提现管理系统的打款流水
  - 条件：
    - 提现状态：`提现成功`
    - 转账时间：在指定月份范围内
    - B端用户：指定用户（按用户维度对账）
  - 字段：提现ID、用户ID、打款金额、转账时间、收款账户等
  
- **账本扣减记录**：
  - 来源：B端虚拟账本的扣减记录
  - 条件：
    - 订单状态：`已完成(可结算)` 且已结算
    - 结算时间：在指定月份范围内
    - B端用户：指定用户
  - 字段：订单ID、用户ID、扣减金额、扣减时间、订单状态等

#### 5.3.3 对账计算逻辑
```
提现打款总额 = SUM(提现打款记录中的打款金额)
账本扣减总额 = SUM(账本扣减记录中的扣减金额)
差异金额 = 提现打款总额 - 账本扣减总额

判断规则：
- 如果 |差异金额| < 0.01元，则认为已对平，状态 = "已对平"
- 如果 差异金额 > 0.01元，则 打款多，状态 = "打款多"
- 如果 差异金额 < -0.01元，则 账本多，状态 = "账本多"
```

#### 5.3.4 差异类型说明
1. **打款多**（`withdrawal_more`）：
   - 定义：实际打款金额 > 账本扣减金额
   - 可能原因：
     - 多打款（财务操作错误）
     - 账本扣减记录遗漏
     - 提现记录包含非订单相关的打款（如退款、补偿等）
   - 处理建议：
     - 核对每笔打款记录，确认是否都有对应的账本扣减
     - 检查是否有遗漏的订单结算记录
     - 确认是否有非订单相关的打款

2. **账本多**（`account_more`）：
   - 定义：账本扣减金额 > 实际打款金额
   - 可能原因：
     - 账本扣减但未打款（提现失败但未回退）
     - 打款记录遗漏
     - 订单结算但用户未提现
   - 处理建议：
     - 核对每笔账本扣减，确认是否都有对应的打款记录
     - 检查是否有提现失败的记录需要回退账本
     - 确认是否有已结算但未提现的订单

#### 5.3.5 明细追溯
当出现差异时，系统提供明细列表：
- **打款记录列表**：显示所有打款流水，包括提现ID、金额、时间、状态
- **账本扣减记录列表**：显示所有扣减记录，包括订单ID、金额、扣减时间、订单状态
- 财务人员可逐笔核对，找出差异原因

### 5.4 开票对账详细逻辑

#### 5.4.1 触发时机
- **自动触发**：每月1日 00:00 自动执行上月的对账
- **手动触发**：财务人员可手动触发指定月份的对账

#### 5.4.2 数据来源
- **C端开票总额**：
  - 来源：发票管理系统的开票记录
  - 条件：
    - 发票状态：`开票成功`
    - 开票时间：在指定月份范围内
    - 发票类型：C端用户申请的发票
  - 字段：发票ID、开票金额、开票时间、发票状态等

- **成本/利润总额**：
  - 来源：订单结算记录
  - 条件：
    - 订单状态：`已完成(可结算)` 且已结算
    - 结算时间：在指定月份范围内
  - 计算：
    - 供应商成本总额 = SUM(订单P0)
    - B端利润总额 = SUM(订单B端利润)
    - 平台利润总额 = SUM(订单平台利润)
    - 成本+利润总额 = 供应商成本总额 + B端利润总额 + 平台利润总额

#### 5.4.3 对账计算逻辑
```
C端开票总额 = SUM(发票管理系统中C端开票金额)
供应商成本总额 = SUM(订单P0)
B端利润总额 = SUM(订单B端利润)
平台利润总额 = SUM(订单平台利润)
成本+利润总额 = 供应商成本总额 + B端利润总额 + 平台利润总额

差异金额 = C端开票总额 - 成本+利润总额

判断规则：
- 如果 |差异金额| < 0.01元，则认为已对平，状态 = "已对平"
- 如果 差异金额 > 0.01元，则 开票多，状态 = "开票多"
- 如果 差异金额 < -0.01元，则 成本多，状态 = "成本多"
```

#### 5.4.4 差异类型说明
1. **开票多**（`invoice_more`）：
   - 定义：C端开票总额 > 成本+利润总额
   - 可能原因：
     - 开票金额包含税费（如增值税），但成本/利润计算未包含
     - 开票记录包含重复开票
     - 开票记录包含非订单相关的发票（如服务费、补偿等）
   - 处理建议：
     - 确认开票金额是否包含税费
     - 检查是否有重复开票记录
     - 核对发票明细，确认是否都是订单相关

2. **成本多**（`cost_more`）：
   - 定义：成本+利润总额 > C端开票总额
   - 可能原因：
     - 订单已结算但未开票（C端用户未申请发票）
     - 成本/利润计算错误
     - 开票记录遗漏
   - 处理建议：
     - 确认是否有已结算但未开票的订单（这是正常的）
     - 检查成本/利润计算是否正确
     - 核对开票记录是否有遗漏

#### 5.4.5 明细追溯
当出现差异时，系统提供明细列表：
- **C端开票明细**：显示所有发票记录，包括发票ID、金额、开票时间、状态
- **成本/利润明细**：显示所有订单的成本/利润记录，包括订单ID、金额、类型（供应商成本/B端利润/平台利润）、订单时间
- 财务人员可逐笔核对，找出差异原因

### 5.5 对账精度处理

所有对账计算统一使用以下精度规则：
- **金额精度**：保留2位小数（元.分）
- **差异判定阈值**：±0.01元（1分币）
- **计算方式**：使用四舍五入，避免浮点数精度问题

### 5.6 异常情况处理

#### 5.6.1 数据缺失
- **场景**：对账所需数据不完整
- **处理**：
  - 系统记录缺失数据项
  - 对账报告标记为"数据不完整"
  - 通知相关人员补充数据

#### 5.6.2 匹配失败
- **场景**：无法匹配订单或记录
- **处理**：
  - 系统记录未匹配项
  - 对账报告列出所有未匹配项
  - 财务人员人工核对

#### 5.6.3 对账失败
- **场景**：对账过程异常中断
- **处理**：
  - 系统记录失败原因
  - 财务人员可手动重新触发对账
  - 如仍失败，需联系技术支持处理

### 5.7 对账报告生成

每次对账完成后，系统自动生成对账报告，包含：
1. **汇总信息**：对账类型、对账日期/月份、对账状态、差异金额
2. **明细信息**：差异订单/记录列表（如有）
3. **处理建议**：针对差异类型的处理建议
4. **导出功能**：支持导出Excel/PDF格式

## 6. 交互流程

### 6.1 供应商成本对账流程
1. 财务人员收到供应商月度账单
2. 在系统中导入账单文件（Excel/CSV，需包含订单ID和入住日期，按每晚记录）
3. 系统自动匹配订单（按订单ID + 入住日期精确匹配，按每晚进行匹配）
4. 系统自动比对每晚订单底价P0与供应商账单金额（按每晚比对）
5. 显示对账结果：
   - 已匹配且金额一致的订单（每晚）：自动标记为"已对账"
   - 已匹配但金额不一致（每晚）：标记为"对账差异"，需人工处理
   - 未匹配的订单（每晚）：标记为"未对账"，需人工核对
   - 未匹配的账单记录：标记为"待核实"，需财务人员核实
6. 财务人员查看差异详情，填写差异原因和处理结果
7. 对账完成

### 6.2 支付渠道对账流程（自动）
1. 系统每日凌晨自动执行对账（可手动触发）
2. 获取前一日支付渠道收款流水（从支付渠道API获取或导入对账文件）
3. 与平台订单收款流水进行比对（按订单号匹配，允许±0.01元误差）
4. 生成对账报告
5. 如有差异，发送通知给财务人员（邮件/站内消息）
6. 财务人员查看差异明细（平台多记录、渠道多记录、金额差异订单），逐一处理差异订单
7. 处理完成后，标记为"已处理"

### 6.3 提现对账流程（自动）
1. 系统每月初自动执行上月对账
2. 汇总上月所有B端提现打款记录
3. 汇总上月所有B端账本扣减记录
4. 比对金额是否一致
5. 生成对账报告
6. 如有差异，发送通知给财务人员
7. 财务人员查看明细，核对差异原因
8. 处理完成后，标记为"已处理"

### 6.4 开票对账流程（自动）
1. 系统每月初自动执行上月对账
2. 汇总上月C端开票总额
3. 汇总上月供应商成本、B端利润、平台利润
4. 比对是否一致
5. 生成对账报告
6. 如有差异，发送通知给财务人员
7. 财务人员查看明细，核对差异原因
8. 处理完成后，标记为"已处理"

## 7. 权限和通知

### 7.1 权限控制
- **查看对账列表**：财务人员、财务主管
- **执行对账操作**：
  - 供应商成本对账：财务人员（需手动导入账单）
  - 支付渠道对账：系统自动（财务人员可手动触发）
  - 提现对账：系统自动（财务人员可手动触发）
  - 开票对账：系统自动（财务人员可手动触发）
- **处理差异**：财务人员、财务主管
- **导出报告**：财务人员、财务主管

### 7.2 通知机制
- **对账差异通知**：
  - 触发条件：对账完成后发现差异
  - 通知方式：邮件 + 站内消息
  - 通知对象：财务人员、财务主管
  - 通知内容：对账类型、对账日期/月份、差异金额、差异明细链接

- **对账完成通知**：
  - 触发条件：自动对账完成（无论是否有差异）
  - 通知方式：站内消息
  - 通知对象：财务人员
  - 通知内容：对账类型、对账日期/月份、对账状态、查看报告链接

### 7.3 差异阈值配置
- **可配置项**：差异金额阈值（默认：100元）
- **作用**：超过阈值的差异，发送紧急通知
- **配置位置**：财务中心 → 系统配置

## 8. 需要确认的问题

为了完善对账功能设计，需要您提供以下信息：

1. **供应商成本对账：**
   - 供应商账单的格式是什么？（Excel/CSV/API接口）
   - 账单中包含哪些字段？（订单ID、酒店名称、日期、金额等）
   - 对账频率是每月一次吗？
   - 差异处理流程是什么？（是否需要供应商确认？）

2. **支付渠道对账：**
   - 支付渠道是否提供API接口获取收款流水？
   - 还是需要手动导入对账文件？
   - 对账时间范围是T+1（对前一日）还是实时？

3. **提现对账：**
   - 提现打款是通过什么渠道？（银行API/第三方支付平台）
   - 是否有打款流水API接口？
   - 对账粒度是到每个B端用户还是汇总？

4. **开票对账：**
   - 开票数据来源是什么？（发票管理系统/财务系统）
   - 是否需要区分不同类型的发票？（电子发票/纸质发票）
   - 对账是否需要考虑税费？

5. **权限和角色：**
   - 谁可以执行对账操作？（财务人员/财务主管）
   - 谁可以处理差异？（财务人员/财务主管/需要审批？）
   - 是否需要对账审批流程？

6. **通知和提醒：**
   - 对账差异是否需要发送通知？（邮件/站内消息）
   - 是否需要设置差异阈值？（超过多少金额才发送通知）

