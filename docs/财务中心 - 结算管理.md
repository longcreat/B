# 财务中心 - 结算管理 PRD

| 版本 | 日期       | 作者       | 变更内容     |
| :--- | :--------- | :--------- | :----------- |
| V1.0 | 2025-01-XX | [产品经理] | 初始版本创建 |

## 1. 产品概述

### 1.1 业务背景

结算管理是财务中心的核心模块，负责处理平台与上下游合作伙伴的资金结算，支持灵活的结算模式以满足不同业务场景需求。

### 1.3 结算对象

1. **大B客户**：SaaS/MCP/AIGO自营等业务模式的大B主体
2. **供应商**：酒店供应商等上游合作伙伴

### 1.4 结算模式

#### 1.4.1 大B结算模式

- **按单结算**：订单满足结算条件后立即结算，无需等待周期
- **周期结算**：按设定周期（周/月）生成结算批次，批量处理

#### 1.4.2 供应商结算模式

- **周期结算**：按月生成结算批次（暂不支持按单结算）

## 2. 核心功能

### 2.1 结算批次管理

#### 大B结算批次

**功能概述**：
- 展示周期结算模式下的大B结算批次
- 支持批次审批、资金计入、状态跟踪
- 提供批量操作和数据导出

**核心操作**：
- 查看批次列表和详情
- 审批待审核批次（通过/驳回）
- 将已批准批次计入大B账户
- 导出批次数据和明细

#### 供应商结算批次

**功能概述**：
- 展示供应商结算批次
- 支持批次审批、打款操作、状态跟踪
- 提供批量操作和数据导出

**核心操作**：
- 查看批次列表和详情
- 审批待审核批次（通过/驳回）
- 执行供应商打款
- 导出批次数据和明细

### 2.2 按单结算

**功能概述**：
- 当大B选择按单结算模式时启用
- 订单满足结算条件后可直接进行结算
- 无需生成批次，简化结算流程

**核心操作**：
- 在订单详情页或订单列表页直接结算
- 选择单个或批量订单进行结算
- 实时更新账户余额和结算状态

### 2.3 结算配置

**功能概述**：
- 配置不同结算对象的结算参数
- 支持结算模式的灵活切换
- 记录配置变更历史

**配置项**：

**大B结算配置**：
- 结算模式：按单结算/周期结算
- 结算周期类型：每周/每月/自定义（仅周期结算）
- 结算周期：具体周期设置（仅周期结算）
- 结算冻结期：订单离店后冻结天数
- 自动化设置：自动生成批次/自动审批/自动计入账户

**供应商结算配置**：
- 结算周期类型：每月/每季度/自定义
- 结算周期：具体周期设置
- 结算冻结期：订单离店后冻结天数
- 自动化设置：自动生成批次/自动审批/自动打款

## 3. 业务流程

### 3.1 周期结算流程

```
订单完成 → 结算冻结期 → 可结算状态 → 生成结算批次 → 财务审核 → 资金结算
```

**关键节点**：
1. **订单完成**：服务已完成，满足结算条件
2. **冻结期**：防止争议和风险，默认7-15天
3. **批次生成**：系统按周期自动生成结算批次
4. **财务审核**：人工审核批次准确性
5. **资金结算**：将资金计入账户或执行打款

### 3.2 按单结算流程

```
订单完成 → 结算冻结期 → 可结算状态 → 直接结算 → 资金到账
```

**关键节点**：
1. **订单完成**：服务已完成，满足结算条件
2. **冻结期**：防止争议和风险，默认7天
3. **直接结算**：无需批次，直接将资金计入大B账户
4. **资金到账**：实时更新账户余额

## 4. 用户体验

### 4.1 界面设计原则

- **信息层次清晰**：核心信息在前，操作便捷
- **状态明确**：用颜色和图标区分不同结算状态
- **批量操作友好**：支持多选和批量处理
- **数据可视化**：提供统计图表和趋势分析

### 4.2 关键状态说明

#### 结算状态
- **待结算**：订单已完成，等待结算条件
- **可结算**：满足所有结算条件，可以结算
- **待审核**：批次已生成，等待财务审核
- **已批准**：审核通过，可以执行结算
- **已结算**：资金已成功结算
- **已驳回**：审核未通过，需要重新处理

#### 订单结算状态
- **未结算**：订单尚未进入结算流程
- **结算中**：订单正在结算处理中
- **已结算**：订单结算完成
- **结算失败**：订单结算出现异常

## 5. 业务规则

### 5.1 结算条件

订单进入结算必须同时满足：
1. 服务已完成（离店日期已过）
2. 结算冻结期已过
3. 无未决争议或异常状态
4. 供应商成本已对账确认
5. 结算对象账户状态正常

### 5.2 结算金额计算

- **大B结算金额** = 订单总金额P2 - 退款金额 - (分销价P1 - 退款对应P1) - 佣金 - 大B出资优惠
- **供应商结算金额** = 订单总底价P0 - 退款对应成本

### 5.3 权限控制

- **管理员**：查看所有结算记录，执行所有操作
- **财务人员**：审核结算批次，执行资金操作
- **运营人员**：查看结算状态，处理异常情况
- **大B客户**：查看自己的结算记录

## 6. 数据统计

### 6.1 统计指标

- 结算批次数量和金额统计
- 按时间周期的结算趋势分析
- 结算成功率和失败率统计
- 各结算对象的结算情况汇总

### 6.2 报表导出

- 支持自定义时间范围的结算数据导出
- 提供Excel格式的详细结算明细
- 支持按不同维度筛选和导出
# 财务中心 - 结算管理页面设计

## 7. 页面设计

### 7.1 客户结算批次列表页

#### 7.1.1 页面结构

**面包屑导航**：
```
财务中心 > 结算管理 > 客户结算批次
```

**页面组成**：
1. 统计信息卡片
2. 搜索和筛选区域
3. 批次列表表格
4. 批量操作工具栏
5. 分页组件

#### 7.1.2 统计信息

展示当前筛选条件下的汇总数据：
- **结算总金额**：所有记录的结算金额汇总
- **结算笔数**：符合条件的结算记录数量
- **待结算金额**：状态为“待结算”的记录结算金额汇总
- **已结算金额**：状态为“已结算”的记录结算金额汇总
- **今日结算金额**：当天完成结算的金额汇总

#### 7.1.3 搜索和筛选

**搜索框**：
- 支持按批次ID、客户名称搜索
- 实时搜索，输入即过滤

**筛选条件**：
- **结算状态**：全部/待结算/可结算/已结算/已取消
- **业务模式**：全部/SaaS/MCP
- **结算金额区间**：最小金额 - 最大金额
- **结算时间**：开始日期 - 结束日期

#### 7.1.4 列表字段

| 字段名称 | 说明 | 宽度 | 对齐 |
|---------|------|------|------|
| 结算记录ID | 结算记录唯一标识 | 150px | 左 |
| 订单号 | 对应订单编号 | 150px | 左 |
| 大B名称 | 结算对象名称 | 180px | 左 |
| 业务模式 | SaaS/MCP | 120px | 左 |
| 订单金额 | 订单实付金额（含税） | 120px | 右 |
| 退款金额 | 已发生的退款金额 | 120px | 右 |
| 结算金额 | 本次结算金额 | 120px | 右 |
| 结算状态 | 待结算/可结算/已结算/已取消 | 120px | 中 |
| 结算时间 | 完成结算的时间戳 | 160px | 左 |
| 操作 | 查看详情 | 120px | 中 |

#### 7.1.5 结算状态

- **待结算**：黄色标签，记录已生成等待结算条件满足
- **可结算**：蓝色标签，满足结算条件，等待触发结算
- **已结算**：绿色标签，结算金额已入账
- **已取消**：灰色标签，结算记录因退款或异常被取消

#### 7.1.6 操作按钮

- **查看详情**：进入结算详情页查看具体计算过程和操作记录

---

### 7.2 客户结算批次详情页

#### 7.2.1 页面结构

**面包屑导航**：
```
财务中心 > 结算管理 > 客户结算明细 > 详情
```

**页面组成**：
1. 结算基本信息卡片
2. 客户信息卡片
3. 订单信息卡片
4. 结算计算明细卡片
5. 操作历史记录
6. 操作按钮区域

#### 7.2.2 结算基本信息

**字段列表**：
- **结算记录ID**：唯一标识
- **订单号**：关联订单编号
- **结算状态**：状态Badge（待结算/可结算/已结算/已取消）
- **结算时间**：完成结算的时间
- **结算金额**：本次结算金额

#### 7.2.3 客户信息

**字段列表**：
- **大B名称**：结算对象名称
- **业务模式**：SaaS/MCP
- **联系方式**：运营维护的联系手机

#### 7.2.4 订单信息

**字段列表**：
- **订单状态**：默认展示“已完成”
- **订单金额**：订单实付金额
- **退款金额**：已退款金额（无退款时显示“-”）
- **订单创建时间**：订单生成时间
- **订单完成时间**：订单完成（离店）时间

#### 7.2.5 结算计算明细

展示结算金额的组成：
- **收入项目**：订单金额
- **扣减项目**：
  - 退款金额（如有）
  - 平台分销价（自动扣减退款对应金额）
  - 小B佣金（自动扣减退款对应佣金）
  - 大B出资优惠
- **结算金额**：按照“收入 - 扣减”计算的最终金额

页面以卡片形式展示各项金额，并在扣减项目下方给出小计，帮助财务快速核对。

#### 7.2.6 操作历史记录

记录结算记录的关键节点：
- 操作时间
- 操作人（系统/财务）
- 操作类型（创建结算记录/完成结算等）
- 操作说明

#### 7.2.7 操作按钮

- **返回列表**：返回客户结算列表
- **导出结算单**：导出当前结算记录
- **查看订单详情**：跳转至订单详情页

---

### 7.3 供应商结算批次列表页

#### 7.3.1 页面结构

**面包屑导航**：
```
财务中心 > 结算管理 > 供应商结算批次
```

**页面组成**：
1. 统计信息卡片
2. 搜索和筛选区域
3. 批次列表表格
4. 批量操作工具栏
5. 分页组件

#### 7.3.2 统计信息

展示当前筛选条件下的汇总数据：
- **批次总数**：符合条件的批次数量
- **结算总金额**：所有批次的结算金额汇总
- **待审核批次数**：状态为"待审核"的批次数量
- **待审核金额**：待审核批次的金额汇总
- **待打款批次数**：状态为"已批准"的批次数量
- **待打款金额**：待打款批次的金额汇总
- **本月结算金额**：当月已打款的金额汇总

#### 7.3.3 搜索和筛选

**搜索框**：
- 支持按批次ID、供应商名称搜索
- 实时搜索，输入即过滤

**筛选条件**：
- **批次状态**：全部/待审核/已批准/已打款/已驳回
- **结算周期**：开始日期 - 结束日期
- **创建时间**：开始日期 - 结束日期
- **结算金额**：最小金额 - 最大金额

#### 7.3.4 列表字段

| 字段名称 | 说明 | 宽度 | 对齐 |
|---------|------|------|------|
| 批次ID | 结算批次唯一标识 | 150px | 左 |
| 供应商名称 | 供应商名称 | 180px | 左 |
| 结算周期 | 开始日期 ~ 结束日期 | 200px | 左 |
| 订单数量 | 批次包含的订单数 | 100px | 右 |
| 订单成本总额 | 订单P0金额汇总 | 120px | 右 |
| 退款成本 | 退款对应的P0金额 | 120px | 右 |
| 结算金额 | 应付供应商的金额 | 120px | 右 |
| 批次状态 | 待审核/已批准/已打款/已驳回 | 100px | 中 |
| 创建时间 | 批次生成时间 | 160px | 左 |
| 操作 | 查看详情/审批/打款/导出 | 180px | 中 |

#### 7.3.5 批次状态

- **待审核**：黄色标签，批次已生成等待审核
- **已批准**：蓝色标签，审核通过等待打款
- **已打款**：绿色标签，资金已打款给供应商
- **已驳回**：红色标签，审核未通过

#### 7.3.6 操作按钮

**单条操作**：
- **查看详情**：查看批次详细信息和订单明细
- **审批**（待审核状态）：通过/驳回批次
- **执行打款**（已批准状态）：记录打款信息
- **导出**：导出批次数据和订单明细

**批量操作**：
- **批量审批**：批量通过/驳回选中的待审核批次
- **批量打款**：批量记录选中批次的打款信息
- **批量导出**：导出选中批次的数据

---

### 7.4 供应商结算批次详情页

#### 7.4.1 页面结构

**面包屑导航**：
```
财务中心 > 结算管理 > 供应商结算批次 > 详情
```

**页面组成**：
1. 批次基本信息卡片
2. 供应商信息卡片
3. 结算汇总信息卡片
4. 订单明细列表
5. 打款记录（如有）
6. 操作历史记录
7. 操作按钮区域

#### 7.4.2 批次基本信息

**字段列表**：
- **批次ID**：唯一标识
- **批次状态**：状态Badge
- **结算周期**：开始日期 ~ 结束日期
- **创建时间**：批次生成时间
- **审核时间**：审核操作时间（如有）
- **打款时间**：打款完成时间（如有）
- **审核人**：审核操作人（如有）
- **审核意见**：审核备注（如有）

#### 7.4.3 供应商信息

**字段列表**：
- **供应商名称**：供应商名称
- **供应商ID**：供应商唯一标识
- **供应商类型**：酒店/民宿/其他
- **联系方式**：供应商联系电话/邮箱
- **结算账户**：供应商收款账户信息

#### 7.4.4 结算汇总信息

**金额统计**：
- **订单数量**：批次包含的订单总数
- **订单成本总额（P0）**：所有订单的P0汇总
- **退款成本**：退款订单对应的P0金额
- **结算金额**：= P0 - 退款成本

**计算公式展示**：
```
结算金额 = 订单成本总额 - 退款成本
```

#### 7.4.5 订单明细列表

**列表字段**：
- 订单号
- 订单状态
- 客户名称
- 入住日期
- 离店日期
- 订单成本（P0）
- 退款成本
- 结算金额

**筛选功能**：
- 按订单状态筛选
- 按时间范围筛选
- 按金额范围筛选

**操作**：
- 查看订单详情
- 导出订单明细

#### 7.4.6 打款记录

**字段列表**：
- **打款时间**：实际打款时间
- **打款金额**：实际打款金额
- **打款方式**：银行转账/支付宝/微信等
- **打款流水号**：银行流水号或第三方支付流水号
- **打款账户**：收款账户信息
- **打款备注**：打款说明
- **操作人**：执行打款的人员

#### 7.4.7 操作历史记录

记录批次的所有操作历史：
- 操作时间
- 操作人
- 操作类型（创建/审批/打款/驳回）
- 操作说明
- 操作结果

#### 7.4.8 操作按钮

根据批次状态显示不同操作：

**待审核状态**：
- **通过审批**：审核通过，状态变为"已批准"
- **驳回**：审核不通过，状态变为"已驳回"
- **导出批次数据**

**已批准状态**：
- **记录打款**：填写打款信息，状态变为"已打款"
- **导出批次数据**

**已打款/已驳回状态**：
- **导出批次数据**
- **返回列表**

---

## 8. 交互说明

### 8.1 审批流程

#### 8.1.1 单个审批

1. 点击"审批"按钮
2. 弹出审批对话框
3. 选择"通过"或"驳回"
4. 填写审批意见（驳回时必填）
5. 确认提交
6. 系统更新批次状态
7. 记录操作历史

#### 8.1.2 批量审批

1. 勾选多个待审核批次
2. 点击"批量审批"按钮
3. 弹出批量审批对话框
4. 选择"通过"或"驳回"
5. 填写统一审批意见
6. 确认提交
7. 系统批量更新批次状态
8. 显示处理结果（成功/失败数量）

### 8.2 计入账户流程

#### 8.2.1 单个计入

1. 点击"计入账户"按钮
2. 弹出确认对话框，显示结算金额
3. 确认计入
4. 系统执行：
   - 更新大B账户余额
   - 更新批次状态为"已计入"
   - 记录操作历史
   - 生成账户流水
5. 显示操作成功提示

#### 8.2.2 批量计入

1. 勾选多个已批准批次
2. 点击"批量计入"按钮
3. 弹出确认对话框，显示总金额和明细
4. 确认计入
5. 系统批量执行计入操作
6. 显示处理结果

### 8.3 打款流程

#### 8.3.1 单个打款

1. 点击"执行打款"按钮
2. 弹出打款信息填写对话框
3. 填写打款信息：
   - 打款时间
   - 打款金额（默认为结算金额）
   - 打款方式
   - 打款流水号
   - 打款备注
4. 确认提交
5. 系统执行：
   - 更新批次状态为"已打款"
   - 保存打款记录
   - 记录操作历史
6. 显示操作成功提示

#### 8.3.2 批量打款

1. 勾选多个已批准批次
2. 点击"批量打款"按钮
3. 弹出批量打款信息填写对话框
4. 填写统一打款信息
5. 确认提交
6. 系统批量执行打款操作
7. 显示处理结果

### 8.4 数据导出

#### 8.4.1 单个导出

1. 点击"导出"按钮
2. 系统生成Excel文件，包含：
   - 批次基本信息
   - 结算汇总信息
   - 订单明细列表
3. 自动下载文件

#### 8.4.2 批量导出

1. 勾选多个批次
2. 点击"批量导出"按钮
3. 系统生成包含所有选中批次的Excel文件
4. 自动下载文件

---

## 9. 异常处理

### 9.1 审批异常

- **批次状态已变更**：提示"批次状态已更新，请刷新后重试"
- **权限不足**：提示"您没有审批权限"
- **网络异常**：提示"网络异常，请稍后重试"

### 9.2 计入账户异常

- **账户状态异常**：提示"大B账户状态异常，无法计入"
- **金额异常**：提示"结算金额异常，请联系管理员"
- **重复计入**：提示"该批次已计入，请勿重复操作"

### 9.3 打款异常

- **账户信息缺失**：提示"供应商账户信息不完整，请先完善"
- **打款金额异常**：提示"打款金额不能超过结算金额"
- **重复打款**：提示"该批次已打款，请勿重复操作"

---

## 10. 数据校验

### 10.1 审批校验

- 批次状态必须为"待审核"
- 驳回时审批意见必填，至少10个字符
- 审批人必须有审批权限

### 10.2 计入账户校验

- 批次状态必须为"已批准"
- 大B账户状态必须正常
- 结算金额必须大于0

### 10.3 打款校验

- 批次状态必须为"已批准"
- 打款金额必须大于0且不超过结算金额
- 打款流水号必填
- 供应商账户信息必须完整

---

## 11. 权限控制

### 11.1 查看权限

- **管理员**：查看所有批次
- **财务人员**：查看所有批次
- **运营人员**：查看所有批次（只读）

### 11.2 操作权限

- **审批权限**：仅财务主管及以上
- **计入账户权限**：仅财务人员
- **打款权限**：仅财务主管及以上
- **导出权限**：所有有查看权限的用户

---

## 12. 性能优化

### 12.1 列表加载

- 默认加载最近30天的批次
- 支持分页加载，每页10-50条可配置
- 使用虚拟滚动优化大数据量展示

### 12.2 数据缓存

- 批次列表数据缓存5分钟
- 批次详情数据缓存3分钟
- 筛选条件保存在本地存储

### 12.3 导出优化

- 大数据量导出使用异步任务
- 导出进度实时显示
- 支持断点续传
