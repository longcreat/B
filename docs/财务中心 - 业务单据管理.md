# 财务中心 - 业务单据管理 PRD

| 版本 | 日期 | 作者 | 变更内容 |
| :--- | :--- | :--- | :--- |
| V2.0 | 2025-01-XX | [产品经理] | 基于重构后的系统架构重新设计业务单据管理模块 |

## 1. 产品概述

### 1.1 业务背景

业务单据管理是财务中心的核心数据查询模块，用于统一管理和查询平台运营过程中产生的各类财务数据记录。根据重构后的系统架构，业务单据管理需要支持：

- **三层价格体系**：P0（订单底价，供应商成本）→ P1（分销价，平台供货价）→ P2（订单金额，C端购买价格）
- **优惠金额管理**：支持平台出资和大B出资的优惠金额记录
- **退款管理**：支持按订单汇总的退款记录，并记录退款对应的P0/P1/佣金部分
- **结算管理**：区分大B结算和供应商结算，记录详细的结算金额计算过程
- **订单关联关系**：支持大B直接订单和小B推广订单的关联关系

### 1.2 核心价值

- **数据可追溯性**：建立完整的财务数据记录，支持业务追溯和问题排查
- **财务透明化**：清晰展示每一笔交易、扣费、结算的详细信息，包括价格体系、优惠金额、退款等
- **效率提升**：统一查询入口，减少跨系统查找数据的时间
- **风险控制**：通过数据监控和统计分析，及时发现异常交易和扣费
- **结算准确性**：确保结算金额计算的准确性，支持按订单汇总和按每晚明细查看

### 1.3 功能模块结构

业务单据管理采用三级菜单结构：

**二级菜单**：
1. **交易记录**：管理订单相关的交易、退款记录
2. **结算明细**：管理结算相关的明细数据（大B结算和供应商结算）

**三级菜单**（交易记录下）：
- 订单交易记录
- 订单退款记录

**三级菜单**（结算明细下）：
- 大B结算明细
- 供应商结算明细

### 1.4 架构映射与引用

- `交易记录` ←→ 《系统架构图.md》**2.1.1.4.4-4.4.1~4.4.2**（订单交易/退款）：沿用同一价格体系（P0/P1/P2）、优惠出资及操作流程。
- `结算明细` ←→ 《系统架构图.md》**2.1.1.4.4-4.4.3**（大B/供应商结算明细）：完全复用架构中的计算公式、状态机与操作动作。
- 本 PRD 后续各节依照上述映射顺序展开，确保字段、业务逻辑、操作能力与最新架构文档一一对应，方便评审与实现。

---

## 2. 功能模块

### 2.1 交易记录

#### 2.1.1 订单交易记录列表页

**页面路径**：财务中心 → 业务单据管理 → 管控账单 → 违约扣费记录

**页面功能**：
- 展示所有违约扣费记录列表
- 支持多维度筛选和搜索
- 支持统计汇总（总扣费金额、扣费笔数等）
- 支持导出扣费记录数据

**字段定义**：

| 字段名 | 字段类型 | 说明 | 示例 |
| :--- | :--- | :--- | :--- |
| 扣费记录ID | String | 唯一标识，系统自动生成 | FEE-20250101-001 |
| 关联订单号 | String | 关联的订单号 | ORD-20250101-001 |
| 关联对象 | String | 被扣费的客户名称（大B/小B） | 张三的旅游工作室 |
| 关联对象类型 | Enum | 大B客户、小B客户 | 大B客户 |
| 业务模式 | Enum | SaaS、MCP、推广联盟（仅小B显示） | SaaS |
| 扣费类型 | Enum | 客诉追索、未入住扣费、违规扣费、其他 | 客诉追索 |
| 扣费原因 | String | 详细的扣费原因说明 | 订单结算后发生客诉，全额退款 |
| 扣费金额 | Decimal(10,2) | 扣费金额（元），负数表示扣费 | -1,280.00 |
| 扣费时间 | DateTime | 扣费发生时间 | 2025-01-08 14:30:00 |
| 扣费状态 | Enum | 待扣费、已扣费、已撤销 | 已扣费 |
| 影响结算 | Boolean | 是否影响结算金额 | 是 |
| 操作人 | String | 执行扣费的操作人 | 财务-李四 |
| 备注 | String | 备注信息 | 已通知客户 |
| 操作 | Action | 查看详情、撤销扣费（如状态为已扣费） | - |

**筛选条件**：
- 扣费类型（单选）
- 扣费状态（单选）
- 关联对象类型（大B客户/小B客户/全部）
- 业务模式（SaaS/MCP/推广联盟/全部）
- 关联订单号（搜索框）
- 关联对象（搜索框）
- 扣费金额范围（最小金额、最大金额）
- 扣费时间范围（开始日期、结束日期）
- 操作人（搜索框）

**统计信息卡片**：
- 总扣费金额（汇总所有扣费记录的金额，负数）
- 扣费笔数（记录总数）
- 待扣费金额（状态为"待扣费"的金额汇总）
- 已扣费金额（状态为"已扣费"的金额汇总）
- 今日扣费金额（今日扣费记录的金额汇总）
- 大B扣费金额（关联对象类型为大B客户的扣费金额汇总）
- 小B扣费金额（关联对象类型为小B客户的扣费金额汇总）

**操作功能**：
- 查看详情：跳转到扣费详情页。
- 撤销扣费：状态为"已扣费"且操作人具备权限时可执行，自动回写账户及操作历史。
- 查看订单详情：一键跳转至订单中心查看完整订单上下文。
- 导出记录：导出当前筛选结果（含多币种金额字段）供线下复核。

**操作按钮**：
- 搜索：按扣费记录ID、关联订单号、关联对象搜索
- 筛选：展开/收起筛选条件
- 重置：清空所有筛选条件
- 导出：导出当前筛选结果的扣费记录

**操作权限**：
- 查看：所有财务人员
- 撤销扣费：财务管理员（仅状态为"已扣费"的记录可撤销）

---



**页面路径**：财务中心 → 业务单据管理 → 交易记录 → 订单交易记录

**页面路径**：财务中心 → 业务单据管理 → 交易记录 → 订单交易记录

**页面功能**：
- 展示所有订单交易记录列表（按订单汇总）
- 支持多维度筛选和搜索
- 支持统计汇总（总交易金额、交易笔数等）
- 支持导出交易记录数据

**字段定义**：

| 字段名 | 字段类型 | 说明 | 示例 |
| :--- | :--- | :--- | :--- |
| 交易记录ID | String | 唯一标识，系统自动生成 | TXN-20250101-001 |
| 订单号 | String | 关联的订单号 | ORD-20250101-001 |
| 关联对象 | String | 客户名称（大B/小B） | 张三的旅游工作室 |
| 关联对象类型 | Enum | 大B客户、小B客户 | 大B客户 |
| 业务模式 | Enum | SaaS、MCP、推广联盟（仅小B显示） | SaaS |
| 交易类型 | Enum | 订单支付、订单退款、订单补款、其他 | 订单支付 |
| 交易金额 | Decimal(10,2) | 交易金额（元），正数为收入，负数为支出 | 1,280.00 |
| **订单金额信息**（订单汇总） | - | - | - |
| 订单总金额P2 | Decimal(10,2) | 所有晚的P2销售价总和 | 1,280.00 |
| 订单总优惠金额 | Decimal(10,2) | 所有晚的优惠金额总和，如有优惠则显示，无则显示"-" | 100.00 |
| 订单实付总金额 | Decimal(10,2) | 客户实际支付总金额 = 订单总金额P2 - 订单总优惠金额 | 1,180.00 |
| 订单总退款金额 | Decimal(10,2) | 所有晚的退款金额总和，如有退款则显示，无则显示"-" | - |
| **优惠金额出资方信息** | - | - | - |
| 平台出资的优惠金额 | Decimal(10,2) | 订单总优惠金额 × 平台出资比例，如有则显示，无则显示"-" | 60.00 |
| 大B出资的优惠金额 | Decimal(10,2) | 订单总优惠金额 × 大B出资比例，如有则显示，无则显示"-" | 40.00 |
| 支付渠道 | Enum | 微信、支付宝、银行转账、其他 | 微信 |
| 支付状态 | Enum | 支付中、支付成功、支付失败、已退款 | 支付成功 |
| 交易时间 | DateTime | 交易发生时间 | 2025-01-08 10:30:00 |
| 交易流水号 | String | 支付渠道返回的交易流水号 | WX202501081030001 |
| 备注 | String | 备注信息 | - |
| 操作 | Action | 查看详情、查看订单 | - |

**筛选条件**：
- 交易类型（单选）
- 支付渠道（单选）
- 支付状态（单选）
- 关联对象类型（大B客户/小B客户/全部）
- 业务模式（SaaS/MCP/推广联盟/全部）
- 订单号（搜索框）
- 关联对象（搜索框）
- 交易金额范围（最小金额、最大金额）
- 交易时间范围（开始日期、结束日期）

**统计信息卡片**：
- 总交易金额（汇总所有交易金额，正数）
- 交易笔数（记录总数）
- 支付成功金额（支付状态为"支付成功"的金额汇总）
- 支付失败笔数（支付状态为"支付失败"的记录数）
- 今日交易金额（今日交易记录的金额汇总）
- 总优惠金额（所有订单的订单总优惠金额汇总）
- 平台出资的优惠金额（所有订单的平台出资优惠金额汇总）
- 大B出资的优惠金额（所有订单的大B出资优惠金额汇总）

**操作功能**：
- 查看详情：打开交易详情页，联动订单价格/操作历史。
- 查看订单：跳转到订单管理模块，复核原始订单。
- 导出记录：导出筛选后的交易记录，含价格拆分字段。

**操作按钮**：
- 搜索：按交易记录ID、订单号、关联对象、交易流水号搜索
- 筛选：展开/收起筛选条件
- 重置：清空所有筛选条件
- 导出：导出当前筛选结果的交易记录

---

#### 2.1.2 订单交易记录详情页

**页面路径**：财务中心 → 业务单据管理 → 交易记录 → 订单交易记录 → 详情

**页面功能**：
- 展示交易记录的完整信息
- 展示关联订单信息（包括价格信息）
- 展示交易操作历史

**详情内容**：

1. **交易基本信息卡片**
   - 交易记录ID
   - 交易类型
   - 交易金额
   - 支付渠道
   - 支付状态
   - 交易时间
   - 交易流水号
   - 备注

2. **关联订单信息卡片**
   - 订单号
   - 订单状态
   - 关联对象（大B/小B客户名称）
   - 关联对象类型（大B客户/小B客户）
   - 业务模式（SaaS/MCP/推广联盟）
   - **管理大B信息**（仅小B推广订单显示）：
     - 管理大B商户名称（挂载目标大B的名称）
     - 管理大B业务模式（SaaS/MCP）

3. **订单金额信息卡片**（订单汇总）
   - 订单总金额P2（所有晚的P2销售价总和）
   - 订单总优惠金额（所有晚的优惠金额总和）
   - 订单实付总金额（客户实际支付总金额 = 订单总金额P2 - 订单总优惠金额）
   - 订单总退款金额（所有晚的退款金额总和）
   - **优惠金额出资方信息**：
     - 平台出资的优惠金额（订单总优惠金额 × 平台出资比例）
     - 大B出资的优惠金额（订单总优惠金额 × 大B出资比例）
     - 出资方类型（配置方出资/按比例出资）

4. **价格信息卡片**（按每晚展示，可展开/收起）
   - **每晚价格明细**：
     - 入住日期
     - 每晚订单底价（P0，供应商成本）
     - 每晚分销价（P1，平台供货价）
     - 每晚订单金额（P2，销售价，C端购买价格）
     - 每晚优惠金额（优惠活动减免金额，如有则显示）
     - 每晚实付金额（客户实际支付金额 = 每晚订单金额P2 - 每晚优惠金额）

5. **操作历史记录卡片**
   - 操作时间
   - 操作人
   - 操作类型（支付、退款、修改等）
   - 操作备注

**操作按钮**：
- 返回列表
- 查看订单详情
- 导出记录

---

#### 2.1.3 订单退款记录列表页

**页面路径**：财务中心 → 业务单据管理 → 交易记录 → 订单退款记录

**页面功能**：
- 展示所有从订单管理模块或渠道回执同步的退款记录（按订单汇总），包含整单、按晚拆分后的聚合金额。
- 支持多维度筛选、统计及导出，满足结算、对账、风控稽核需求.
- 提供失败退款的二次发起入口，关联订单明细快速核查.

**字段定义**：

| 字段名 | 字段类型 | 说明 | 示例 |
| :--- | :--- | :--- | :--- |
| 退款记录ID | String | 唯一标识，系统自动生成 | REFUND-20250101-001 |
| 订单号 | String | 关联订单号 | ORD-20250101-001 |
| 关联对象 | String | 客户名称（大B/小B） | 张三的旅游工作室 |
| 关联对象类型 | Enum | 大B客户、小B客户 | 小B客户 |
| 管理大B | String | 小B推广订单显示管理大B名称 | AIGO渠道大B |
| 业务模式 | Enum | SaaS、MCP、推广联盟 | 推广联盟 |
| 退款类型 | Enum | 全额退款、部分退款、取消退款 | 部分退款 |
| 退款触发方式 | Enum | 系统自动、人工发起 | 人工发起 |
| 是否影响结算 | Boolean | 标记本次退款是否需要同步结算金额调整 | 是 |
| 订单总价 | Decimal(10,2) | 所有晚的P2销售价总和 | 1,280.00 |
| 客户实付金额 | Decimal(10,2) | 原订单实付金额（扣除优惠后） | 1,200.00 |
| 订单总退款金额 | Decimal(10,2) | 所有晚的退款金额总和 | 400.00 |
| 退款供应价 | Decimal(10,2) | 订单总退款金额 × 订单总底价P0 / 订单总金额P2 | 300.00 |
| 退款分销价 | Decimal(10,2) | 订单总退款金额 × 订单总分销价P1 / 订单总金额P2 | 320.00 |
| 退款佣金 | Decimal(10,2) | 订单总退款金额 × 订单总佣金 / 订单总金额P2，仅小B推广订单显示 | 20.00 |
| 退款渠道 | Enum | 微信、支付宝、银行转账、其他 | 微信 |
| 退款路径 | Enum | 原路退、线下打款 | 原路退 |
| 退款状态 | Enum | 退款中、退款成功、退款失败 | 退款成功 |
| 退款时间 | DateTime | 退款发起时间 | 2025-01-08 14:30:00 |
| 退款完成时间 | DateTime | 退款完成时间（退款成功时必填） | 2025-01-08 15:30:00 |
| 退款流水号 | String | 支付渠道返回的流水号 | RF202501081430001 |
| 退款凭证 | String | 退款凭证链接（人工退款必填） | https://... |
| 操作人 | String | 发起退款的操作人 | 客服-王五 |
| 操作人角色 | Enum | 客服、财务、系统 | 客服 |
| 备注 | String | 补充说明 | 客诉赔付 |
| 操作 | Action | 查看详情、查看订单、重新发起退款、复制流水号 | - |

**筛选条件**：
- 退款类型、退款状态、退款触发方式、关联对象类型（大B客户/小B客户/全部）、业务模式（SaaS/MCP/推广联盟/全部）、是否影响结算（是/否/全部）。
- 订单号、关联对象、管理大B（仅小B订单）、退款渠道、操作人.
- 金额区间：退款金额范围（最小金额、最大金额）。
- 时间区间：退款时间范围（开始日期、结束日期）、退款完成时间范围.

**统计信息卡片**：
- 退款总金额、退款笔数、退款成功金额、退款失败笔数、今日退款金额.
- 退款对应的P0部分汇总、退款对应的P1部分汇总、退款对应的佣金部分汇总.
- 影响结算的退款金额汇总（过滤是否影响结算=是的记录）。

**操作功能**：
- 查看详情：打开退款详情页，核对金额拆分与操作记录.
- 重新发起退款：仅限退款失败记录，重新调用支付渠道或线下处理.
- 查看订单详情：跳转订单管理模块，查看原始订单与退款来源记录.
- 复制退款流水号：便于财务在外部渠道对账.
- 导出记录：导出当前筛选结果（含金额拆分字段），用于财务结算与审计.

**操作按钮**：
- 搜索：按退款记录ID、订单号、关联对象、管理大B、退款流水号搜索.
- 筛选：展开/收起筛选条件.
- 重置：清空所有筛选条件.
- 导出：导出当前筛选结果的退款记录.

**操作权限**：
- 查看：财务人员、风控、客服主管.
- 重新发起退款：财务管理员或具备退款权限的客服.
- 导出：财务管理员.

---

#### 2.1.4 订单退款记录详情页

**页面路径**：财务中心 → 业务单据管理 → 交易记录 → 订单退款记录 → 详情

**页面功能**：
- 展示退款记录的全量信息，包含订单来源、金额拆分、支付渠道回执与操作历史.
- 支持对退款失败记录进行再次发起或补充凭证.
- 关联订单模块，便于核查原始订单及相关违约/改价/结算影响.

**详情内容**：

1. **退款基本信息卡片**
   - 退款记录ID
   - 订单号
   - 退款类型、退款触发方式（系统自动/人工发起）
   - 订单总退款金额、客户实付金额
   - 是否影响结算（是/否，如为是需展示“影响说明”）
   - 退款原因（标准化原因 + 描述）
   - 退款状态、退款时间、退款完成时间
   - 退款渠道、退款路径、退款流水号
   - 退款凭证（图片/文件链接，人工退款必填）
   - 操作人、操作人角色、备注

2. **关联订单信息卡片**
   - 原订单总金额P2、订单实付总金额
   - 订单状态、订单来源渠道（直采/小B推广）
   - 关联对象（大B/小B客户名称）、关联对象类型
   - 业务模式（SaaS/MCP/推广联盟）
   - 管理大B信息（仅小B推广订单显示：管理大B商户名称、业务模式）
   - 相关联的违约扣费/改价记录（如存在，展示链接便于跳转）

3. **退款金额拆分卡片**（按每晚展示，与订单管理部分一致，可展开/收起）

#### 2.2.1 大B结算明细列表页

**页面路径**：财务中心 → 业务单据管理 → 结算明细 → 大B结算明细

**页面功能**：
- 展示大B结算明细记录列表（按订单汇总）
- 支持多维度筛选和搜索
- 支持统计汇总
- 支持导出结算明细数据

**字段定义**：

| 字段名 | 字段类型 | 说明 | 示例 |
| :--- | :--- | :--- | :--- |
| 结算记录ID | String | 唯一标识 | SETTLE-B-20250101-001 |
| 订单号 | String | 关联订单号 | ORD-20250101-001 |
| 大B名称 | String | 大B商户名称 | 张三的旅游工作室 |
| 业务模式 | Enum | SaaS、MCP | SaaS |
| 订单金额 | Decimal(10,2) | 订单总金额P2 | 1,280.00 |
| 退款金额 | Decimal(10,2) | 订单总退款金额 | 400.00 |
| 结算金额 | Decimal(10,2) | 应结算给大B的金额 | 505.00 |
| 结算状态 | Enum | 待结算、可结算、已结算、已取消 | 已结算 |
| 结算时间 | DateTime | 结算完成时间 | 2025-01-08 10:30:00 |
| 操作 | Action | 查看详情 | - |

**结算金额计算规则**：
- **基础金额** = 订单总金额P2 - 订单总退款金额
- **扣除成本** = 平台分销价P1（扣除退款对应部分）+ 小B佣金
- **扣除优惠** = 大B出资的优惠金额
- **结算金额** = 基础金额 - 扣除成本 - 扣除优惠

**筛选条件**：
- 结算状态（单选）
- 业务模式（SaaS/MCP/全部）
- 大B名称（搜索框）
- 订单号（搜索框）
- 结算金额范围（最小金额、最大金额）
- 结算时间范围（开始日期、结束日期）

**统计信息**：
- 结算总金额、结算笔数
- 待结算金额、已结算金额
- 今日结算金额

**操作功能**：
- 查看详情：查看结算明细和订单信息
- 导出结算单：导出单个结算单
- 批量导出：导出筛选结果

---

#### 2.2.2 大B结算明细详情页

**页面路径**：财务中心 → 业务单据管理 → 结算明细 → 大B结算明细 → 详情

**页面功能**：
- 展示结算明细的完整信息
- 展示结算金额计算过程
- 展示关联订单和客户信息
- 支持导出结算单

**详情内容**：

1. **结算基本信息卡片**
   - 结算记录ID、订单号
   - 结算状态、结算时间
   - 结算金额

2. **客户信息卡片**
   - 大B名称、业务模式
   - 联系方式

3. **订单信息卡片**
   - 订单状态、订单金额、退款金额
   - 订单创建时间、完成时间

4. **结算计算明细卡片**
   - **收入项目**：
     - 订单金额：1,280.00
   - **扣减项目**：
     - 退款金额：400.00
     - 平台分销价：1,200.00（扣除退款对应部分 375.00 = 825.00）
     - 小B佣金：20.00（扣除退款对应部分 5.00 = 15.00）
     - 大B出资优惠：40.00
     - 小计：880.00
   - **结算金额**：400.00（收入小计 - 扣减小计）

5. **操作历史记录卡片**
   - 操作时间、操作人、操作备注

**操作按钮**：
- 返回列表
- 导出结算单
- 查看订单详情


#### 2.2.3 供应商结算明细列表页

**页面路径**：财务中心 → 业务单据管理 → 结算明细 → 供应商结算明细

**页面功能**：
- 展示供应商结算明细记录列表（按订单汇总）
- 支持多维度筛选和搜索
- 支持统计汇总
- 支持导出结算明细数据

**字段定义**：

| 字段名 | 字段类型 | 说明 | 示例 |
| :--- | :--- | :--- | :--- |
| 结算记录ID | String | 唯一标识 | SETTLE-S-20250101-001 |
| 订单号 | String | 关联订单号 | ORD-20250101-001 |
| 供应商名称 | String | 供应商名称 | XX酒店供应商 |
| 订单成本 | Decimal(10,2) | 订单总底价P0 | 1,000.00 |
| 退款成本 | Decimal(10,2) | 退款对应的P0部分 | 312.50 |
| 结算金额 | Decimal(10,2) | 应结算给供应商的金额 | 687.50 |
| 结算状态 | Enum | 待结算、可结算、已结算、已取消 | 已结算 |
| 结算时间 | DateTime | 结算完成时间 | 2025-01-08 10:30:00 |
| 操作 | Action | 查看详情、导出结算单 | - |

**结算金额计算规则**：
- **结算金额** = 订单总底价P0 - 退款对应的P0部分
- 供应商结算金额为订单底价，不包含平台加价部分

**筛选条件**：
- 结算状态（单选）
- 供应商名称（搜索框）
- 订单号（搜索框）
- 结算金额范围（最小金额、最大金额）
- 结算时间范围（开始日期、结束日期）

**统计信息**：
- 结算总金额、结算笔数
- 待结算金额、已结算金额
- 今日结算金额

**操作功能**：
- 查看详情：查看结算明细和订单信息
- 导出结算单：导出单个结算单
- 批量导出：导出筛选结果

---

#### 2.2.4 供应商结算明细详情页

**页面路径**：财务中心 → 业务单据管理 → 结算明细 → 供应商结算明细 → 详情

**页面功能**：
- 展示结算明细的完整信息
- 展示结算金额计算过程
- 展示关联订单和供应商信息
- 支持导出结算单

**详情内容**：

1. **结算基本信息卡片**
   - 结算记录ID、订单号
   - 结算状态、结算时间
   - 结算金额

2. **供应商信息卡片**
   - 供应商名称
   - 联系方式

3. **订单信息卡片**
   - 订单状态、订单成本、退款成本
   - 订单创建时间、完成时间

4. **结算计算明细卡片**
   - **收入项目**：
     - 订单成本：1,000.00
   - **扣减项目**：
     - 退款成本：312.50
   - **结算金额**：687.50（收入 - 扣减）

5. **操作历史记录卡片**
   - 操作时间、操作人、操作备注

**操作按钮**：
- 返回列表
- 导出结算单
- 查看订单详情

---

## 3. 数据模型

### 3.1 违约扣费记录表 (violation_fee_records)

| 字段名 | 字段类型 | 说明 | 约束 |
| :--- | :--- | :--- | :--- |
| fee_id | String(50) | 扣费记录ID，主键 | PK, UNIQUE |
| order_id | String(50) | 关联订单号 | FK, NOT NULL |
| related_object_id | String(50) | 关联对象ID（大B/小B客户） | FK, NOT NULL |
| related_object_name | String(100) | 关联对象名称 | NOT NULL |
| related_object_type | Enum | 关联对象类型：bigb（大B客户）、smallb（小B客户） | NOT NULL |
| business_model | Enum | 业务模式：saas、mcp、affiliate（仅小B显示） | NULL |
| fee_type | Enum | 扣费类型：dispute_deduction（客诉追索）、no_show_fee（未入住扣费）、violation_fee（违规扣费）、other（其他） | NOT NULL |
| fee_reason | Text | 扣费原因 | NOT NULL |
| fee_amount | Decimal(10,2) | 扣费金额（负数表示扣费） | NOT NULL |
| fee_time | DateTime | 扣费时间 | NOT NULL |
| fee_status | Enum | 扣费状态：pending（待扣费）、deducted（已扣费）、cancelled（已撤销） | NOT NULL |
| affect_settlement | Boolean | 是否影响结算金额 | NOT NULL, DEFAULT true |
| operator_id | String(50) | 操作人ID | NOT NULL |
| operator_name | String(50) | 操作人姓名 | NOT NULL |
| remark | Text | 备注 | NULL |
| created_at | DateTime | 创建时间 | NOT NULL |
| updated_at | DateTime | 更新时间 | NOT NULL |

### 3.2 订单交易记录表 (order_transactions)

| 字段名 | 字段类型 | 说明 | 约束 |
| :--- | :--- | :--- | :--- |
| transaction_id | String(50) | 交易记录ID，主键 | PK, UNIQUE |
| order_id | String(50) | 关联订单号 | FK, NOT NULL |
| related_object_id | String(50) | 关联对象ID（大B/小B客户） | FK, NOT NULL |
| related_object_name | String(100) | 关联对象名称 | NOT NULL |
| related_object_type | Enum | 关联对象类型：bigb（大B客户）、smallb（小B客户） | NOT NULL |
| business_model | Enum | 业务模式：saas、mcp、affiliate（仅小B显示） | NULL |
| transaction_type | Enum | 交易类型：order_payment（订单支付）、order_refund（订单退款）、order_supplement（订单补款）、other（其他） | NOT NULL |
| transaction_amount | Decimal(10,2) | 交易金额（正数为收入，负数为支出） | NOT NULL |
| order_total_amount_p2 | Decimal(10,2) | 订单总金额P2（所有晚的P2销售价总和） | NOT NULL |
| order_total_discount | Decimal(10,2) | 订单总优惠金额（所有晚的优惠金额总和） | NOT NULL, DEFAULT 0 |
| order_actual_payment | Decimal(10,2) | 订单实付总金额（订单总金额P2 - 订单总优惠金额） | NOT NULL |
| platform_discount_amount | Decimal(10,2) | 平台出资的优惠金额（订单总优惠金额 × 平台出资比例） | NOT NULL, DEFAULT 0 |
| bigb_discount_amount | Decimal(10,2) | 大B出资的优惠金额（订单总优惠金额 × 大B出资比例） | NOT NULL, DEFAULT 0 |
| payment_channel | Enum | 支付渠道：wechat（微信）、alipay（支付宝）、bank_transfer（银行转账）、other（其他） | NOT NULL |
| payment_status | Enum | 支付状态：processing（支付中）、success（支付成功）、failed（支付失败）、refunded（已退款） | NOT NULL |
| transaction_time | DateTime | 交易时间 | NOT NULL |
| transaction_no | String(100) | 交易流水号 | NULL |
| remark | Text | 备注 | NULL |
| created_at | DateTime | 创建时间 | NOT NULL |
| updated_at | DateTime | 更新时间 | NOT NULL |

### 3.3 订单改价记录表 (order_price_change_records)

| 字段名 | 字段类型 | 说明 | 约束 |
| :--- | :--- | :--- | :--- |
| price_change_id | String(50) | 改价记录ID，主键 | PK, UNIQUE |
| order_id | String(50) | 关联订单号 | FK, NOT NULL |
| related_object_id | String(50) | 关联对象ID（大B/小B客户） | FK, NOT NULL |
| related_object_name | String(100) | 关联对象名称 | NOT NULL |
| related_object_type | Enum | 关联对象类型：bigb（大B客户）、smallb（小B客户） | NOT NULL |
| business_model | Enum | 业务模式：saas、mcp、affiliate（仅小B显示） | NULL |
| change_type | Enum | 改价类型：price_increase（升价）、price_decrease（降价）、price_correction（价格修正） | NOT NULL |
| change_scope | Enum | 改价范围：total（订单总价改价）、daily（每晚价格改价） | NOT NULL |
| original_amount_p2 | Decimal(10,2) | 原订单总金额P2（所有晚的P2总和） | NOT NULL |
| new_amount_p2 | Decimal(10,2) | 新订单总金额P2（所有晚的P2总和） | NOT NULL |
| change_amount | Decimal(10,2) | 改价差额（正数为升价，负数为降价） | NOT NULL |
| change_reason | Text | 改价原因 | NOT NULL |
| change_time | DateTime | 改价时间 | NOT NULL |
| operator_id | String(50) | 操作人ID | NOT NULL |
| operator_name | String(50) | 操作人姓名 | NOT NULL |
| approval_status | Enum | 审批状态：pending（待审批）、approved（已审批）、rejected（已驳回） | NOT NULL |
| approver_id | String(50) | 审批人ID | NULL |
| approver_name | String(50) | 审批人姓名 | NULL |
| remark | Text | 备注 | NULL |
| created_at | DateTime | 创建时间 | NOT NULL |
| updated_at | DateTime | 更新时间 | NOT NULL |

### 3.4 订单退款记录表 (order_refund_records)

| 字段名 | 字段类型 | 说明 | 约束 |
| :--- | :--- | :--- | :--- |
| refund_id | String(50) | 退款记录ID，主键 | PK, UNIQUE |
| order_id | String(50) | 关联订单号 | FK, NOT NULL |
| related_object_id | String(50) | 关联对象ID（大B/小B客户） | FK, NOT NULL |
| related_object_name | String(100) | 关联对象名称 | NOT NULL |
| related_object_type | Enum | 关联对象类型：bigb（大B客户）、smallb（小B客户） | NOT NULL |
| business_model | Enum | 业务模式：saas、mcp、affiliate（仅小B显示） | NULL |
| refund_type | Enum | 退款类型：full_refund（全额退款）、partial_refund（部分退款）、cancel_refund（取消退款） | NOT NULL |
| original_amount_p2 | Decimal(10,2) | 原订单总金额P2（所有晚的P2销售价总和） | NOT NULL |
| refund_amount | Decimal(10,2) | 订单总退款金额（所有晚的退款金额总和） | NOT NULL |
| refund_p0_amount | Decimal(10,2) | 退款对应的P0部分（订单总退款金额 × 订单总底价P0 / 订单总金额P2） | NOT NULL, DEFAULT 0 |
| refund_p1_amount | Decimal(10,2) | 退款对应的P1部分（订单总退款金额 × 订单总分销价P1 / 订单总金额P2） | NOT NULL, DEFAULT 0 |
| refund_commission_amount | Decimal(10,2) | 退款对应的佣金部分（订单总退款金额 × 订单总佣金 / 订单总金额P2，仅小B推广订单有） | NOT NULL, DEFAULT 0 |
| refund_reason | Text | 退款原因 | NOT NULL |
| refund_status | Enum | 退款状态：processing（退款中）、success（退款成功）、failed（退款失败） | NOT NULL |
| refund_time | DateTime | 退款发起时间 | NOT NULL |
| refund_completed_time | DateTime | 退款完成时间 | NULL |
| refund_no | String(100) | 退款流水号 | NULL |
| operator_id | String(50) | 操作人ID | NOT NULL |
| operator_name | String(50) | 操作人姓名 | NOT NULL |
| refund_voucher | String(200) | 退款凭证链接 | NULL |
| remark | Text | 备注 | NULL |
| created_at | DateTime | 创建时间 | NOT NULL |
| updated_at | DateTime | 更新时间 | NOT NULL |

### 3.5 大B结算明细表 (bigb_settlement_details)

| 字段名 | 字段类型 | 说明 | 约束 |
| :--- | :--- | :--- | :--- |
| settlement_id | String(50) | 结算记录ID，主键 | PK, UNIQUE |
| batch_id | String(50) | 结算批次号 | FK, NULL |
| order_id | String(50) | 关联订单号 | FK, NOT NULL |
| bigb_id | String(50) | 大B客户ID | FK, NOT NULL |
| bigb_name | String(100) | 大B客户名称 | NOT NULL |
| user_info_type | Enum | 用户信息类型：travel_agent（旅行代理）、blogger（网络博主）、travel_app（旅游类相关应用） | NOT NULL |
| auth_type | Enum | 认证方式：individual（个人认证）、enterprise（企业认证） | NOT NULL |
| business_model | Enum | 业务模式：saas、mcp | NOT NULL |
| order_total_amount_p2 | Decimal(10,2) | 订单总金额P2（所有晚的P2销售价总和） | NOT NULL |
| order_total_refund | Decimal(10,2) | 订单总退款金额（所有晚的退款金额总和） | NOT NULL, DEFAULT 0 |
| order_total_p1 | Decimal(10,2) | 订单总分销价P1（所有晚的P1平台供货价总和） | NOT NULL |
| order_total_p0 | Decimal(10,2) | 订单总底价P0（所有晚的P0供应商成本总和） | NOT NULL |
| order_total_discount | Decimal(10,2) | 订单总优惠金额（所有晚的优惠金额总和） | NOT NULL, DEFAULT 0 |
| bigb_discount_amount | Decimal(10,2) | 大B出资的优惠金额（订单总优惠金额 × 大B出资比例） | NOT NULL, DEFAULT 0 |
| order_total_commission | Decimal(10,2) | 订单总佣金（所有晚的佣金总和，仅小B推广订单有） | NOT NULL, DEFAULT 0 |
| refund_p1_amount | Decimal(10,2) | 退款对应的P1部分（订单总退款金额 × 订单总分销价P1 / 订单总金额P2） | NOT NULL, DEFAULT 0 |
| refund_commission_amount | Decimal(10,2) | 退款对应的佣金部分（订单总退款金额 × 订单总佣金 / 订单总金额P2） | NOT NULL, DEFAULT 0 |
| platform_profit | Decimal(10,2) | 平台总利润（订单总分销价P1 - 订单总底价P0 - 平台出资的优惠金额） | NOT NULL |
| bigb_profit | Decimal(10,2) | 大B利润（订单总金额P2 - 订单总退款金额 - 订单总分销价P1 - 订单总佣金 - 大B出资的优惠金额） | NOT NULL |
| settlement_amount | Decimal(10,2) | 结算金额（订单总金额P2 - 订单总退款金额 - (订单总分销价P1 - 退款对应的P1部分) - 订单总佣金 - 大B出资的优惠金额） | NOT NULL |
| settlement_status | Enum | 结算状态：pending（待结算）、ready（可结算）、processing（处理中）、settled（已结算）、cancelled（已取消） | NOT NULL |
| settlement_time | DateTime | 结算时间 | NULL |
| created_at | DateTime | 创建时间 | NOT NULL |
| updated_at | DateTime | 更新时间 | NOT NULL |

### 3.6 供应商结算明细表 (supplier_settlement_details)

| 字段名 | 字段类型 | 说明 | 约束 |
| :--- | :--- | :--- | :--- |
| settlement_id | String(50) | 结算记录ID，主键 | PK, UNIQUE |
| batch_id | String(50) | 结算批次号 | FK, NULL |
| order_id | String(50) | 关联订单号 | FK, NOT NULL |
| supplier_id | String(50) | 供应商ID | FK, NOT NULL |
| supplier_name | String(100) | 供应商名称 | NOT NULL |
| supplier_contact | String(200) | 供应商联系方式（电话、邮箱） | NULL |
| order_total_p0 | Decimal(10,2) | 订单总底价P0（所有晚的P0供应商成本总和） | NOT NULL |
| order_total_refund | Decimal(10,2) | 订单总退款金额（所有晚的退款金额总和） | NOT NULL, DEFAULT 0 |
| refund_p0_amount | Decimal(10,2) | 退款对应的P0部分（订单总退款金额 × 订单总底价P0 / 订单总金额P2） | NOT NULL, DEFAULT 0 |
| settlement_amount | Decimal(10,2) | 结算金额（订单总底价P0 - 退款对应的P0部分） | NOT NULL |
| settlement_status | Enum | 结算状态：pending（待结算）、ready（可结算）、processing（处理中）、settled（已结算）、cancelled（已取消） | NOT NULL |
| settlement_time | DateTime | 结算时间 | NULL |
| created_at | DateTime | 创建时间 | NOT NULL |
| updated_at | DateTime | 更新时间 | NOT NULL |

---

## 4. 业务流程

### 4.1 违约扣费流程

```
订单发生违约事件（客诉、未入住等）
    ↓
系统自动或人工触发扣费
    ↓
生成扣费记录（状态：待扣费）
    - 关联订单号
    - 关联对象（大B/小B客户）
    - 扣费类型、扣费原因
    - 扣费金额
    - 是否影响结算金额
    ↓
从对应账户扣减金额
    ↓
更新扣费记录状态（已扣费）
    ↓
如影响结算金额，更新结算金额计算
    ↓
记录操作历史
    ↓
完成
```

### 4.2 订单交易流程

```
订单支付/退款/补款操作
    ↓
调用支付渠道API
    ↓
支付渠道返回交易结果
    ↓
生成交易记录
    - 关联订单号
    - 关联对象（大B/小B客户）
    - 交易类型、交易金额
    - 订单总金额P2、订单总优惠金额、订单实付总金额
    - 平台出资的优惠金额、大B出资的优惠金额
    - 支付渠道、支付状态
    ↓
更新订单状态
    ↓
更新账户余额（如需要）
    ↓
记录操作历史
    ↓
完成
```

### 4.3 订单改价流程

```
客服/财务发起改价申请
    ↓
填写改价信息（原价、新价、原因等）
    - 改价类型（升价/降价/价格修正）
    - 改价范围（订单总价改价/每晚价格改价）
    - 原订单总金额P2、新订单总金额P2
    ↓
生成改价记录（状态：待审批）
    ↓
财务审批
    ↓
如审批通过：
    - 更新订单金额（按每晚更新P2）
    - 更新改价记录状态（已审批）
    - 记录操作历史
    - 如影响结算，更新结算金额计算

如审批驳回：
    - 更新改价记录状态（已驳回）
    - 记录操作历史
    ↓
完成
```

### 4.4 订单退款流程

```
客户申请退款或系统自动退款
    ↓
生成退款记录（状态：退款中）
    - 关联订单号
    - 关联对象（大B/小B客户）
    - 退款类型、退款金额
    - 原订单总金额P2
    ↓
计算退款对应的金额部分
    - 退款对应的P0部分 = 订单总退款金额 × 订单总底价P0 / 订单总金额P2
    - 退款对应的P1部分 = 订单总退款金额 × 订单总分销价P1 / 订单总金额P2
    - 退款对应的佣金部分 = 订单总退款金额 × 订单总佣金 / 订单总金额P2（仅小B推广订单有）
    ↓
调用支付渠道退款API
    ↓
支付渠道返回退款结果
    ↓
更新退款记录状态（退款成功/退款失败）
    ↓
如退款成功：
    - 更新订单状态
    - 更新订单总退款金额
    - 更新账户余额
    - 如影响结算，更新结算金额计算（扣除退款对应的部分）
    - 记录操作历史

如退款失败：
    - 记录失败原因
    - 可重新发起退款
    ↓
完成
```

### 4.5 大B结算明细生成流程

```
订单完成，满足结算条件
    ↓
系统自动生成大B结算明细记录（状态：待结算）
    - 关联订单号
    - 关联大B客户
    - 计算结算金额：
      - 订单总金额P2
      - 订单总退款金额
      - 订单总分销价P1
      - 订单总底价P0
      - 订单总优惠金额
      - 大B出资的优惠金额
      - 订单总佣金（仅小B推广订单有）
      - 退款对应的P1部分
      - 退款对应的佣金部分
      - 结算金额 = 订单总金额P2 - 订单总退款金额 - (订单总分销价P1 - 退款对应的P1部分) - 订单总佣金 - 大B出资的优惠金额
    ↓
结算状态更新为"可结算"
    ↓
纳入结算批次
    ↓
结算批次审批通过后，批量更新明细状态（已结算）
    ↓
完成
```

### 4.6 供应商结算明细生成流程

```
订单完成，满足结算条件
    ↓
系统自动生成供应商结算明细记录（状态：待结算）
    - 关联订单号
    - 关联供应商
    - 计算结算金额：
      - 订单总底价P0
      - 订单总退款金额
      - 退款对应的P0部分 = 订单总退款金额 × 订单总底价P0 / 订单总金额P2
      - 结算金额 = 订单总底价P0 - 退款对应的P0部分
    ↓
结算状态更新为"可结算"
    ↓
纳入结算批次
    ↓
结算批次审批通过后，批量更新明细状态（已结算）
    ↓
完成
```

---

## 5. 权限控制

### 5.1 角色权限

| 角色 | 权限范围 |
| :--- | :--- |
| 管理员（role=admin） | 查看所有记录、撤销扣费、审批改价、重新发起退款、导出所有数据、纳入结算批次 |
| 大B客户 | 查看自己的交易记录、改价记录、退款记录、结算明细（仅自己的） |
| 小B客户 | 查看自己的交易记录、改价记录、退款记录（仅自己的） |
| 财务人员 | 查看所有记录、审批改价、重新发起退款、导出数据、纳入结算批次 |

### 5.2 数据权限

- **管理员**：可以查看所有财务数据记录
- **大B客户**：仅可查看自己的交易记录、改价记录、退款记录、结算明细
- **小B客户**：仅可查看自己的交易记录、改价记录、退款记录（不包含结算明细，结算由大B完成）
- **财务人员**：可以查看所有财务数据记录，可以执行审批、重新发起退款等操作
- **撤销扣费、审批改价、纳入结算批次**等敏感操作需要管理员或财务管理员权限

---

## 6. 性能要求

- 列表加载时间：< 2秒（1000条数据）
- 统计汇总计算时间：< 1秒
- 导出响应时间：< 5秒（1000条数据）
- 详情页加载时间：< 1秒
- 按每晚展示的价格明细支持展开/收起，默认收起，减少页面加载时间

---

## 7. 异常处理

### 7.1 数据异常

- 订单不存在：提示"关联订单不存在"
- 账户余额不足：扣费时提示"账户余额不足，无法扣费"
- 支付渠道异常：退款失败时记录错误原因，支持重新发起
- 结算金额计算异常：记录错误日志，通知管理员

### 7.2 操作异常

- 撤销扣费失败：记录错误日志，通知管理员
- 审批超时：发送提醒通知
- 结算批次纳入失败：记录错误日志，通知管理员

---

## 8. 附录

### 8.1 枚举值定义

**关联对象类型 (related_object_type)**：
- `bigb`：大B客户
- `smallb`：小B客户

**业务模式 (business_model)**：
- `saas`：SaaS模式
- `mcp`：MCP模式
- `affiliate`：推广联盟模式（仅小B显示）

**扣费类型 (fee_type)**：
- `dispute_deduction`：客诉追索
- `no_show_fee`：未入住扣费
- `violation_fee`：违规扣费
- `other`：其他

**扣费状态 (fee_status)**：
- `pending`：待扣费
- `deducted`：已扣费
- `cancelled`：已撤销

**交易类型 (transaction_type)**：
- `order_payment`：订单支付
- `order_refund`：订单退款
- `order_supplement`：订单补款
- `other`：其他

**支付状态 (payment_status)**：
- `processing`：支付中
- `success`：支付成功
- `failed`：支付失败
- `refunded`：已退款

**改价类型 (change_type)**：
- `price_increase`：升价
- `price_decrease`：降价
- `price_correction`：价格修正

**改价范围 (change_scope)**：
- `total`：订单总价改价
- `daily`：每晚价格改价

**退款类型 (refund_type)**：
- `full_refund`：全额退款
- `partial_refund`：部分退款
- `cancel_refund`：取消退款

**退款状态 (refund_status)**：
- `processing`：退款中
- `success`：退款成功
- `failed`：退款失败

**结算状态 (settlement_status)**：
- `pending`：待结算
- `ready`：可结算
- `processing`：处理中
- `settled`：已结算
- `cancelled`：已取消

---

## 9. 后续优化（P1功能）

1. **数据可视化**：提供图表展示交易趋势、扣费趋势、结算趋势等
2. **异常预警**：自动识别异常交易、异常扣费、异常结算，发送预警
3. **批量操作**：支持批量撤销扣费、批量重新发起退款、批量纳入结算批次等
4. **数据导出优化**：支持自定义导出字段、定时导出等
5. **数据统计分析**：提供更丰富的统计分析报表，包括按大B/小B/供应商维度的统计分析
6. **价格明细优化**：支持按每晚展示价格明细的导出功能
7. **结算对账**：支持结算金额与订单金额的对账功能，确保数据一致性

---

## 10. 版本历史

| 版本 | 日期 | 作者 | 变更内容 |
| :--- | :--- | :--- | :--- |
| V2.0 | 2025-01-XX | [产品经理] | 基于重构后的系统架构重新设计业务单据管理模块，支持三层价格体系（P0/P1/P2）、优惠金额管理、退款管理、结算管理等 |
| V1.0 | 2025-01-XX | [产品经理] | 初始版本创建 |
