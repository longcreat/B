# 酒店分销平台 - 分账系统 PRD

| 版本 | 日期 | 作者 | 变更内容 |
| :--- | :--- | :--- | :--- |
| V1.0 | 2025-11-01 | [你的名字/PM] | 初始版本创建 |

## 1\. 产品概述

### 1.1 项目背景

为满足酒店分销业务需求，我们需要建立一个自动化分账系统。上游对接酒店供应商，平台加价后分销给下游B端客户（小B，如博主、群主）。B端客户再次加价，通过平台提供的H5页面销售给C端用户。C端支付金额由平台统一收款，平台负责向C端开票，并最终与上游供应商和B端客户进行结算分账。

**核心变更：** 针对占比最大的个人B端，传统的现金结算（公对私）存在巨大的税务合规风险。为解决此问题，我们将佣金（B_Profit）转化为平台积分，B端通过积分商城兑换礼品卡（如京东卡、天猫卡）的方式获得收益，以此实现合规、高效的激励与结算。

### 1.2 业务流程

**资金流：** C端支付 -> 平台收款 -> 平台结算给供应商(现金) -> 平台为B端计提积分。

**票据流：** 平台开票给C端 -> 供应商开票给平台 -> 平台采购礼品卡/服务并获取发票。

**实物流：** B端使用积分 -> 平台（或第三方服务商）-> B端获得礼品卡。

### 1.3 核心目标

设计一个分账系统，实现多方（供应商、平台、B端）利润的自动化、准确、高效、安全及税务合规的计算与结算。

  * **准确：** 确保每笔订单的三方（供应商成本、平台利润、B端利润）金额计算100%准确。
  * **高效：** 自动化处理结算单生成、提现申请，减少人工财务操作。
  * **安全：** 保证资金安全、支付安全、数据（特别是财务和身份信息）安全。
  * **合规：** 彻底解决个人B端（博主/群主）无法提供发票的问题，规避平台的税务风险。
  * **风控（重点）：** 建立“防超卖”机制，有效处理**“结算（积分兑换）后客诉”**的场景，避免平台产生资金损失。

## **2.0 核心概念、角色与定价模型**

### **2.1 用户角色 (User Roles)**
| 角色 | 描述 | 核心诉求 |
| :--- | :--- | :--- |
| **C端用户** | 最终消费者 | 通过B端分享的H5链接预订酒店并支付。 |
| **B端客户 (小B)** | 分销商（博主、群主、企业） | 设置加价、分享链接、查看收益、安全合规地提取利润。 |
| **酒店供应商** | 资源提供方 | 准确、及时地收到订单结算款。 |
| **平台财务/运营** | 内部管理者 | 管理B端客户、配置商品、监控订单、审核结算、管理发票、进行对账。 |

### **2.2 价格体系定义 (Price Waterfall)**
1.  **P0 - 供应商底价 (Net Rate):**
    *   **定义：** 我们从上游酒店资源商获取的、不含任何利润的裸仕价。
2.  **P1 - 平台供货价 (Platform Cost Price):**
    *   **定义：** 我们加上自己的平台利润后，供给小B的“批发价”。
    *   **计算公式：** `P1 = P0 * (1 + 平台利润率)`
3.  **P2 - 小B销售价 (B2C Selling Price):**
    *   **定义：** 小B在其渠道上，最终呈现给C端用户的销售价格。
    *   **计算公式：** `P2 = P1 * (1 + 小B加价率)`

### **2.3 利润归属定义**
1.  **我方平台利润 (Platform Profit):**
    *   **计算公式：** `平台利润 = P1 - P0`
2.  **小B分销商利润 (Partner Profit):**
    *   **计算公式：** `小B利润 = P2 - P1`

### **2.4 资金清分模型**
对于每一笔由我方平台统一收取的`P2`金额，系统在后台进行逻辑清分：
*   **应付供应商成本:** `P0`
*   **应付小B利润:** `P2 - P1`
*   **我方平台留存:** `P1 - P0`
*   **校验公式：** `P2 = (应付供应商成本) + (应付小B利润) + (我方平台留存)` 必须恒等。



## 3\. 功能需求 (Functional Requirements)

### 3.1 模块一：B端客户与定价管理

#### 3.1.1 B端客户档案与入驻
*   **【P0】B端入驻：** B端客户通过H5页面注册，必须选择主体类型：`企业`、`博主`、`个人`。
    *   **企业：** 必须上传营业执照。
    *   **博主/个人：** 必须上传身份证正反面，并进行实名认证（调用第三方接口）。
*   **【P0】财务信息：** B端必须填写用于结算的银行账户信息。`企业`为对公账户，`个人/博主`为个人银行卡。系统需支持银行卡四要素鉴权。
*   **【P0】合规协议签署：** 入驻时，必须在线阅读并勾选同意《推广合作协议》，协议必须包含明确的“**客诉追索条款**”，授权平台在结算后，如因客诉退款导致平台损失，平台有权从B端的未来收益或账户余额中扣除等值金额/积分。

#### 3.1.2 B端加价策略

  * **【P0】设置加价：** B端登录其H5管理后台，可设置自己的加价。
  * **【P0】加价模式：**
      * `按比例加价`：在平台分销价（`A_Price`）基础上加价 $X\%$。
  * **【P1】加价规则：** 支持设置`全局默认加价`，也支持`针对特定国家/酒店/房型`设置独立的加价。

#### 3.1.3 推广链接

  * **【P0】生成专属H5链接：** B端设置加价后，系统为其生成唯一的H5预订链接（URL中必须包含可识别的B端ID，如 `distributor_id=XXX`）。
  * **【P0】归属判定：** C端用户通过此链接下单，订单自动归属于该B端。

### 3.2 模块二：订单与状态机

#### 3.2.1 订单数据结构 (关键)

平台生成的每笔订单必须清晰记录以下金额，用于后续分账：

  * `OrderID`：平台订单号
  * `SupplierOrderID`：供应商订单号
  * `DistributorID`：B端客户ID
  * `Cost_Price`：成本价（供应商结算价）
  * `A_Price`：平台分销价（$Cost\_Price$ + $Markup\_A$）
  * `Final_Price`：C端支付价（$A\_Price$ + $Markup\_B$）
  * `A_Profit` (平台利润)：$Markup\_A$
  * `B_Profit` (B端利润)：$Markup\_B$

#### 3.2.2 订单状态机 (分账触发器)

分账的计算和触发严格依赖订单的终态。

| 状态 | 触发条件 | 分账动作 |
| :--- | :--- | :--- |
| `待支付` | C端下单 | 无 |
| `待确认` | C端支付成功 | 无 |
| `已确认/待入住` | 供应商确认占房 | 无 |
| `已完成` | C端离店（Check-out） | （重点）不在此刻结算！ |
| `可结算` | `已完成` + 售后期（如T+N天） | **触发分账**。`Cost_Price` 和 `B_Profit` 计入供应商和B端的**可结算余额**。 |
| `已取消（免费）` | C端在免费取消期内取消 | 无。退款。 |
| **`已取消（付费）`** | C端在付费取消期内取消，产生扣损 | **触发“扣损分账”**。 |
| **`No-Show`** | C端未入住 | 同“付费取消”。 |
| `争议中` | C端发起客诉 | **冻结结算**。该订单金额不允许计入任何结算单。 |

#### 3.2.3 订单可结算状态的判定

订单进入可结算状态，必须依次通过以下门控。

*   **Gate 1: 服务已完成:** `离店日期 < T(今日)`。
*   **Gate 2: 冻结期已过:** `T(今日) - 离店日期 > 结算冻结期天数` (后台可配，建议7-15天)。用于处理客诉、No-Show争议、防范欺诈。
*   **Gate 3: 订单无未决争议:** 订单状态不处于`争议中`、`退款处理中`等任何异常挂起状态。
*   **Gate 4: 供应商成本已对账:** 订单的`P0`已与上游供应商账单核对并标记为`已对账`。**这是防止因成本差异导致平台亏损的核心风控。**
*   **Gate 5: 结算对象状态正常:** 小B/供应商的账户`结算状态`为`活跃`，未被冻结或关闭。

### 3.3 模块三：虚拟账本与资金管理

#### 3.3.1 统一收款

  * **【P0】** C端用户支付 `Final_Price`，资金100%进入平台在支付机构（微信/支付宝/银行）的**收款主账户**。

#### 3.3.2 B端账户中心 (双轨制)

* **【P0】** 系统为每个供应商建立一个**现金虚拟账本**。
* **【P0】** 系统需为B端客户建立**两套独立账户体系**，B端入驻时根据其主体类型（`个人/博主` 或 `企业`）**强制绑定**其一。


**1. 体系A：积分账户 (个人/博主)**

* **【P0】账户结构：** 虚拟账户包含三个核心余额：
    * `可用积分`：**已过安全期（T+N天）**、无争议的订单所产生的积分，可用于兑换。
    * `冻结积分`：已离店但**未过安全期**、或处于`争议中`的订单对应的积分。
    * **`积分欠款` (负数)：** [风控核心] 用于处理“结算后客诉追索”，B端需用未来收益偿还。
* **【P0】积分规则：** 1 人民币 (B\_Profit\_CNY) = 1 积分（后台可配）。
* **【P0】记账（Booking）：**
    1.  **（新）** 当订单状态变为 `已完成` (C端离店) 时：
        * `冻结积分` 增加 `B_Profit_CNY` 对应的积分值。（进入T+N天安全期）
    2.  **（新）** 当订单状态变为 **`可结算`** (即 `已完成` + `T+N安全期` 且无客诉) 时：
        * `冻结积分` 扣减 对应积分。
        * `可用积分` 增加 对应积分。（积分释放，B端可兑换）
    3.  当订单状态变为 `争议中` 时：
        * 如果该订单积分在`冻结积分`中，则保持冻结。
        * 如果该订单积分已计入`可用积分`（即结算后客诉），则触发**[3.3 客诉追索]**逻辑，`可用积分`被扣减，不足时产生`积分欠款`。

**2. 体系B：现金账本 (企业)**

* **【P0】账户结构：** 虚拟账户包含三个核心余额：
    * `可提现余额 (CNY)`：**已过安全期（T+N天）**、无争议的订单所产生的佣金。
    * `冻结余额 (CNY)`：已离店但**未过安全期**、或处于`争议中`的订单对应的佣金。
    * **`应付负额 (CNY)` (负数)：** [风控核心] 用于处理“结算后客诉追索”，B端需用未来收益偿还。
* **【P0】记账（Booking）：**
    1.  **（新）** 当订单状态变为 `已完成` (C端离店) 时：
        * `冻结余额 (CNY)` 增加 `B_Profit_CNY`。（进入T+N天安全期）
    2.  **（新）** 当订单状态变为 **`可结算`** (即 `已完成` + `T+N安全期` 且无客诉) 时：
        * `冻结余额 (CNY)` 扣减 `B_Profit_CNY`。
        * `可提现余额 (CNY)` 增加 `B_Profit_CNY`。（佣金释放，B端可提现）
    3.  当订单状态变为 `争议中` 时：
        * 处理逻辑同“体系A”，`冻结余额`保持冻结，或触发**[3.3 客诉追索]**，产生`应付负额`。

**3. 供应商账本**

* **【P0】** 逻辑同“体系B：现金账本”，但结算周期按合同执行（如月结）。
* **【P0】记账（Booking）：**
    1.  当订单状态变为 `可结算` (即 `已完成` + `T+N安全期`) 时：
        * 供应商虚拟账户：`可结算余额 (CNY)` 增加 `Cost_Price`。

### 3.4 模块四：结算与提现 (B端)

#### 3.4.1 (个人/博主) 积分商城与兑换

* **【P0】积分商城 (H5)：**
    * 平台运营配置电子礼品卡（京东卡、天猫卡、话费券等）。

* **【P0】B端兑换流程：**
    * B端在H5后台选择礼品卡，点击兑换。
    * 系统校验可用积分是否足够。
    * 校验通过，扣减可用积分。
    * 系统通过API（对接第三方卡券服务商）自动下发卡密。

#### 3.4.2 (企业) 现金结算与提现

* **【P0】提现工作流 (核心)：**
    * B端在后台发起提现（提现金额 ≤ 可提现余额）。
    * **【P0】发票上传：** B端必须上传与提现金额等额、合规的“服务费/推广费”增值税专用发票。
    * **【P0】财务审批 (人工)：**
        * 平台财务在后台“提现审批列表”中审核。
        * 重点审核： 发票（建议对接发票验真API）与金额。
        * 审批结果：同意打款 或 驳回（如“发票信息错误”）。
    * **【P0】自动打款：**
        * 财务审批通过后，系统调用银行“企业付款”API，执行公对公转账。

* **【P0】状态回写：** 打款成功后，扣减可提现余额。


### 3.5 模块五：税务与合规 (核心风险点)

#### 3.5.1 C端开票

  * **【P0】** 平台（我们）作为收款方和服务提供方，**必须**为C端用户提供全额 (`Final_Price`) 的发票。
  * **【P0】** H5下单页面需提供“申请发票”入口。发票类型为“*旅游服务*”或“*住宿费*”。

#### 3.5.2 B端发票（解决方案）

  * **【P0】** 平台必须获取B端 `B_Profit` 对应的成本发票，否则平台将承担额外的企业所得税。
  * **【P0】方案 A：企业/个体工商户B端**
    1.  B端在提现前，必须在后台上传与提现金额等额的**增值税专用发票**（类目为“*服务费*”、“*推广费*”、“*咨询费*”）。
    2.  财务在审批提现时，必须核验发票。
  * **【P0】方案 B：个人B端（核心）**
    1.  **引入灵活用工平台：** 平台与第三方合规的灵活用工平台（或委托代征平台）签约。
    2.  **协议转移：** B端入驻时签署的《灵活用工服务协议》，使其成为灵活用工平台的“服务人员”。
    3.  **结算流程变更：**
        a. 平台财务（如每月）将所有“个人B端”的`B_Profit`总和，**批量公对公**支付给“灵活用工平台”。
        b. “灵活用工平台”向我们（平台）开具一张**全额、合规**的“服务费”增值税专用发票。
        c. “灵活用工平台”负责将款项**拆分**并T+1发放给每个个人B端，并为其完成**个人所得税的代扣代缴**。
    4.  **系统实现：** 平台财务后台需要有“个人B端结算汇总”功能，一键导出支付给灵工平台的明细表。

> **设计决策：** 方案B是解决小B（个人）合规性的唯一通路。它将平台的“B2C”发票风险，转化为合规的“B2B”发票往来。

## 4\. 异常场景处理

### 4.1 场景：付费取消 / No-Show

  * **问题：** C端未入住，但产生扣损（`Penalty_Fee`）。
  * **设计：**
    1.  **规则配置：** 平台需在后台配置“扣损分成规则”（供应商得 $X\%$，平台得 $Y\%$，B端得 $Z\%_B$）。
    2.  **分账逻辑：** 订单状态变为`付费取消`或`No-Show`时，触发“扣损分账”。
    3.  **记账：** B端的虚拟账户 `可结算余额` 增加 $Penalty\_Fee \times Z_B\%$。
    4.  **注意：** 绝不能按原 `B_Profit` 全额分给B端。

### 4.2 场景：客诉与争议 (Dispute)

  * **问题：** C端离店后投诉，要求退款。
  * **设计：**
    1.  **冻结：** 客服收到客诉，将该订单状态改为`争议中`。
    2.  **账本锁定：** 该订单的`B_Profit`和`Cost_Price`从`可结算余额`中移出（或冲正），放入`冻结余额`。
    3.  **解决 - 客诉不成立：** 订单状态改回`已完成`，金额解冻，移回`可结算余额`。
    4.  **解决 - 全额退款：** 订单状态改为`已退款`，冻结金额清零。
    5.  **解决 - 部分退款：**
        a. 客服在后台输入“退款金额”。
        b. 系统需生成一笔\*\*“调账”\*\*分录。
        c. 平台的`A_Profit`和B端的`B_Profit`按约定比例（或仅扣减平台利润）扣减，虚拟账本的冻结金额按比例释放，多余部分清零。

### 4.3 场景：订单修改 (续住、加床)

  * **问题：** C端到店后产生额外消费。
  * **设计：**
    1.  **严禁“改原单”：** 财务系统严禁修改已确认的订单金额。
    2.  **续住：** B端必须通过H5**下新订单**。
    3.  **加床（平台代收）：** 平台客服在后台创建一笔\*\*“补充订单”\*\*，关联到主订单。
    4.  **分账：** “新订单”或“补充订单”按**独立订单**走全套分账流程（它也有自己的`Cost_Price`, `A_Profit`, `B_Profit`）。

### 4.4 场景：客诉追索 (已结算/已兑换) - (风控核心)

  * **问题：** 订单在T+7天变为可结算，B端获得收益（例如10000积分或100元现金）并已兑换/提现。在T+15天，C端发起客诉并成功（如信用卡盗刷、C端未实际入住等极端情况），平台退款。

  * **设计：** 这是防止平台损失的第二道防线。

    * **触发追索：** 客服处理退款，标记该订单为“结算后退款”，并录入应追索B端的金额（如100元）。
    * **负向记账（系统自动）：**
        * 积分B端： 系统在其积分账户中，生成一笔 -10,000 的“客诉追索”分录。
        * 现金B端： 系统在其现金账本中，生成一笔 -100.00 的“客诉追索”分录。
    * **账户抵扣（自动）：**
        * 情况A：B端账户仍有余额 (如 12,000 积分)。系统自动扣除，可用积分 变为 2,000。
        * 情况B：B端账户余额不足 (如 3,000 积分)。系统扣除所有 3,000 积分，可用积分 变为 0，同时账户产生 -7,000 的**“积分欠款”** (或 -70.00 的**“应付负额”**)。
    * **未来收益自动抵扣（核心）：**
        * 该B端未来产生的任何新订单，在变为可结算时，新获得的收益（如 5,000 积分）将优先用于填补“欠款”。
        * （-7,000 + 5,000 = -2,000）。B端的可用积分 依然为 0，直到欠款补清。
    * **法务条款：** 此操作的合法性，必须依赖 2.1 中签署的《合作协议》。

### 4.5 场景：供应商侧取消

  * **问题：** C端已付款，但供应商因超售(Overbooking)等原因取消订单。

  * **设计：**
    * **平台需为C端提供“全额退款”或“协助预订同级酒店”。
    * **分账：** 该订单 B_Profit 计为 0。服务未完成，B端无佣金。
    * **平台应向供应商追索因安抚C端而产生的额外成本（如差价）。

### 4.6 场景：B端欺诈/刷单

  * **问题：** B端利用平台规则漏洞，恶意刷单（如预订后恶意客诉）以套取积分或刷高流水。

  * **设计：**
    * **风控规则：** 监测异常行为（如：B端的高客诉率、高取消率、B端自购、C端手机号高度集中等）。
    * **处理：** 触发风控的B端，其账户（积分/现金）被立即冻结，禁止兑换和提现。所有未结算订单自动转为争议中，等待人工审核。

## 5\. 非功能性需求

### 5.1 安全性 (Security)

  * **【P0】** B端和C端的身份证号、银行卡号等敏感信息，必须加密存储。
  * **【P0】** 所有财务相关的API（支付、打款）调用，必须在内网环境，IP加白名单，并对请求参数严格签名。
  * **【P0】** 提现操作必须有B端的二次验证（如短信验证码）。

### 5.2 性能 (Performance)

  * **【P1】** 每日自动对账（支付渠道流水 vs 订单流水；应付账本 vs 打款流水）应在凌晨低峰期执行，不影响日间交易。

### 5.3 风控 (Risk Control)

  * **【P1】** 建立防刷单规则：监测B端短时订单暴增、高取消率、高客诉率等异常行为。
  * **【P1】** 触发风控规则的B端，其订单自动进入`争议中`，冻结结算，转人工审核。

## 6\. 数据对账

  * **【P0】** 每日自动对账：`支付渠道（微信/支付宝）收款流水` **VS** `平台订单收款流水`。
  * **【P0】** 每月自动对账：
      * `B端提现打款总流水` **VS** `B端虚拟账本扣减总额`。
      * `C端开票总额` **VS** (`供应商开票总额` + `B端开票总额(含灵工平台)` + `平台净利润`)。
