# 审核资格 PRD

## 1. 文档信息
- **文档版本**：v1.0（2025-11-11）

## 2. 背景与目标
平台系统 AIGOHOTEL 的管理员需集中处理大B/SaaS、MCP 以及小B（推广联盟）用户的资质审核。

## 3. 术语说明
| 术语 | 说明 |
| --- | --- |
| 大B | SaaS/MCP 业务模式客户，可设置加价率 |
| 小B | 推广联盟用户，需挂载到具有推广联盟权限的大B（默认 AIGO 大B） |
| AIGO 大B | 平台自有大B账户，具备推广联盟管理权限 |
| 风控等级 | L0-L4，数字越低权限越高 |
| 申请状态 | pending/approved/rejected |
| 用户信息类型 | 旅行代理、网络博主、旅游类相关应用 |
| 认证方式 | 个人认证、企业认证 |
| 业务模式 | MCP、SaaS、推广联盟 |

## 4. 用户与角色
| 角色 | 权限目标 |
| --- | --- |
| 平台管理员（role=admin） | 查看与处理全部大B/小B申请，配置挂载关系，设定风控等级 |

## 5. 范围
1. 资格审核主页（列表、筛选、搜索、分页、导出）。
2. 资格审核详情页（分类信息、证照预览、审核操作、备注）。
3. 审核动作（通过/驳回，风控等级、驳回原因、内部备注）。
4. 审核通过时的小B挂载规则执行。
5. 审核日志/状态变更记录。
6. 审核结果消息通知的渠道实现（短信、邮件）。

## 6. 业务流程
### 6.1 用户分类与业务模式映射
| 用户信息类型 | 认证方式 | 可选业务模式 | 大B/小B判定 | 挂载关系 |
|------------|---------|------------|-----------|---------|
| 旅行代理 | 个人认证 | 推广联盟 | 小B | 挂载在平台大B下 |
| 旅行代理 | 企业认证 | SaaS / 推广联盟 | 大B（SaaS）或 小B（推广联盟） | 推广联盟时挂载在平台大B下 |
| 网络博主 | 个人认证 | SaaS | 大B | 直接由管理员管理 |
| 网络博主 | 企业认证 | SaaS | 大B | 直接由管理员管理 |
| 旅游类相关应用 | 个人认证 | MCP / SaaS / 推广联盟 | 大B（MCP/SaaS）或 小B（推广联盟） | 推广联盟时挂载在平台大B下 |
| 旅游类相关应用 | 企业认证 | MCP / SaaS / 推广联盟 | 大B（MCP/SaaS）或 小B（推广联盟） | 推广联盟时挂载在平台大B下 |

### 6.2 大B审核流程
1. 用户选择用户信息类型和认证方式，提交申请（选择 SaaS/MCP，填认证资料）。
2. Admin 在资格审核列表查看 `pending` 申请。
3. 进入详情核对身份信息与业务资料。
4. 按结果选择"通过"或"驳回"：
   - **通过**：指定风控等级（默认 L4）。系统自动授予大B权限。
   - **驳回**：填写驳回原因，返回申请状态 `rejected`。
5. 系统记录审核时间、操作人、备注。

### 6.3 小B审核流程（推广联盟）
1. 用户选择推广联盟业务模式并提交申请。
2. Admin 在列表查看 `pending` 小B申请。
3. 详情页确认资料并选择挂载目标大B（默认 AIGO 大B）。
4. 审核通过后：
   - 设置 `parent_partner_id`。
   - `managed_by`=`bigb`，`smallb_status`=`active`。

### 6.4 流程图
```
用户提交 → （待审核）→ 管理员核查 → [通过/驳回]
通过 → 设置权限/挂载 → 更新状态 → 通知用户
驳回 → 记录原因 → 更新状态 → 通知用户
```

## 7. 功能需求
### 7.1 列表页（AdminReviewList）
| 需求 | 描述 | 老版本支持 | 
| --- | --- | --- | --- |
| R1 搜索 | 支持按申请人、申请编号、邮箱、手机号模糊搜索；默认按提交时间倒序 | ✅ |
| R2 筛选 | 状态（全部/待审核/已通过/已驳回）、业务模式（MCP/SaaS/推广联盟）、用户信息类型（旅行代理/网络博主/旅游类相关应用）、认证方式（个人/企业）；支持组合筛选并记忆上次筛选条件 | ✅ |
| R3 列表信息 | 申请编号、申请人、邮箱、电话号码、用户信息类型、认证方式、业务模式、B端类型（大B/小B，依据业务模式）、挂载大B（仅小B展示）、权限等级（L0-L4，缺省为“-”）、提交时间、审核时间、状态、操作 | ✅ |
| R4 分页 | 每页 10 条，可跳页，保留筛选条件与排序 | ✅ | 保持 |
| R5 导出 | 导出当前筛选结果 CSV | ☑️ 按钮存在无实现 |
| R6 待审核角标 | 左侧菜单显示 pending 数 | ✅ | 

[列表字段来源说明](./用户分类与业务模式逻辑.md#%E5%AE%A2%E6%88%B7%E6%8E%92%E7%BA%A7)（结合业务映射）：
- **B端类型**：根据业务模式推断，`MCP/SaaS` → 大B，`推广联盟` → 小B。
- **挂载大B**：当用户为小B时展示，从 [系统架构图](./系统架构图.md#%E4%B8%89%E5%B1%82%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%A7%8B%E6%A6%82%E8%A7%88) 中“大B/小B挂载关系”获取默认值（AIGO 大B）与可选项。
- **权限等级**：与风控等级一致，参考 [用户分类与业务模式逻辑](./用户分类与业务模式逻辑.md#%E7%8A%B6%E6%80%81%E6%B5%81%E8%BD%AC) 中审批结果设置。

### 7.2 详情页（AdminReviewDetail）
| 需求 | 描述 | 老版本支持 |
| --- | --- | --- | --- |
| D1 基本信息 | 申请编号、用户信息类型、认证方式、业务模式、B端类型（大B/小B）、挂载大B（仅小B）、提交时间、审核时间、状态、权限等级 | ✅
| D2 动态表单 | 按用户信息类型 × 认证方式 × 业务模式展示对应资料卡片：个人认证（身份证/联系方式/结算账户/业务证明），企业认证（企业主体/法人/联系人/对公账户/业务证明）；根据业务模式附加 SaaS/MCP/推广联盟特定字段（加价权限、GitHub 账号、推广场景等） | ✅ 
| D3 证件预览 | 图片放大、下载 | ✅
| D4 审核操作 | 对话框选择通过/驳回、风控等级/驳回原因、内部备注；推广联盟（小B）必填挂载大B；通过后写入权限等级、parent_partner_id，驳回写入 rejectionReason | ✅ | 对齐字段名称，并增加“挂载大B”选择（仅小B）|
| D5 审核记录 | 展示历史操作（操作人、时间、结论、备注），支持展示关键字段变更（权限等级、挂载大B） |
| D6 附件与数据校验 | 图片类字段支持预览+下载；所有链接字段支持点击打开；显示未通过校验的字段提示 | ✅ |

[详情页模块与资料卡片映射说明](./用户分类与业务模式逻辑.md#%E8%AE%A4%E8%AF%81%E8%A1%A8%E5%8D%95%E8%AF%A6%E7%BB%86%E5%AD%97%E6%AE%B5)：
- **个人认证**：展示“身份信息”“联系方式”“结算账户”“业务信息”四类卡片，对应旅行代理/网络博主/旅游类应用的个人认证表单字段。
- **企业认证**：展示“企业主体信息”“法人信息”“联系人信息”“对公账户”“业务信息”卡片；根据业务模式附加 SaaS/MCP/推广联盟差异字段（如加价权限、平台数据截图、推广场景）。
- **小B审核补充**：当业务模式为推广联盟时，详情页需额外显示挂载逻辑与佣金说明，可引用 [系统架构图](./系统架构图.md#1-2-%E5%AE%8C%E6%95%B4%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B%E6%9E%B6%E6%9E%84) 中的“小B统一挂载 AIGO 大B”流程。

### 7.3 审核动作
- **通过**：
  - 必填：风控等级（默认 L4，可选 L0-L4）。
  - 小B：必选挂载大B（下拉，默认 AIGO 大B）。
  - 系统更新：
    - `application_status=approved`
    - 写入 `reviewed_at`、`reviewed_by`、`permission_level`
    - 对应 partner 表字段更新（加价权限 / parent_partner_id 等）。
- **驳回**：
  - 必填：驳回原因（至少 10 字）。
  - 可选：内部备注（仅内部可见）。
  - 系统更新状态，并记录驳回信息。
- **操作日志**：每次操作写入 `review_logs`（操作人、时间、操作类型、摘要）。

### 7.4 通知
- 通过：触发站内信 + 邮件（后端队列实现）。
- 驳回：同上，邮件包含驳回原因。
- 此处仅定义需求，技术实现列入消息平台。

