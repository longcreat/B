# 订单管理 PRD

> 关联文档：[`系统架构图`](./系统架构图.md)

## 1. 订单列表管理

- 查看权限
  - 管理员：查看全平台所有订单
  - 大B客户：查看自身订单 + 挂载在自己名下的小B订单
  - 小B客户：仅查看自己生成的订单
- 列表字段
  - **订单基本信息**：订单号（固定左侧）、订单状态徽章、结算状态徽章
  - **酒店与入住信息**：酒店名称、房型、入住/离店日期、入住人姓名、入住人数（区分成人、小孩，例如2成人 1小孩）
  - **商户信息**：商户名称（小B订单下方显示大B名称）、业务模式、用户信息类型徽章、认证方式、商户电话、商户邮箱
  - **金额汇总**：订单总金额、订单总优惠金额、订单实付总金额、订单总退款金额（无数据时显示"-"）
  - **操作**：固定右侧的操作按钮组（查看详情、免费取消、部分退款等）
- 备注：每晚价格明细在订单详情中展示

## 2. 订单搜索与筛选

- 搜索条件：订单号、酒店名称、商户名称、客户姓名、入住人姓名
- 筛选条件
  - 订单状态：待支付/待确认/已确认/待入住/已完成/可结算/已取消(免费)/已取消(付费)/未入住/售后中/全部
  - 结算状态：待结算/可结算/处理中/已结算/全部
  - 用户信息类型：旅行代理/网络博主/旅游类相关应用/全部
  - 认证方式：个人认证/企业认证/全部
  - 酒店名称、商户名称/邮箱：文本输入筛选
  - 创建时间范围、入住日期范围：开始与结束日期
  - 金额区间：订单金额范围、实际金额范围
- 分页：每页10条，支持导出当前筛选结果

## 3. 订单详情

- 订单基本信息：订单号、订单状态、结算状态、创建时间、确认时间、完成时间
- 酒店信息：名称、地址、联系方式
- 入住信息：入住/离店日期、入住人姓名（无则显示客户姓名）、入住人数（区分成人、小孩，例如2成人 1小孩）、房间类型、房间数量
- **价格与利润Tab页**（重构）
  - **加价率信息**（顶部卡片）
    - 平台加价率：P0→P1 的加价率百分比
    - 大B加价率：P1→P2 的加价率百分比（SaaS模式）
    - 小B佣金比例：P2的佣金比例百分比（推广联盟模式）
      - **佣金比例限制规则**：为防止大B亏损，佣金比例必须满足：**佣金比例 ≤ 大B加价率 / (1 + 大B加价率)**
      - 例如：大B加价率为10%时，小B佣金比例上限为 10% / 110% ≈ 9.09%
  - **按晚价格明细表格**
    - **表格列**：日期、P0、P1、P2、优惠、实付、退款、平台利润、大B利润、小B佣金（推广联盟模式时显示）、状态、操作
    - **每晚状态**：正常/已取消/已退款/部分退款
    - **操作列**：针对每晚的"退款"按钮（仅状态为正常/部分退款时显示，订单状态为已完成/可结算）
  - **订单汇总信息**（表格下方卡片）
    - 价格汇总：总底价（P0）、总分销价（P1）、总订单金额（P2）
    - 优惠与实付：总优惠金额、优惠出资比例（平台/大B）、实付总金额、总退款金额、最终实付
    - 利润与佣金：总平台利润、总大B利润、总小B佣金（仅推广联盟）
    - 晚数统计：有效晚数/总晚数（有效晚数 = 未取消且未全额退款的晚数）
  - **退款/取消记录**（独立区域）
    - 列表展示：操作时间、操作类型（取消/退款）、总金额、原因、凭证（可预览）、操作人
    - 每条记录可展开查看：影响的日期及每晚退款金额明细
- 商户信息：商户名称、用户信息类型、认证方式、商户电话、邮箱、商户ID、业务模式
  - 管理大B信息（仅小B）：大B名称、用户信息类型、业务模式（SaaS/MCP）
- 客户信息：下单人姓名与联系方式（提醒：入住人与客户可能不同）
- 状态时间轴：展示状态流转历史
- 风控审核信息：审核状态、审核时间
- 结算信息：结算状态、结算时间、结算金额

## 4. 订单操作

### 4.1 免费取消（按晚粒度）
- **适用状态**：已确认/待入住
- **操作粒度**：支持按晚选择取消，可选择取消全部或部分晚数
- **取消原因**：酒店同意、免费取消期内、平台承担费用
- **取消逻辑**
  - 选择需要取消的日期（支持多选）
  - 系统自动计算取消金额（基于选中日期的每晚价格）
  - 确认后更新订单状态和退款金额
- **结果**
  - 全部取消：状态改为"已取消(免费)"
  - 部分取消：保持原状态，生成退款记录，更新订单金额和晚数

### 4.2 部分退款（按晚粒度，每晚独立设置）
- **适用状态**：已完成/可结算
- **操作粒度**：选择一个或多个日期进行退款，**每晚可独立设置退款金额或比例**
- **退款方式（每晚独立）**
  - **固定金额模式**：为每一晚单独输入固定退款金额（单晚上限为该晚实付金额）
  - **比例模式**：为每一晚单独输入退款比例（0-100%）
  - **混合模式**：不同晚可以使用不同的退款方式（部分晚用固定金额，部分晚用比例）
- **必填信息**
  - 退款日期（多选）
  - 每晚的退款方式与对应参数（固定金额/比例，每晚独立设置）
  - 退款原因（文本说明）
  - 退款凭证（图片上传）
- **退款计算规则**
  - 设选中日期集合为 D，某日晚 i 的实付金额为 Ai，该晚设置的退款金额为 Ri（固定金额）或退款比例为 Pi（百分比）
  - 固定金额模式：单晚退款 = min(Ri, Ai)
  - 比例模式：单晚退款 = Ai × (Pi / 100)
  - 总退款金额 = Σ 单晚退款（i∈D）
  - 每晚退款金额独立计算，互不影响
- **UI交互**
  - 选择日期后，展示每晚的详细信息（日期、实付金额）
  - 每晚一行，包含：日期、实付金额、退款方式选择（固定金额/比例）、退款金额/比例输入框、预估退款金额
  - 实时计算并显示总退款金额
  - 支持快速操作："全部按固定金额"、"全部按比例"批量设置
- **结果**
  - 生成退款记录（包含退款时间、总金额、原因、凭证、每晚明细：日期+退款金额）
  - 更新每晚的退款金额和状态（normal → partial_refunded 或 refunded）
  - 更新订单总退款金额与订单实付金额（实付金额 = 原实付金额 - 总退款金额）
  - 如全部晚均全额退款，订单状态可变更为"已取消(付费)"

### 4.3 状态查看
- 随时查看完整状态流转
- 查看所有退款/取消记录（包含按晚明细）

## 5. 订单权限

- 管理员：查看/管理所有订单
- 大B客户：查看自身及挂载小B订单
- 小B客户：仅查看自身订单
- 操作权限依赖订单状态与用户类型
