# 功能权限管理系统

## 概述

功能权限管理系统允许管理员在后台灵活配置各个功能模块的访问权限，支持多种权限规则和白名单/黑名单机制。

## 主要特性

### 1. 多种权限规则

系统支持以下权限规则：

- **所有人（all）**: 所有用户都可以访问
- **仅大B（bigb-only）**: 仅大B用户可访问
- **仅小B（smallb-only）**: 仅小B用户可访问
- **仅SaaS业务（saas-only）**: 仅SaaS业务模式用户可访问
- **仅MCP业务（mcp-only）**: 仅MCP业务模式用户可访问
- **仅分销业务（affiliate-only）**: 仅分销业务模式用户可访问
- **白名单模式（whitelist）**: 仅白名单中的用户可访问

### 2. 白名单/黑名单机制

- **白名单**: 在白名单模式下，只有指定的Partner ID可以访问功能
- **黑名单**: 无论其他条件如何，黑名单中的用户都无法访问功能

### 3. Beta测试标记

可以将功能标记为Beta测试，用户看到的提示会显示"该功能正在内测中"

### 4. 动态菜单控制

根据权限配置自动显示/隐藏菜单项，用户只能看到有权限访问的功能

## 使用方法

### 管理员配置权限

1. 登录管理后台
2. 进入"功能权限管理"页面
3. 搜索或筛选要配置的功能
4. 点击"配置权限"按钮
5. 设置权限规则、白名单、黑名单等
6. 保存配置

### 开发者集成权限检查

#### 1. 在菜单中集成（已自动集成）

BigBLayout 和 SmallBLayout 已经自动集成了权限检查，会根据配置动态显示菜单。

#### 2. 在页面中使用 FeatureProtected 组件

```tsx
import { FeatureProtected } from './components/FeatureProtected';

// 包装需要权限保护的页面
<FeatureProtected 
  featureCode="brand-config" 
  currentPartner={currentPartner} 
  userType="bigb"
>
  <YourFeatureComponent />
</FeatureProtected>
```

#### 3. 使用 useFeaturePermission Hook

```tsx
import { useFeaturePermission } from './components/FeatureProtected';

function MyComponent({ currentPartner, userType }) {
  const { hasPermission, reason } = useFeaturePermission(
    'brand-config',
    currentPartner,
    userType
  );

  if (!hasPermission) {
    return <div>无权访问: {reason}</div>;
  }

  return <div>功能内容...</div>;
}
```

#### 4. 直接使用权限检查函数

```tsx
import { hasFeaturePermission, getFeatureDisabledReason } from './utils/featurePermissionUtils';

const hasAccess = hasFeaturePermission('brand-config', partner, 'bigb');
const reason = getFeatureDisabledReason('brand-config', partner, 'bigb');
```

## 功能代码清单

当前系统支持的功能代码：

| 功能代码 | 功能名称 | 分类 | 默认规则 |
|---------|---------|------|---------|
| `brand-config` | 品牌配置 | 业务功能 | 白名单模式 |
| `pricing-strategy` | 加价策略 | 业务功能 | 仅大B |
| `smallb-management` | 小B客户管理 | 业务功能 | 仅大B |
| `mcp-config` | MCP配置 | 系统功能 | 仅MCP业务 |
| `mcp-monitoring` | 用量监控 | 系统功能 | 仅MCP业务 |
| `affiliate-link` | 推广链接 | 业务功能 | 仅分销业务 |
| `data-reports` | 数据报表 | 业务功能 | 所有人 |
| `withdrawal` | 提现管理 | 财务功能 | 所有人 |
| `order-management` | 订单管理 | 业务功能 | 所有人 |

## 配置示例

### 示例1: 品牌配置功能内测

```typescript
{
  code: 'brand-config',
  enabled: true,
  rule: 'whitelist',
  whitelistPartnerIds: ['P001', 'P002'],
  requiredBusinessModels: ['saas'],
  requiredUserTypes: ['bigb'],
  betaTest: true,
}
```

**效果**: 只有P001和P002两个SaaS业务的大B用户可以使用品牌配置，其他用户会看到"该功能正在内测中，暂未对您开放"的提示。

### 示例2: MCP配置限制

```typescript
{
  code: 'mcp-config',
  enabled: true,
  rule: 'mcp-only',
  requiredBusinessModels: ['mcp'],
  requiredUserTypes: ['bigb'],
}
```

**效果**: 只有MCP业务模式的大B用户可以访问MCP配置功能。

### 示例3: 临时禁用某些用户

```typescript
{
  code: 'pricing-strategy',
  enabled: true,
  rule: 'bigb-only',
  blacklistPartnerIds: ['P005', 'P006'],
}
```

**效果**: 所有大B用户都可以使用加价策略，但P005和P006除外（即使他们是大B用户）。

## 文件结构

```
B/src/
├── data/
│   └── mockFeaturePermissions.ts      # 功能权限配置数据
├── utils/
│   └── featurePermissionUtils.ts      # 权限检查工具函数
├── components/
│   ├── FeaturePermissionManagement.tsx # 管理后台权限配置页面
│   ├── FeatureProtected.tsx           # 权限保护包装组件
│   ├── BigBLayout.tsx                 # 大B布局（已集成权限检查）
│   └── SmallBLayout.tsx               # 小B布局（已集成权限检查）
```

## 扩展功能

### 添加新功能权限

1. 在 `mockFeaturePermissions.ts` 中的 `FeatureCode` 类型添加新功能代码
2. 在 `mockFeaturePermissions` 数组中添加新的权限配置
3. 在相关的菜单和路由中添加该功能
4. 使用 `FeatureProtected` 组件或权限检查函数保护该功能

### 对接后端API

当前使用Mock数据，实际部署时需要：

1. 创建后端API接口
2. 替换 `getMockFeaturePermissions` 为真实的API调用
3. 替换 `updateFeaturePermission` 为真实的更新API
4. 添加权限配置的增删改查接口

## 注意事项

1. **管理员权限**: 管理员（userType='admin'）拥有所有功能的访问权限，不受任何限制
2. **白名单优先级**: 在白名单模式下，必须在白名单中才能访问，即使满足其他所有条件
3. **黑名单优先级**: 黑名单具有最高优先级，黑名单中的用户无论如何都无法访问
4. **功能总开关**: `enabled` 字段是功能的总开关，关闭后所有用户都无法访问
5. **多条件组合**: `requiredBusinessModels` 和 `requiredUserTypes` 可以组合使用，所有条件必须同时满足

## 测试建议

1. 测试不同权限规则下的菜单显示
2. 测试白名单/黑名单机制
3. 测试功能启用/禁用开关
4. 测试Beta测试标记的提示信息
5. 测试管理员的全权限访问
6. 测试无权限时的友好提示页面

